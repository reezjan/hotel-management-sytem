import{q as L,u as _,b as B,r as M,c as Q,l as h,d as f,j as e,F as H,e as o,f as l,g as d,h as c,I as k,B as b}from"./index-CuDmVYun.js";import{D as V}from"./dashboard-layout-RBv1DXX2.js";import{D as J}from"./data-table-B69p7Klv.js";import{D as R,a as U,b as $,c as G}from"./dialog-CYNkLpdV.js";import{T as Z}from"./textarea-CpuNoaOI.js";import{S as T,a as v,b as D,c as S,d as m}from"./select-7c0Tajxe.js";import{u as w}from"./use-realtime-query-CGmARpos.js";import"./users-DXv82DeH.js";import"./circle-alert-CPwmOhkC.js";import"./badge-DMaRL5Qw.js";import"./index-D12ZMnos.js";import"./index-dzpsPapz.js";import"./use-websocket-CCUHb1Px.js";function de(){const{user:r}=L(),{toast:i}=_(),g=B(),[C,u]=M.useState(!1),n=Q({defaultValues:{title:"",description:"",assignedTo:"",priority:"medium",dueDateTime:""}}),{data:A=[],isLoading:I}=h({queryKey:["/api/hotels/current/tasks"],refetchInterval:3e3}),{data:x=[]}=h({queryKey:["/api/hotels/current/users"],refetchInterval:3e3}),{data:F=[]}=h({queryKey:["/api/attendance/daily"],refetchInterval:3e3});w({queryKey:"/api/hotels/current/tasks",events:["task:created","task:updated","task:deleted"]}),w({queryKey:"/api/attendance/daily",events:["attendance:updated"]});const y=x.filter(t=>{var s;return((s=t.role)==null?void 0:s.name)==="housekeeping_staff"}),q=y.filter(t=>F.some(s=>s.userId===t.id&&s.status==="active")),O=A.filter(t=>y.some(s=>s.id===t.assignedTo)),p=f({mutationFn:async t=>{const s=await fetch("/api/hotels/current/tasks",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(t)});if(!s.ok){const a=await s.json();throw new Error(a.message||"Failed to create task")}return s.json()},onSuccess:()=>{g.invalidateQueries({queryKey:["/api/hotels/current/tasks"]}),u(!1),n.reset(),i({title:"Task assigned successfully"})},onError:t=>{i({title:t.message,variant:"destructive"})}}),j=f({mutationFn:async({taskId:t,status:s})=>{const a=await fetch(`/api/hotels/current/tasks/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({status:s})});if(!a.ok)throw new Error("Failed to update task");return a.json()},onSuccess:()=>{g.invalidateQueries({queryKey:["/api/hotels/current/tasks"]}),i({title:"Task status updated"})},onError:t=>{i({title:t.message,variant:"destructive"})}}),P=t=>{if(!t.title||!t.assignedTo){i({title:"Please fill in all required fields",variant:"destructive"});return}const{dueDateTime:s,...a}=t;p.mutate({...a,hotelId:r==null?void 0:r.hotelId,createdBy:r==null?void 0:r.id,dueDate:s||null})},K=[{key:"title",label:"Task",sortable:!0},{key:"assignedTo",label:"Assigned To",render:(t,s)=>{const a=x.find(E=>E.id===s.assignedTo);return(a==null?void 0:a.username)||"Unassigned"}},{key:"status",label:"Status",sortable:!0,render:t=>{const s={pending:"bg-gray-100 text-gray-800",in_progress:"bg-blue-100 text-blue-800",pending_review:"bg-yellow-100 text-yellow-800",completed:"bg-green-100 text-green-800",cancelled:"bg-red-100 text-red-800"};return e.jsx("span",{className:`px-2 py-1 rounded-md text-xs font-medium ${s[t]||"bg-gray-100 text-gray-800"}`,children:t==="pending_review"?"Pending Approval":t})}},{key:"priority",label:"Priority",sortable:!0},{key:"createdAt",label:"Created",sortable:!0,render:t=>new Date(t).toLocaleDateString("en-GB",{timeZone:"Asia/Kathmandu"})}],N=[{label:"Approve",action:t=>j.mutate({taskId:t.id,status:"completed"}),show:t=>t.status==="pending_review"},{label:"Mark Complete",action:t=>j.mutate({taskId:t.id,status:"completed"}),show:t=>t.status==="in_progress"}];return e.jsxs(V,{title:"Task Assignment",children:[e.jsx(J,{title:"Housekeeping Tasks",data:O,columns:K,actions:N,onAdd:()=>u(!0),addButtonLabel:"Assign New Task",searchPlaceholder:"Search tasks...",isLoading:I}),e.jsx(R,{open:C,onOpenChange:u,children:e.jsxs(U,{children:[e.jsx($,{children:e.jsx(G,{children:"Assign New Task"})}),e.jsx(H,{...n,children:e.jsxs("form",{onSubmit:n.handleSubmit(P),className:"space-y-4",children:[e.jsx(o,{control:n.control,name:"title",render:({field:t})=>e.jsxs(l,{children:[e.jsx(d,{children:"Task Title"}),e.jsx(c,{children:e.jsx(k,{...t,"data-testid":"input-title"})})]})}),e.jsx(o,{control:n.control,name:"description",render:({field:t})=>e.jsxs(l,{children:[e.jsx(d,{children:"Description"}),e.jsx(c,{children:e.jsx(Z,{...t,"data-testid":"textarea-description"})})]})}),e.jsx(o,{control:n.control,name:"assignedTo",render:({field:t})=>e.jsxs(l,{children:[e.jsx(d,{children:"Assign To (Only On-Duty Staff)"}),e.jsxs(T,{onValueChange:t.onChange,value:t.value,children:[e.jsx(c,{children:e.jsx(v,{"data-testid":"select-assignedto",children:e.jsx(D,{placeholder:"Select staff member"})})}),e.jsx(S,{children:q.map(s=>e.jsxs(m,{value:s.id,children:[s.username," (Online)"]},s.id))})]})]})}),e.jsx(o,{control:n.control,name:"priority",render:({field:t})=>e.jsxs(l,{children:[e.jsx(d,{children:"Priority"}),e.jsxs(T,{onValueChange:t.onChange,value:t.value,children:[e.jsx(c,{children:e.jsx(v,{"data-testid":"select-priority",children:e.jsx(D,{})})}),e.jsxs(S,{children:[e.jsx(m,{value:"low",children:"Low"}),e.jsx(m,{value:"medium",children:"Medium"}),e.jsx(m,{value:"high",children:"High"})]})]})]})}),e.jsx(o,{control:n.control,name:"dueDateTime",render:({field:t})=>e.jsxs(l,{children:[e.jsx(d,{children:"Due Date (Optional)"}),e.jsx(c,{children:e.jsx(k,{...t,type:"datetime-local","data-testid":"input-duedate"})})]})}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(b,{type:"button",variant:"outline",onClick:()=>u(!1),"data-testid":"button-cancel",children:"Cancel"}),e.jsx(b,{type:"submit",disabled:p.isPending,"data-testid":"button-submit",children:p.isPending?"Assigning...":"Assign Task"})]})]})})]})})]})}export{de as default};
