import{q as ce,u as oe,b as ue,v as me,r as m,l as k,d as f,j as e,C as S,m as L,n as z,a as T,a2 as B,B as i,I as xe,p as q,k as v}from"./index-CuDmVYun.js";import{D as he,p as pe,a4 as R,M as je,a as I,a5 as U}from"./dashboard-layout-RBv1DXX2.js";import{S as H}from"./stats-card-CKM6aMdl.js";import{B as g}from"./badge-DMaRL5Qw.js";import{D as fe,a as ve,b as ge,c as ye}from"./dialog-CYNkLpdV.js";import{T as Ne,a as be,b as V,c as W}from"./tabs-CX8s-N0D.js";import"./users-DXv82DeH.js";import"./circle-alert-CPwmOhkC.js";import"./index-D12ZMnos.js";function Me(){const{user:d}=ce(),{toast:c}=oe(),x=ue(),{confirm:G}=me(),[n,J]=m.useState(null),[l,o]=m.useState([]),[D,X]=m.useState(""),[Y,E]=m.useState(!1),[Z,y]=m.useState(null),[u,h]=m.useState({}),{data:p=[]}=k({queryKey:["/api/hotels/current/restaurant-tables"],refetchInterval:3e3}),{data:_=[]}=k({queryKey:["/api/hotels/current/menu-items"],refetchInterval:3e3}),{data:M=[]}=k({queryKey:["/api/hotels/current/kot-orders"],refetchInterval:3e3}),N=f({mutationFn:async s=>{await v("POST","/api/kot-orders",s)},onSuccess:()=>{x.invalidateQueries({queryKey:["/api/hotels/current/kot-orders"]}),c({title:"Order placed successfully"}),o([])}}),b=f({mutationFn:async({orderId:s,status:t})=>{await v("PUT",`/api/kot-orders/${s}`,{status:t})},onSuccess:()=>{x.invalidateQueries({queryKey:["/api/hotels/current/kot-orders"]}),c({title:"Order updated successfully"})}}),ee=f({mutationFn:async s=>{await v("DELETE",`/api/kot-orders/${s}`)},onSuccess:()=>{x.invalidateQueries({queryKey:["/api/hotels/current/kot-orders"]}),c({title:"Order deleted successfully"})}}),C=f({mutationFn:async({itemId:s,qty:t})=>{await v("PUT",`/api/kot-items/${s}`,{qty:t})},onSuccess:()=>{x.invalidateQueries({queryKey:["/api/hotels/current/kot-orders"]}),c({title:"Item quantity updated successfully"})}}),se=_.filter(s=>s.name.toLowerCase().includes(D.toLowerCase())&&s.active),w=M.filter(s=>s.createdBy===(d==null?void 0:d.id)).filter(s=>["open","preparing"].includes(s.status)),P=s=>M.filter(t=>t.tableId===s&&["open","preparing","ready"].includes(t.status)),te=s=>{const t=l.find(a=>a.id===s.id);o(t?a=>a.map(r=>r.id===s.id?{...r,quantity:r.quantity+1}:r):a=>[...a,{...s,quantity:1}])},$=s=>{o(t=>t.filter(a=>a.id!==s))},A=(s,t)=>{if(t<=0){$(s);return}o(a=>a.map(r=>r.id===s?{...r,quantity:t}:r))},ae=()=>l.reduce((s,t)=>s+t.price*t.quantity,0),Q=s=>{J(s),o([]),E(!0)},re=()=>{if(!n||l.length===0){c({title:"Error",description:"Please add items to order",variant:"destructive"});return}N.mutate({hotelId:d==null?void 0:d.hotelId,tableId:n.id,createdBy:d==null?void 0:d.id,status:"open",items:l.map(s=>({menuItemId:s.id,description:s.name,qty:s.quantity,unit:"piece"}))})},F=(s,t)=>{b.mutate({orderId:s.id,status:t})},ie=async s=>{await G({title:"Delete Order",description:"Are you sure you want to delete this order? This action cannot be undone.",confirmText:"Delete",cancelText:"Cancel",variant:"destructive",onConfirm:()=>{ee.mutate(s)}})},ne=s=>{var a;y(s.id);const t={};(a=s.items)==null||a.forEach(r=>{t[r.id]=r.qty}),h(t)},de=()=>{y(null),h({})},le=async s=>{try{const t=s.items.filter(a=>u[a.id]&&u[a.id]!==a.qty).map(a=>C.mutateAsync({itemId:a.id,qty:u[a.id]}));await Promise.all(t),y(null),h({})}catch{c({title:"Error",description:"Failed to update items",variant:"destructive"})}},K=(s,t)=>{h(a=>({...a,[s]:Math.max(1,t)}))},O=n?P(n.id):[];return e.jsx(he,{title:"Waiter Dashboard",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(H,{title:"Active Orders",value:w.length,icon:e.jsx(pe,{}),iconColor:"text-blue-500"}),e.jsx(H,{title:"Available Tables",value:p.length,icon:e.jsx(R,{}),iconColor:"text-purple-500"})]}),e.jsxs(S,{children:[e.jsxs(L,{children:[e.jsx(z,{children:"Restaurant Layout"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Click on any table to view orders or add new items"})]}),e.jsx(T,{children:e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4",children:p.map((s,t)=>{const a=P(s.id).length;return e.jsx("div",{className:"p-4 border-2 rounded-lg cursor-pointer transition-colors hover:border-primary/50 hover:bg-accent/50",onClick:()=>Q(s),"data-testid":`table-${t}`,children:e.jsxs("div",{className:"text-center",children:[e.jsx(R,{className:"h-8 w-8 mx-auto mb-2 text-gray-600"}),e.jsx("h3",{className:"font-medium text-foreground",children:s.name}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[s.capacity," seats"]}),a>0?e.jsxs(g,{variant:"default",className:"mt-2",children:[a," ",a===1?"Order":"Orders"]}):e.jsx(g,{variant:"secondary",className:"mt-2",children:"Available"})]})},s.id)})})})]}),e.jsxs(S,{children:[e.jsx(L,{children:e.jsx(z,{children:"My Active Orders"})}),e.jsx(T,{children:e.jsx("div",{className:"space-y-3",children:w.length===0?e.jsx("p",{className:"text-center text-muted-foreground py-4","data-testid":"no-orders-message",children:"No active orders"}):w.map((s,t)=>{var a;return e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg","data-testid":`order-item-${t}`,children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx("h4",{className:"font-medium text-foreground",children:((a=p.find(r=>r.id===s.tableId))==null?void 0:a.name)||`Table ${t+1}`}),e.jsx(g,{className:B(s.status),variant:"secondary",children:s.status})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Order #",s.id.slice(0,8)," â€¢ ",new Date(s.createdAt).toLocaleTimeString()]})]}),e.jsxs("div",{className:"flex space-x-2",children:[s.status==="ready"&&e.jsx(i,{className:"h-11 min-h-11",onClick:()=>F(s,"served"),disabled:b.isPending,"data-testid":`button-mark-served-${t}`,children:"Mark as Served"}),e.jsx(i,{className:"h-11 min-h-11",variant:"outline",onClick:()=>{const r=p.find(j=>j.id===s.tableId);r&&Q(r)},"data-testid":`button-view-${t}`,children:"View Table"})]})]},s.id)})})})]}),e.jsx(fe,{open:Y,onOpenChange:E,children:e.jsxs(ve,{className:"max-w-5xl max-h-[85vh] overflow-hidden flex flex-col",children:[e.jsx(ge,{children:e.jsxs(ye,{children:[n==null?void 0:n.name," (",n==null?void 0:n.capacity," seats)"]})}),e.jsxs(Ne,{defaultValue:"menu",className:"flex-1 flex flex-col overflow-hidden",children:[e.jsxs(be,{className:"grid w-full grid-cols-2",children:[e.jsx(V,{value:"menu",children:"Menu & New Order"}),e.jsxs(V,{value:"orders",children:["Active Orders (",O.length,")"]})]}),e.jsx(W,{value:"menu",className:"flex-1 overflow-auto",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6 p-4",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Menu Items"}),e.jsxs("div",{className:"relative",children:[e.jsx(je,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(xe,{placeholder:"Search menu items...",value:D,onChange:s=>X(s.target.value),className:"pl-9","data-testid":"input-menu-search"})]}),e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:se.map((s,t)=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg","data-testid":`menu-item-${t}`,children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium text-foreground",children:s.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.description}),e.jsx("p",{className:"text-sm font-medium text-primary",children:q(s.price)})]}),e.jsx(i,{size:"icon",onClick:()=>te(s),"data-testid":`button-add-item-${t}`,children:e.jsx(I,{className:"h-5 w-5"})})]},s.id))})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Order Summary"}),e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:l.length===0?e.jsx("p",{className:"text-center text-muted-foreground py-4","data-testid":"empty-order-message",children:"No items added to order"}):l.map((s,t)=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg bg-card","data-testid":`order-item-${t}`,children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium text-foreground",children:s.name}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[q(s.price)," each"]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(i,{size:"icon",variant:"outline",onClick:()=>A(s.id,s.quantity-1),"data-testid":`button-decrease-${t}`,children:e.jsx(U,{className:"h-5 w-5"})}),e.jsx("span",{className:"w-10 text-center font-medium text-foreground",children:s.quantity}),e.jsx(i,{size:"icon",variant:"outline",onClick:()=>A(s.id,s.quantity+1),"data-testid":`button-increase-${t}`,children:e.jsx(I,{className:"h-5 w-5"})}),e.jsx(i,{variant:"destructive",size:"sm",onClick:()=>$(s.id),"data-testid":`button-remove-${t}`,children:"Remove"})]})]},s.id))}),l.length>0&&e.jsxs("div",{className:"border-t pt-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("span",{className:"text-lg font-semibold",children:"Total:"}),e.jsx("span",{className:"text-lg font-bold text-primary","data-testid":"order-total",children:q(ae())})]}),e.jsx(i,{className:"w-full",onClick:re,disabled:N.isPending,"data-testid":"button-place-order",children:N.isPending?"Placing Order...":"Place Order"})]})]})]})}),e.jsx(W,{value:"orders",className:"flex-1 overflow-auto p-4",children:e.jsx("div",{className:"space-y-4",children:O.length===0?e.jsx("p",{className:"text-center text-muted-foreground py-8",children:"No active orders for this table"}):O.map(s=>{const t=Z===s.id;return e.jsx(S,{children:e.jsxs(T,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{children:[e.jsxs("h4",{className:"font-medium",children:["Order #",s.id.slice(0,8)]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:new Date(s.createdAt).toLocaleString()})]}),e.jsx(g,{className:B(s.status),variant:"secondary",children:s.status})]}),s.items&&s.items.length>0&&e.jsx("div",{className:"mb-3 space-y-2",children:s.items.map((a,r)=>{var j;return e.jsxs("div",{className:"text-sm flex items-center justify-between p-2 rounded border bg-card",children:[e.jsx("span",{className:"flex-1",children:((j=a.menuItem)==null?void 0:j.name)||a.notes||"Unknown Item"}),t?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(i,{size:"icon",variant:"outline",className:"h-8 w-8",onClick:()=>K(a.id,(u[a.id]||a.qty)-1),"data-testid":`button-decrease-edit-${r}`,children:e.jsx(U,{className:"h-4 w-4"})}),e.jsx("span",{className:"w-12 text-center font-medium",children:u[a.id]||a.qty}),e.jsx(i,{size:"icon",variant:"outline",className:"h-8 w-8",onClick:()=>K(a.id,(u[a.id]||a.qty)+1),"data-testid":`button-increase-edit-${r}`,children:e.jsx(I,{className:"h-4 w-4"})})]}):e.jsxs("span",{className:"text-muted-foreground",children:["x",a.qty]})]},r)})}),e.jsx("div",{className:"flex space-x-2 mt-4",children:t?e.jsxs(e.Fragment,{children:[e.jsx(i,{variant:"outline",className:"flex-1",onClick:de,"data-testid":"button-cancel-edit",children:"Cancel"}),e.jsx(i,{className:"flex-1",onClick:()=>le(s),disabled:C.isPending,"data-testid":"button-save-edit",children:C.isPending?"Saving...":"Save Changes"})]}):e.jsxs(e.Fragment,{children:[s.status==="ready"&&e.jsx(i,{className:"flex-1",onClick:()=>F(s,"served"),disabled:b.isPending,"data-testid":"button-mark-served",children:"Mark as Served"}),e.jsx(i,{variant:"outline",className:"flex-1",onClick:()=>ne(s),"data-testid":"button-edit-order",children:"Edit Order"}),e.jsx(i,{variant:"destructive",className:"flex-1",onClick:()=>ie(s.id),"data-testid":"button-delete-order",children:"Delete Order"})]})})]})},s.id)})})})]})]})})]})})}export{Me as default};
