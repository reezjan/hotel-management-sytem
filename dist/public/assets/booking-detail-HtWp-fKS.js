import{aC as Q,q as V,u as $,b as U,r as z,l as S,c as G,d as J,j as e,au as W,B as x,C as u,m as h,n as j,a as p,p as i,F as X,e as g,f,g as b,h as N,I as F,i as y,z as l,t as Y,k as Z}from"./index-CuDmVYun.js";import{D as q,o as M,R as ee,i as te}from"./dashboard-layout-RBv1DXX2.js";import{B as se}from"./badge-DMaRL5Qw.js";import{T as ae}from"./textarea-CpuNoaOI.js";import{D as ne,a as re,b as de,c as ie}from"./dialog-CYNkLpdV.js";import{S as le,a as oe,b as ce,c as me,d as v}from"./select-7c0Tajxe.js";import{A as xe,D as ue,C as he}from"./users-DXv82DeH.js";import{f as d}from"./format-BOBWS5Wu.js";import"./circle-alert-CPwmOhkC.js";import"./index-D12ZMnos.js";import"./index-dzpsPapz.js";const je=l.object({amount:l.number().positive("Amount must be greater than 0"),paymentMethod:l.string().min(1,"Payment method is required"),notes:l.string().optional(),receiptNumber:l.string().optional()});function Se(){var T;const[,k]=Q("/dashboard/bookings/:id"),n=k==null?void 0:k.id,{user:P}=V(),{toast:R}=$(),A=U(),[I,o]=z.useState(!1),{data:s}=S({queryKey:["/api/hall-bookings",n],refetchInterval:3e3,enabled:!!n}),{data:c=[]}=S({queryKey:["/api/bookings",n,"payments"],refetchInterval:3e3,enabled:!!n}),{data:C}=S({queryKey:["/api/halls",s==null?void 0:s.hallId],refetchInterval:3e3,enabled:!!(s!=null&&s.hallId)}),r=G({resolver:Y(je),defaultValues:{amount:0,paymentMethod:"",notes:"",receiptNumber:""}}),w=J({mutationFn:async t=>{const a=c.reduce((K,H)=>K+Number(H.amount||0),0),B=Number(s==null?void 0:s.totalAmount)-a;if(t.amount>B)throw new Error(`Payment amount (${t.amount}) cannot exceed balance due (${B.toFixed(2)})`);await Z("POST",`/api/bookings/${n}/payments`,{...t,amount:t.amount.toString()})},onSuccess:()=>{A.invalidateQueries({queryKey:["/api/bookings",n,"payments"]}),A.invalidateQueries({queryKey:["/api/hall-bookings",n]}),R({title:"Payment recorded successfully"}),r.reset(),o(!1)},onError:t=>{R({title:"Failed to record payment",description:t.message,variant:"destructive"})}}),E=t=>{const a={quotation:"bg-blue-500",deposit_pending:"bg-orange-500",confirmed:"bg-green-500",in_progress:"bg-yellow-500",completed:"bg-gray-500",cancelled:"bg-red-500"};return e.jsx(se,{className:a[t]||"bg-gray-500",children:t.replace(/_/g," ").toUpperCase()})},O=t=>t?{cash:"Cash",pos:"POS/Card",fonepay:"Fonepay",bank_transfer:"Bank Transfer"}[t]||t:"Unknown",_=((T=P==null?void 0:P.role)==null?void 0:T.name)||"",L=["manager","owner","super_admin","front_desk","cashier","finance"].includes(_);if(!s)return e.jsx(q,{title:"Loading...",children:e.jsx("div",{className:"p-6",children:e.jsx("p",{className:"text-center text-muted-foreground",children:"Loading booking details..."})})});const D=c.reduce((t,a)=>t+Number(a.amount||0),0),m=Number(s.totalAmount)-D;return e.jsx(q,{title:"Booking Details",children:e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(W,{href:"/dashboard/hall-bookings",children:e.jsx(x,{variant:"outline",size:"icon","data-testid":"button-back",children:e.jsx(xe,{className:"h-4 h-4"})})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold","data-testid":"heading-booking-detail",children:"Booking Details"}),e.jsx("p",{className:"text-muted-foreground",children:"View and manage booking information"})]})]}),E(s.status)]}),e.jsxs("div",{className:"grid gap-6 md:grid-cols-2",children:[e.jsxs(u,{children:[e.jsx(h,{children:e.jsx(j,{children:"Booking Information"})}),e.jsxs(p,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Hall"}),e.jsx("p",{className:"font-medium","data-testid":"text-hall-name",children:(C==null?void 0:C.name)||"Unknown"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Customer"}),e.jsx("p",{className:"font-medium","data-testid":"text-customer-name",children:s.customerName}),e.jsx("p",{className:"text-sm",children:s.customerPhone}),s.customerEmail&&e.jsx("p",{className:"text-sm text-muted-foreground",children:s.customerEmail})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Start Time"}),e.jsx("p",{className:"font-medium","data-testid":"text-start-time",children:s.bookingStartTime?d(new Date(s.bookingStartTime),"PPp"):"N/A"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"End Time"}),e.jsx("p",{className:"font-medium","data-testid":"text-end-time",children:s.bookingEndTime?d(new Date(s.bookingEndTime),"PPp"):"N/A"})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Number of People"}),e.jsx("p",{className:"font-medium","data-testid":"text-num-people",children:s.numberOfPeople||0})]}),s.specialRequests&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Special Requests"}),e.jsx("p",{className:"text-sm","data-testid":"text-special-requests",children:s.specialRequests})]})]})]}),e.jsxs(u,{children:[e.jsx(h,{children:e.jsx(j,{children:"Payment Summary"})}),e.jsxs(p,{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Total Amount:"}),e.jsx("span",{className:"font-medium","data-testid":"text-total-amount",children:i(Number(s.totalAmount))})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Total Paid:"}),e.jsx("span",{className:"font-medium text-green-600","data-testid":"text-total-paid",children:i(D)})]}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Balance Due:"}),e.jsx("span",{className:m>0?"text-red-600":"text-green-600","data-testid":"text-balance-due",children:i(m)})]}),L&&m>0&&e.jsxs(x,{className:"w-full",onClick:()=>o(!0),"data-testid":"button-record-payment",children:[e.jsx(ue,{className:"w-4 h-4 mr-2"}),"Record Payment"]})]})]})]}),e.jsxs(u,{children:[e.jsx(h,{children:e.jsx(j,{children:"Payment History"})}),e.jsx(p,{children:c.length===0?e.jsx("p",{className:"text-center text-muted-foreground py-8","data-testid":"text-no-payments",children:"No payments recorded yet"}):e.jsx("div",{className:"space-y-4",children:c.map(t=>e.jsxs("div",{className:"flex items-center justify-between border-b pb-4 last:border-0","data-testid":`payment-record-${t.id}`,children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center",children:e.jsx(M,{className:"w-5 h-5 text-green-600 dark:text-green-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:i(Number(t.amount))}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[d(new Date(t.createdAt),"PPp")," â€¢ ",O(t.paymentMethod)]}),t.receiptNumber&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Receipt: ",t.receiptNumber]}),t.notes&&e.jsx("p",{className:"text-xs text-muted-foreground",children:t.notes})]})]}),e.jsx(ee,{className:"w-5 h-5 text-muted-foreground"})]},t.id))})})]}),e.jsxs(u,{children:[e.jsx(h,{children:e.jsx(j,{children:"Timeline"})}),e.jsx(p,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center",children:e.jsx(he,{className:"w-5 h-5 text-blue-600 dark:text-blue-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Booking Created"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.createdAt?d(new Date(s.createdAt),"PPp"):"N/A"})]})]}),s.confirmedAt&&e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center",children:e.jsx(M,{className:"w-5 h-5 text-green-600 dark:text-green-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Booking Confirmed"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:d(new Date(s.confirmedAt),"PPp")})]})]}),s.cancelledAt&&e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-red-100 dark:bg-red-900 flex items-center justify-center",children:e.jsx(te,{className:"w-5 h-5 text-red-600 dark:text-red-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Booking Cancelled"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:d(new Date(s.cancelledAt),"PPp")}),s.cancellationReason&&e.jsxs("p",{className:"text-sm text-red-600 dark:text-red-400 mt-1",children:["Reason: ",s.cancellationReason]})]})]})]})})]}),e.jsx(ne,{open:I,onOpenChange:o,children:e.jsxs(re,{children:[e.jsx(de,{children:e.jsx(ie,{children:"Record Payment"})}),e.jsx(X,{...r,children:e.jsxs("form",{onSubmit:r.handleSubmit(t=>w.mutate(t)),className:"space-y-4",children:[e.jsx(g,{control:r.control,name:"amount",render:({field:t})=>e.jsxs(f,{children:[e.jsxs(b,{children:["Amount (Max: ",i(m),")"]}),e.jsx(N,{children:e.jsx(F,{type:"number",step:"0.01",placeholder:"0.00",value:t.value,onChange:a=>t.onChange(Number(a.target.value||0)),"data-testid":"input-payment-amount"})}),e.jsx(y,{})]})}),e.jsx(g,{control:r.control,name:"paymentMethod",render:({field:t})=>e.jsxs(f,{children:[e.jsx(b,{children:"Payment Method"}),e.jsxs(le,{onValueChange:t.onChange,value:t.value,children:[e.jsx(N,{children:e.jsx(oe,{"data-testid":"select-payment-method",children:e.jsx(ce,{placeholder:"Select method"})})}),e.jsxs(me,{children:[e.jsx(v,{value:"cash",children:"Cash"}),e.jsx(v,{value:"pos",children:"POS/Card"}),e.jsx(v,{value:"fonepay",children:"Fonepay"}),e.jsx(v,{value:"bank_transfer",children:"Bank Transfer"})]})]}),e.jsx(y,{})]})}),e.jsx(g,{control:r.control,name:"receiptNumber",render:({field:t})=>e.jsxs(f,{children:[e.jsx(b,{children:"Receipt Number (Optional)"}),e.jsx(N,{children:e.jsx(F,{...t,placeholder:"Enter receipt number","data-testid":"input-receipt-number"})}),e.jsx(y,{})]})}),e.jsx(g,{control:r.control,name:"notes",render:({field:t})=>e.jsxs(f,{children:[e.jsx(b,{children:"Notes (Optional)"}),e.jsx(N,{children:e.jsx(ae,{...t,placeholder:"Additional notes",rows:3,"data-testid":"textarea-payment-notes"})}),e.jsx(y,{})]})}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(x,{type:"button",variant:"outline",onClick:()=>o(!1),"data-testid":"button-cancel-payment",children:"Cancel"}),e.jsx(x,{type:"submit",disabled:w.isPending,"data-testid":"button-submit-payment",children:w.isPending?"Recording...":"Record Payment"})]})]})})]})})]})})}export{Se as default};
