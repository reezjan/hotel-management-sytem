import{r as n,b as Y,l as B,d as L,j as e,B as h,C as x,m as j,n as p,a as g,s as o,I as f,y as Z}from"./index-CuDmVYun.js";import{S as ee,a as se,b as te,c as ae,d as K}from"./select-7c0Tajxe.js";import{B as y}from"./badge-DMaRL5Qw.js";import{D as re,a as ne,b as ie,c as le,d as de}from"./dialog-CYNkLpdV.js";import{t as r}from"./index-hq1wgpuD.js";import{D as Q,a as oe,m as R,i as ce,z as ue,t as me,k as he}from"./dashboard-layout-RBv1DXX2.js";import{U as xe}from"./users-DXv82DeH.js";import"./index-D12ZMnos.js";import"./index-dzpsPapz.js";import"./circle-alert-CPwmOhkC.js";function Se(){const[$,v]=n.useState(!1),[l,N]=n.useState(null),[w,b]=n.useState(""),[c,C]=n.useState(""),[u,S]=n.useState(""),[F,D]=n.useState(""),[U,V]=n.useState(""),[m,E]=n.useState(""),T=Y(),{data:a,isLoading:z}=B({queryKey:["/api/user"],queryFn:async()=>{const s=await fetch("/api/user",{credentials:"include"});if(!s.ok)throw new Error("Failed to fetch user");return s.json()},refetchInterval:3e3}),{data:i=[],isLoading:H}=B({queryKey:["/api/hotels/current/vouchers"],queryFn:async()=>{const s=await fetch("/api/hotels/current/vouchers",{credentials:"include"});if(!s.ok)throw new Error("Failed to fetch vouchers");return s.json()},refetchInterval:3e3}),A=L({mutationFn:async s=>{if(!(a!=null&&a.hotelId)||!(a!=null&&a.id))throw new Error("User information not available");const t=await fetch("/api/vouchers",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(s)});if(!t.ok)throw new Error("Failed to create voucher");return t.json()},onSuccess:()=>{T.invalidateQueries({queryKey:["/api/hotels/current/vouchers"]}),r.success("Voucher created successfully"),q()},onError:s=>{r.error(s.message||"Failed to create voucher")}}),P=L({mutationFn:async({id:s,data:t})=>{const d=await fetch(`/api/vouchers/${s}`,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(t)});if(!d.ok)throw new Error("Failed to update voucher");return d.json()},onSuccess:()=>{T.invalidateQueries({queryKey:["/api/hotels/current/vouchers"]}),r.success("Voucher updated successfully"),N(null),q()},onError:s=>{r.error(s.message||"Failed to update voucher")}}),O=L({mutationFn:async s=>{if(!(await fetch(`/api/vouchers/${s}`,{method:"DELETE",credentials:"include"})).ok)throw new Error("Failed to delete voucher")},onSuccess:()=>{T.invalidateQueries({queryKey:["/api/hotels/current/vouchers"]}),r.success("Voucher deleted successfully")},onError:s=>{r.error(s.message||"Failed to delete voucher")}}),q=()=>{b(""),C(""),S(""),D(""),V(""),E(""),v(!1),N(null)},J=s=>{if(s.preventDefault(),!(a!=null&&a.hotelId)||!(a!=null&&a.id)){r.error("Please wait for user information to load");return}if(!w||!c||!u||!F||!U||!m){r.error("Please fill in all required fields");return}if(isNaN(Number(c))||Number(c)<=0){r.error("Please enter a valid discount amount");return}if(isNaN(Number(m))||Number(m)<=0){r.error("Please enter a valid maximum uses");return}const t={code:w.toUpperCase(),discountAmount:Number(c).toFixed(2),discountType:u,validFrom:new Date(F).toISOString(),validUntil:new Date(U).toISOString(),maxUses:Number(m)};l?P.mutate({id:l.id,data:t}):A.mutate(t)},W=s=>{N(s),b(s.code),C(s.discountAmount),S(s.discountType),D(new Date(s.validFrom).toISOString().split("T")[0]),V(new Date(s.validUntil).toISOString().split("T")[0]),E(s.maxUses.toString()),v(!0)},k=s=>new Date(s).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}),_=s=>{const t=new Date,d=new Date(s.validFrom),I=new Date(s.validUntil);return t<d?e.jsx(y,{variant:"outline",children:"Upcoming"}):t>I?e.jsx(y,{variant:"destructive",children:"Expired"}):s.usedCount>=s.maxUses?e.jsx(y,{variant:"secondary",children:"Exhausted"}):e.jsx(y,{variant:"default",children:"Active"})},G=s=>s.discountType==="percentage"?`${s.discountAmount}%`:`NPR ${Number(s.discountAmount).toLocaleString()}`,X=i.filter(s=>{const t=new Date,d=new Date(s.validFrom),I=new Date(s.validUntil);return t>=d&&t<=I&&s.usedCount<s.maxUses}),M=i.reduce((s,t)=>s+t.usedCount,0);return z||H?e.jsx(Q,{title:"Discount Vouchers",children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-8 bg-gray-200 rounded w-1/4"}),e.jsx("div",{className:"h-32 bg-gray-200 rounded"}),e.jsx("div",{className:"h-64 bg-gray-200 rounded"})]})}):e.jsx(Q,{title:"Discount Vouchers",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Discount Vouchers"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Create and manage discount vouchers for your customers"})]}),e.jsxs(h,{onClick:()=>v(!0),className:"flex items-center gap-2",children:[e.jsx(oe,{className:"h-4 w-4"}),"Create Voucher"]})]}),e.jsxs("div",{className:"grid md:grid-cols-4 gap-6",children:[e.jsxs(x,{children:[e.jsxs(j,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(p,{className:"text-sm font-medium",children:"Total Vouchers"}),e.jsx(R,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(g,{children:[e.jsx("div",{className:"text-2xl font-bold",children:i.length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"All time"})]})]}),e.jsxs(x,{children:[e.jsxs(j,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(p,{className:"text-sm font-medium",children:"Active Vouchers"}),e.jsx(ce,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(g,{children:[e.jsx("div",{className:"text-2xl font-bold",children:X.length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Currently valid"})]})]}),e.jsxs(x,{children:[e.jsxs(j,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(p,{className:"text-sm font-medium",children:"Total Usage"}),e.jsx(xe,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(g,{children:[e.jsx("div",{className:"text-2xl font-bold",children:M}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Times redeemed"})]})]}),e.jsxs(x,{children:[e.jsxs(j,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(p,{className:"text-sm font-medium",children:"Avg. Usage Rate"}),e.jsx(ue,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(g,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[i.length>0?Math.round(M/i.reduce((s,t)=>s+t.maxUses,0)*100):0,"%"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Average redemption"})]})]})]}),e.jsx(re,{open:$,onOpenChange:v,children:e.jsxs(ne,{className:"max-w-md",children:[e.jsxs(ie,{children:[e.jsx(le,{children:l?"Edit Voucher":"Create New Voucher"}),e.jsx(de,{children:l?"Update voucher details":"Create a new discount voucher for customers"})]}),e.jsxs("form",{onSubmit:J,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"code",children:"Voucher Code *"}),e.jsx(f,{id:"code",placeholder:"e.g., WELCOME10",value:w,onChange:s=>b(s.target.value),required:!0})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"discountType",children:"Discount Type *"}),e.jsxs(ee,{value:u,onValueChange:S,children:[e.jsx(se,{children:e.jsx(te,{placeholder:"Select type"})}),e.jsxs(ae,{children:[e.jsx(K,{value:"percentage",children:"Percentage"}),e.jsx(K,{value:"fixed_amount",children:"Fixed Amount"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(o,{htmlFor:"discountAmount",children:["Amount * ",u==="percentage"?"(%)":"(NPR)"]}),e.jsx(f,{id:"discountAmount",type:"number",step:"0.01",placeholder:u==="percentage"?"10":"100",value:c,onChange:s=>C(s.target.value),required:!0})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"validFrom",children:"Valid From *"}),e.jsx(f,{id:"validFrom",type:"date",value:F,onChange:s=>D(s.target.value),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"validUntil",children:"Valid Until *"}),e.jsx(f,{id:"validUntil",type:"date",value:U,onChange:s=>V(s.target.value),required:!0})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"maxUses",children:"Maximum Uses *"}),e.jsx(f,{id:"maxUses",type:"number",placeholder:"100",value:m,onChange:s=>E(s.target.value),required:!0})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx(h,{type:"submit",disabled:A.isPending||P.isPending,className:"flex-1",children:A.isPending||P.isPending?l?"Updating...":"Creating...":l?"Update Voucher":"Create Voucher"}),e.jsx(h,{type:"button",variant:"outline",onClick:q,children:"Cancel"})]})]})]})}),e.jsxs(x,{children:[e.jsxs(j,{children:[e.jsx(p,{children:"All Vouchers"}),e.jsx(Z,{children:"Manage your discount vouchers and track usage"})]}),e.jsx(g,{children:i.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(R,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No vouchers created yet"}),e.jsx("p",{className:"text-sm",children:"Create your first discount voucher to get started"})]}):e.jsx("div",{className:"space-y-4",children:i.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("h3",{className:"font-semibold text-lg",children:s.code}),_(s),e.jsx("span",{className:"font-bold text-green-600",children:G(s)})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-gray-600",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Valid: "}),k(s.validFrom)," - ",k(s.validUntil)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Usage: "}),s.usedCount,"/",s.maxUses]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Remaining: "}),s.maxUses-s.usedCount]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Created: "}),k(s.createdAt)]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>W(s),children:e.jsx(me,{className:"h-4 w-4"})}),e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>O.mutate(s.id),className:"text-red-600 hover:text-red-700 hover:bg-red-50",disabled:O.isPending,children:e.jsx(he,{className:"h-4 w-4"})})]})]},s.id))})})]})]})})}export{Se as default};
