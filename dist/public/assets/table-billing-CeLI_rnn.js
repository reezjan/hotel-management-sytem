import{q as Qe,u as Ue,b as _e,r as c,l as I,d as oe,j as e,C as M,m as B,n as k,a as q,p as r,s as v,I as N,B as y,k as ce}from"./index-CuDmVYun.js";import{D as Ge,R as De,a8 as We,k as Ee,a as Ie,a7 as Me,t as Je}from"./dashboard-layout-RBv1DXX2.js";import{S as X,a as Y,b as Z,c as ee,d as f}from"./select-7c0Tajxe.js";import{D as Xe,a as Ye,b as Ze,c as et,e as tt}from"./dialog-CYNkLpdV.js";import{T as st,a as at,b as Be,c as ke}from"./tabs-CX8s-N0D.js";import{C as nt}from"./checkbox-C--WSSL-.js";import{T as it}from"./textarea-CpuNoaOI.js";import{H as lt,U as rt}from"./users-DXv82DeH.js";import"./circle-alert-CPwmOhkC.js";import"./index-D12ZMnos.js";import"./index-dzpsPapz.js";function ft(){const{user:S}=Qe(),{toast:m}=Ue(),H=_e(),[E,me]=c.useState([]),[te,se]=c.useState(""),[p,O]=c.useState(null),[L,ue]=c.useState("percentage"),[A,pe]=c.useState(0),[P,xe]=c.useState("none"),[K,qe]=c.useState(2),[$,Q]=c.useState([]),[w,ae]=c.useState([]),[ne,ie]=c.useState(""),[he,le]=c.useState(""),[ve,ye]=c.useState(""),[Oe,U]=c.useState(!1),[_,re]=c.useState(""),[F,de]=c.useState(null),[G,je]=c.useState(""),[W,ge]=c.useState(""),[J,fe]=c.useState(""),{data:T}=I({queryKey:["/api/hotels/current"],refetchInterval:3e3}),{data:R=[]}=I({queryKey:["/api/hotels/current/restaurant-tables"],refetchInterval:3e3}),{data:be=[]}=I({queryKey:["/api/hotels/current/kot-orders"],refetchInterval:3e3}),{data:Ne=[]}=I({queryKey:["/api/hotels/current/menu-items"],refetchInterval:3e3}),{data:Fe=[]}=I({queryKey:["/api/hotels/current/taxes"],refetchInterval:3e3}),{data:Se=[]}=I({queryKey:["/api/hotels/current/bills",G,W,J],refetchInterval:3e3,queryFn:async()=>{const t=new URLSearchParams;G&&t.append("startDate",G),W&&t.append("endDate",W),J&&t.append("status",J);const s=await fetch(`/api/hotels/current/bills?${t.toString()}`,{credentials:"include"});if(!s.ok)throw new Error("Failed to fetch bills");return s.json()}}),we=oe({mutationFn:async t=>{if(!t||t.trim().length===0)throw new Error("Please enter a voucher code");return await ce("POST","/api/vouchers/validate",{code:t.trim()})},onSuccess:t=>{if(t.valid&&t.voucher){O(t.voucher);const s=t.voucher.discountType==="percentage"?`${t.voucher.discountAmount}% off`:`${r(t.voucher.discountAmount)} off`;m({title:"âœ“ Voucher Applied!",description:`Code: ${t.voucher.code} - ${s}`})}else O(null),m({title:"Invalid Voucher",description:"Voucher code not found or expired",variant:"destructive"})},onError:t=>{O(null),m({title:"Validation Error",description:(t==null?void 0:t.message)||"Unable to validate voucher",variant:"destructive"})}}),Te=oe({mutationFn:async t=>await ce("POST","/api/hotels/current/bills",t),onSuccess:()=>{H.invalidateQueries({queryKey:["/api/hotels/current/kot-orders"]}),H.invalidateQueries({queryKey:["/api/hotels/current/transactions"]}),H.invalidateQueries({queryKey:["/api/hotels/current/bills"]}),m({title:"Bill created and payment processed successfully"}),me([]),O(null),se(""),ue("percentage"),pe(0),xe("none"),ae([]),ie(""),le("")},onError:t=>{m({title:"Error",description:t.message,variant:"destructive"})}}),Ce=oe({mutationFn:async({id:t,data:s})=>await ce("PUT",`/api/hotels/current/bills/${t}`,s),onSuccess:()=>{H.invalidateQueries({queryKey:["/api/hotels/current/bills"]}),m({title:"Bill amended successfully"}),U(!1),re(""),de(null)},onError:t=>{m({title:"Error",description:t.message,variant:"destructive"})}}),Ae=t=>{me(s=>s.includes(t)?s.filter(a=>a!==t):[...s,t])},V=be.filter(t=>{var s;return!E.includes(t.tableId)||t.status==="cancelled"||t.status==="served"?!1:(s=t.items)==null?void 0:s.some(a=>a.status==="approved"||a.status==="ready")}),o=(()=>{let t=0;const s=[];V.forEach(d=>{var C;(C=d.items)==null||C.forEach(x=>{if(x.status==="approved"||x.status==="ready"){const b=Ne.find(Ke=>Ke.id===x.menuItemId);b&&(t+=b.price*x.qty,s.push({orderId:d.id,itemId:x.id,menuItemId:x.menuItemId,name:b.name,qty:x.qty,price:b.price,total:b.price*x.qty}))}})});const a=Fe.filter(d=>d.isActive),n=["vat","service_tax","luxury_tax"],h=a.sort((d,C)=>{const x=n.indexOf(d.taxType),b=n.indexOf(C.taxType);return(x===-1?999:x)-(b===-1?999:b)});let j=t;const l={};h.forEach(d=>{const C=parseFloat(d.percent)/100,x=Math.round(j*C*100)/100,b=d.taxType==="vat"?"VAT":d.taxType==="service_tax"?"Service Tax":d.taxType==="luxury_tax"?"Luxury Tax":d.taxType;l[b]={rate:parseFloat(d.percent),amount:x},j=Math.round((j+x)*100)/100});const D=Object.values(l).reduce((d,C)=>d+C.amount,0);let g=Math.round((t+D)*100)/100,i=0;p&&(p.discountType==="percentage"?i=Math.round(g*(parseFloat(p.discountAmount)/100)*100)/100:p.discountType==="fixed"&&(i=Math.min(parseFloat(p.discountAmount),g)),g=Math.round((g-i)*100)/100);let u=0;return A>0&&(L==="percentage"?u=Math.round(g*(A/100)*100)/100:u=Math.round(A*100)/100,g=Math.round((g+u)*100)/100),{subtotal:t,taxBreakdown:l,totalTax:D,discountAmount:i,tipAmount:u,grandTotal:g,items:s}})(),Pe=w.reduce((t,s)=>t+s.amount,0),z=Math.max(0,o.grandTotal-Pe),Re=()=>{if(!ne){m({title:"Error",description:"Please select a payment method",variant:"destructive"});return}const t=parseFloat(he);if(isNaN(t)||t<=0){m({title:"Error",description:"Please enter a valid payment amount",variant:"destructive"});return}if(t>z){m({title:"Error",description:"Payment amount exceeds remaining balance",variant:"destructive"});return}const s={id:Date.now().toString(),paymentMethod:ne,amount:t,reference:ve||void 0};ae([...w,s]),ie(""),le(""),ye("")},Ve=t=>{ae(w.filter(s=>s.id!==t))},ze=()=>{te.trim()&&we.mutate(te.trim())},He=async()=>{if(E.length===0){m({title:"Error",description:"Please select at least one table",variant:"destructive"});return}if(V.length===0){m({title:"Error",description:"No orders to process",variant:"destructive"});return}if(w.length===0){m({title:"Error",description:"Please add at least one payment",variant:"destructive"});return}if(Math.abs(z)>.01){m({title:"Error",description:"Total payments must equal the bill amount",variant:"destructive"});return}let t=null;if(P==="equal"){const a=Math.round(o.grandTotal/K*100)/100;t={mode:"equal",count:K,amountPerPerson:a}}else P==="custom"&&$.length>0&&(t={mode:"custom",splits:$});const s={tableIds:E,orderIds:V.map(a=>a.id),subtotal:o.subtotal.toString(),taxBreakdown:o.taxBreakdown,totalTax:o.totalTax.toString(),discount:o.discountAmount.toString(),voucherId:(p==null?void 0:p.id)||null,voucherCode:(p==null?void 0:p.code)||null,tipType:A>0?L:null,tipValue:A>0?A.toString():"0",tipAmount:o.tipAmount.toString(),grandTotal:o.grandTotal.toString(),splitMode:P!=="none"?P:null,splitDetails:t,items:o.items,status:"final",payments:w.map(a=>({paymentMethod:a.paymentMethod,amount:a.amount.toString(),reference:a.reference}))};Te.mutate(s)},$e=t=>{var g;const s=t||{billNumber:`PREVIEW-${Date.now().toString().slice(-6)}`,...o,tableNames:E.map(i=>{var u;return(u=R.find(d=>d.id===i))==null?void 0:u.name}).join(", "),createdAt:new Date().toISOString(),payments:w},a=(T==null?void 0:T.name)||"HOTEL",n=(T==null?void 0:T.address)||"",h=(T==null?void 0:T.phone)||"",j=new Date(s.createdAt);let l=`
<div style="font-family: 'Courier New', monospace; width: 300px; padding: 10px;">
  <div style="text-align: center; font-weight: bold; font-size: 16px; border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 10px;">
    ${a}
  </div>
  
  <div style="text-align: center; font-size: 11px; margin-bottom: 10px;">
    ${n?`${n}<br/>`:""}
    ${h?`Tel: ${h}<br/>`:""}
  </div>
  
  <div style="text-align: center; font-size: 12px; margin-bottom: 15px;">
    Restaurant Bill<br/>
    ${s.tableNames||((g=s.tableIds)==null?void 0:g.map(i=>{var u;return(u=R.find(d=>d.id===i))==null?void 0:u.name}).join(", "))}
  </div>
  
  <div style="font-size: 11px; margin-bottom: 10px;">
    <div>Date: ${j.toLocaleDateString("en-US",{year:"numeric",month:"short",day:"2-digit"})}</div>
    <div>Time: ${j.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"})}</div>
    <div>Bill No: ${s.billNumber}</div>
    <div>Cashier: ${S==null?void 0:S.username}</div>
  </div>
  
  <div style="border-top: 2px dashed #000; border-bottom: 2px dashed #000; padding: 10px 0; margin: 10px 0;">
    <table style="width: 100%; font-size: 11px;">
      <thead>
        <tr style="border-bottom: 1px solid #000;">
          <th style="text-align: left; padding-bottom: 5px;">Item</th>
          <th style="text-align: center; padding-bottom: 5px;">Qty</th>
          <th style="text-align: right; padding-bottom: 5px;">Amount</th>
        </tr>
      </thead>
      <tbody>`;(s.items||[]).forEach(i=>{l+=`
        <tr>
          <td style="padding: 3px 0;">${i.name}</td>
          <td style="text-align: center;">${i.qty}</td>
          <td style="text-align: right;">${r(i.total)}</td>
        </tr>`}),l+=`
      </tbody>
    </table>
  </div>
  
  <div style="font-size: 11px; margin-top: 10px;">
    <div style="display: flex; justify-content: space-between; padding: 3px 0;">
      <span>Subtotal:</span>
      <span>${r(s.subtotal)}</span>
    </div>`,Object.entries(s.taxBreakdown||{}).forEach(([i,u])=>{l+=`
    <div style="display: flex; justify-content: space-between; padding: 3px 0; padding-left: 10px;">
      <span>${i} (${u.rate}%):</span>
      <span>${r(u.amount)}</span>
    </div>`}),s.discountAmount>0&&(l+=`
    <div style="display: flex; justify-content: space-between; padding: 3px 0; color: green;">
      <span>Discount:</span>
      <span>-${r(s.discountAmount)}</span>
    </div>`),s.tipAmount>0&&(l+=`
    <div style="display: flex; justify-content: space-between; padding: 3px 0;">
      <span>Tip/Gratuity:</span>
      <span>${r(s.tipAmount)}</span>
    </div>`),l+=`
    <div style="display: flex; justify-content: space-between; padding: 8px 0; margin-top: 5px; border-top: 2px solid #000; font-weight: bold; font-size: 13px;">
      <span>GRAND TOTAL:</span>
      <span>${r(s.grandTotal)}</span>
    </div>
  </div>`,s.payments&&s.payments.length>0&&(l+=`
  <div style="font-size: 11px; margin-top: 10px; border-top: 1px dashed #000; padding-top: 10px;">
    <div style="font-weight: bold; margin-bottom: 5px;">Payment Details:</div>`,s.payments.forEach(i=>{const u=i.paymentMethod==="cash"?"Cash":i.paymentMethod==="pos"?"Card/POS":i.paymentMethod==="fonepay"?"Fonepay":i.paymentMethod;l+=`
    <div style="display: flex; justify-content: space-between; padding: 2px 0;">
      <span>${u}:</span>
      <span>${r(i.amount)}</span>
    </div>`}),l+=`
  </div>`),s.splitMode&&s.splitDetails&&(l+=`
  <div style="font-size: 11px; margin-top: 10px; border-top: 1px dashed #000; padding-top: 10px;">
    <div style="font-weight: bold; margin-bottom: 5px;">Split Bill:</div>`,s.splitMode==="equal"?l+=`
    <div>Split ${s.splitDetails.count} ways: ${r(s.splitDetails.amountPerPerson)} each</div>`:s.splitMode==="custom"&&s.splitDetails.splits.forEach(i=>{l+=`
    <div style="display: flex; justify-content: space-between; padding: 2px 0;">
      <span>${i.name}:</span>
      <span>${r(i.amount)}</span>
    </div>`}),l+=`
  </div>`),l+=`
  
  <div style="text-align: center; font-size: 10px; margin-top: 15px; padding-top: 10px; border-top: 2px dashed #000;">
    Thank you for your visit!<br/>
    Please come again
  </div>
</div>`;const D=window.open("","_blank");D&&(D.document.write(`
        <html>
          <head>
            <title>Bill ${s.billNumber}</title>
          </head>
          <body>${l}</body>
        </html>
      `),D.document.close(),D.print())},Le=()=>{if(F){if(!_.trim()){m({title:"Error",description:"Please provide an amendment note",variant:"destructive"});return}Ce.mutate({id:F.id,data:{amendmentNote:_.trim(),status:"amended"}})}};return e.jsx(Ge,{title:"Table Billing",children:e.jsxs("div",{className:"p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-6",children:e.jsx("h1",{className:"text-3xl font-bold",children:"Table Billing"})}),e.jsxs(st,{defaultValue:"billing",className:"w-full",children:[e.jsxs(at,{children:[e.jsxs(Be,{value:"billing","data-testid":"tab-billing",children:[e.jsx(De,{className:"w-4 h-4 mr-2"}),"Create Bill"]}),e.jsxs(Be,{value:"history","data-testid":"tab-history",children:[e.jsx(lt,{className:"w-4 h-4 mr-2"}),"Bill History"]})]}),e.jsx(ke,{value:"billing",className:"space-y-6",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs(M,{children:[e.jsx(B,{children:e.jsxs(k,{className:"flex items-center",children:[e.jsx(rt,{className:"w-5 h-5 mr-2"}),"Select Tables"]})}),e.jsx(q,{children:e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-3",children:R.map(t=>{const s=be.some(a=>{var n;return a.tableId===t.id&&a.status!=="cancelled"&&a.status!=="served"&&((n=a.items)==null?void 0:n.some(h=>h.status==="approved"||h.status==="ready"))});return e.jsxs("div",{className:`flex items-center space-x-2 p-3 rounded-lg border ${E.includes(t.id)?"bg-blue-50 border-blue-500":"border-gray-200"} ${s?"cursor-pointer hover:bg-gray-50":"opacity-50"}`,onClick:()=>s&&Ae(t.id),"data-testid":`table-select-${t.id}`,children:[e.jsx(nt,{checked:E.includes(t.id),disabled:!s,onCheckedChange:()=>s&&Ae(t.id),"data-testid":`checkbox-table-${t.id}`}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:t.name}),s&&e.jsx("div",{className:"text-xs text-green-600",children:"Active Orders"})]})]},t.id)})})})]}),e.jsxs(M,{children:[e.jsx(B,{children:e.jsx(k,{children:"Order Items"})}),e.jsx(q,{children:V.length===0?e.jsx("p",{className:"text-gray-500 text-center py-4",children:"Select tables to view orders"}):e.jsx("div",{className:"space-y-3",children:V.map(t=>{var s,a;return e.jsxs("div",{className:"border rounded-lg p-3",children:[e.jsxs("div",{className:"font-medium text-sm mb-2",children:["Table: ",(s=R.find(n=>n.id===t.tableId))==null?void 0:s.name]}),(a=t.items)==null?void 0:a.filter(n=>n.status==="approved"||n.status==="ready").map(n=>{const h=Ne.find(j=>j.id===n.menuItemId);return h?e.jsxs("div",{className:"flex justify-between items-center text-sm py-1",children:[e.jsx("span",{children:h.name}),e.jsxs("span",{children:["x",n.qty]}),e.jsx("span",{className:"font-medium",children:r(h.price*n.qty)})]},n.id):null})]},t.id)})})})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(M,{children:[e.jsx(B,{children:e.jsx(k,{children:"Bill Summary"})}),e.jsxs(q,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{"data-testid":"text-subtotal",children:r(o.subtotal)})]}),Object.entries(o.taxBreakdown).map(([t,s])=>e.jsxs("div",{className:"flex justify-between text-sm pl-4",children:[e.jsxs("span",{children:[t," (",s.rate,"%):"]}),e.jsx("span",{children:r(s.amount)})]},t)),o.discountAmount>0&&e.jsxs("div",{className:"flex justify-between text-sm text-green-600",children:[e.jsx("span",{children:"Discount:"}),e.jsxs("span",{"data-testid":"text-discount",children:["-",r(o.discountAmount)]})]}),e.jsxs("div",{className:"border-t pt-3 mt-3",children:[e.jsx(v,{className:"text-sm font-medium",children:"Tip/Gratuity (Optional)"}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsxs(X,{value:L,onValueChange:t=>ue(t),children:[e.jsx(Y,{className:"w-32","data-testid":"select-tip-type",children:e.jsx(Z,{})}),e.jsxs(ee,{children:[e.jsx(f,{value:"percentage",children:"Percentage"}),e.jsx(f,{value:"flat",children:"Flat Amount"})]})]}),e.jsx(N,{type:"number",placeholder:L==="percentage"?"%":"Amount",value:A,onChange:t=>pe(parseFloat(t.target.value)||0),className:"flex-1","data-testid":"input-tip-value"})]}),o.tipAmount>0&&e.jsxs("div",{className:"flex justify-between text-sm mt-2",children:[e.jsx("span",{children:"Tip Amount:"}),e.jsx("span",{"data-testid":"text-tip-amount",children:r(o.tipAmount)})]})]}),e.jsxs("div",{className:"flex justify-between text-lg font-bold border-t pt-3 mt-3",children:[e.jsx("span",{children:"GRAND TOTAL:"}),e.jsx("span",{"data-testid":"text-grand-total",children:r(o.grandTotal)})]})]}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsx(v,{className:"text-sm font-medium",children:"Apply Voucher"}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsx(N,{placeholder:"Voucher code",value:te,onChange:t=>se(t.target.value),disabled:!!p,"data-testid":"input-voucher-code"}),e.jsx(y,{onClick:ze,disabled:we.isPending||!!p,"data-testid":"button-apply-voucher",children:"Apply"}),p&&e.jsx(y,{variant:"outline",onClick:()=>{O(null),se("")},"data-testid":"button-remove-voucher",children:"Remove"})]})]}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsxs(v,{className:"text-sm font-medium flex items-center",children:[e.jsx(We,{className:"w-4 h-4 mr-2"}),"Split Bill"]}),e.jsxs(X,{value:P,onValueChange:t=>xe(t),children:[e.jsx(Y,{className:"mt-2","data-testid":"select-split-mode",children:e.jsx(Z,{})}),e.jsxs(ee,{children:[e.jsx(f,{value:"none",children:"No Split"}),e.jsx(f,{value:"equal",children:"Split Equally"}),e.jsx(f,{value:"custom",children:"Custom Split"})]})]}),P==="equal"&&e.jsxs("div",{className:"mt-2",children:[e.jsx(v,{className:"text-xs",children:"Number of people"}),e.jsx(N,{type:"number",min:"2",value:K,onChange:t=>qe(parseInt(t.target.value)||2),"data-testid":"input-split-count"}),e.jsxs("p",{className:"text-sm text-gray-600 mt-2",children:[r(o.grandTotal/K)," per person"]})]}),P==="custom"&&e.jsxs("div",{className:"mt-2 space-y-2",children:[$.map((t,s)=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx(N,{placeholder:"Name",value:t.name,onChange:a=>{const n=[...$];n[s].name=a.target.value,Q(n)},className:"flex-1","data-testid":`input-split-name-${s}`}),e.jsx(N,{type:"number",placeholder:"Amount",value:t.amount,onChange:a=>{const n=[...$];n[s].amount=parseFloat(a.target.value)||0,Q(n)},className:"w-32","data-testid":`input-split-amount-${s}`}),e.jsx(y,{variant:"ghost",size:"icon",onClick:()=>Q($.filter((a,n)=>n!==s)),"data-testid":`button-remove-split-${s}`,children:e.jsx(Ee,{className:"w-4 h-4"})})]},s)),e.jsxs(y,{variant:"outline",size:"sm",onClick:()=>Q([...$,{name:"",amount:0}]),"data-testid":"button-add-split",children:[e.jsx(Ie,{className:"w-4 h-4 mr-2"}),"Add Split"]})]})]})]})]}),e.jsxs(M,{children:[e.jsx(B,{children:e.jsx(k,{children:"Payment"})}),e.jsxs(q,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(v,{className:"text-sm",children:"Payment Method"}),e.jsxs(X,{value:ne,onValueChange:ie,children:[e.jsx(Y,{"data-testid":"select-payment-method",children:e.jsx(Z,{placeholder:"Select method"})}),e.jsxs(ee,{children:[e.jsx(f,{value:"cash",children:"Cash"}),e.jsx(f,{value:"pos",children:"Card/POS"}),e.jsx(f,{value:"fonepay",children:"Fonepay"})]})]})]}),e.jsxs("div",{children:[e.jsx(v,{className:"text-sm",children:"Amount"}),e.jsx(N,{type:"number",placeholder:"Enter amount",value:he,onChange:t=>le(t.target.value),"data-testid":"input-payment-amount"})]}),e.jsxs("div",{children:[e.jsx(v,{className:"text-sm",children:"Reference (Optional)"}),e.jsx(N,{placeholder:"Transaction ref",value:ve,onChange:t=>ye(t.target.value),"data-testid":"input-payment-reference"})]}),e.jsxs(y,{onClick:Re,className:"w-full",variant:"outline","data-testid":"button-add-payment",children:[e.jsx(Ie,{className:"w-4 h-4 mr-2"}),"Add Payment"]})]}),w.length>0&&e.jsxs("div",{className:"border-t pt-4 space-y-2",children:[e.jsx(v,{className:"text-sm font-medium",children:"Payments Added:"}),w.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-2 bg-gray-50 rounded","data-testid":`payment-entry-${t.id}`,children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-sm",children:t.paymentMethod==="cash"?"Cash":t.paymentMethod==="pos"?"Card/POS":"Fonepay"}),e.jsx("div",{className:"text-xs text-gray-600",children:r(t.amount)}),t.reference&&e.jsxs("div",{className:"text-xs text-gray-500",children:["Ref: ",t.reference]})]}),e.jsx(y,{variant:"ghost",size:"sm",onClick:()=>Ve(t.id),"data-testid":`button-remove-payment-${t.id}`,children:e.jsx(Ee,{className:"w-4 h-4"})})]},t.id)),e.jsxs("div",{className:"flex justify-between font-medium pt-2 border-t",children:[e.jsx("span",{children:"Total Paid:"}),e.jsx("span",{"data-testid":"text-total-paid",children:r(Pe)})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Remaining:"}),e.jsx("span",{className:z>0?"text-red-600":"text-green-600","data-testid":"text-remaining",children:r(z)})]})]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(y,{onClick:He,disabled:Te.isPending||z!==0||w.length===0,className:"flex-1","data-testid":"button-process-bill",children:[e.jsx(De,{className:"w-4 h-4 mr-2"}),"Process Bill"]}),e.jsxs(y,{onClick:()=>$e(),variant:"outline","data-testid":"button-print-preview",children:[e.jsx(Me,{className:"w-4 h-4 mr-2"}),"Preview"]})]})]})]})]})]})}),e.jsxs(ke,{value:"history",className:"space-y-6",children:[e.jsxs(M,{children:[e.jsx(B,{children:e.jsx(k,{children:"Filter Bills"})}),e.jsx(q,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx(v,{className:"text-sm",children:"Start Date"}),e.jsx(N,{type:"date",value:G,onChange:t=>je(t.target.value),"data-testid":"input-history-start-date"})]}),e.jsxs("div",{children:[e.jsx(v,{className:"text-sm",children:"End Date"}),e.jsx(N,{type:"date",value:W,onChange:t=>ge(t.target.value),"data-testid":"input-history-end-date"})]}),e.jsxs("div",{children:[e.jsx(v,{className:"text-sm",children:"Status"}),e.jsxs(X,{value:J,onValueChange:fe,children:[e.jsx(Y,{"data-testid":"select-history-status",children:e.jsx(Z,{placeholder:"All"})}),e.jsxs(ee,{children:[e.jsx(f,{value:"",children:"All"}),e.jsx(f,{value:"final",children:"Final"}),e.jsx(f,{value:"amended",children:"Amended"})]})]})]}),e.jsx("div",{className:"flex items-end",children:e.jsx(y,{onClick:()=>{je(""),ge(""),fe("")},variant:"outline","data-testid":"button-clear-filters",children:"Clear Filters"})})]})})]}),e.jsxs(M,{children:[e.jsx(B,{children:e.jsx(k,{children:"Bill History"})}),e.jsx(q,{children:Se.length===0?e.jsx("p",{className:"text-center text-gray-500 py-8",children:"No bills found"}):e.jsx("div",{className:"space-y-3",children:Se.map(t=>{var s,a,n;return e.jsxs("div",{className:"border rounded-lg p-4","data-testid":`bill-history-${t.id}`,children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:t.billNumber}),e.jsx("div",{className:"text-sm text-gray-600",children:new Date(t.createdAt).toLocaleString()}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Tables: ",(s=t.tableIds)==null?void 0:s.map(h=>{var j;return(j=R.find(l=>l.id===h))==null?void 0:j.name}).join(", ")]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-bold text-lg",children:r(parseFloat(t.grandTotal))}),e.jsx("div",{className:`text-xs px-2 py-1 rounded ${t.status==="final"?"bg-green-100 text-green-700":t.status==="amended"?"bg-yellow-100 text-yellow-700":"bg-gray-100"}`,children:t.status})]})]}),t.amendmentNote&&e.jsxs("div",{className:"text-xs bg-yellow-50 p-2 rounded mb-2",children:[e.jsx("strong",{children:"Amendment:"})," ",t.amendmentNote]}),e.jsxs("div",{className:"flex gap-2 mt-3",children:[e.jsxs(y,{size:"sm",variant:"outline",onClick:()=>$e(t),"data-testid":`button-print-bill-${t.id}`,children:[e.jsx(Me,{className:"w-3 h-3 mr-1"}),"Print"]}),(((a=S==null?void 0:S.role)==null?void 0:a.name)==="manager"||((n=S==null?void 0:S.role)==null?void 0:n.name)==="owner")&&t.status==="final"&&e.jsxs(y,{size:"sm",variant:"outline",onClick:()=>{de(t),U(!0)},"data-testid":`button-amend-bill-${t.id}`,children:[e.jsx(Je,{className:"w-3 h-3 mr-1"}),"Amend"]})]})]},t.id)})})})]})]})]}),e.jsx(Xe,{open:Oe,onOpenChange:U,children:e.jsxs(Ye,{"data-testid":"dialog-amendment",children:[e.jsx(Ze,{children:e.jsx(et,{children:"Amend Bill"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(v,{children:"Bill Number"}),e.jsx(N,{value:(F==null?void 0:F.billNumber)||"",disabled:!0})]}),e.jsxs("div",{children:[e.jsx(v,{children:"Amendment Note (Required)"}),e.jsx(it,{placeholder:"Explain why this bill is being amended...",value:_,onChange:t=>re(t.target.value),rows:4,"data-testid":"textarea-amendment-note"})]})]}),e.jsxs(tt,{children:[e.jsx(y,{variant:"outline",onClick:()=>{U(!1),re(""),de(null)},"data-testid":"button-cancel-amendment",children:"Cancel"}),e.jsx(y,{onClick:Le,disabled:!_.trim()||Ce.isPending,"data-testid":"button-confirm-amendment",children:"Confirm Amendment"})]})]})})]})})}export{ft as default};
