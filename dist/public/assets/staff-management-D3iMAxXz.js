import{r as c,b as $,l as b,d as y,v as B,j as e,C as H,m as J,n as V,a as z,s as o,I as d,B as f}from"./index-CuDmVYun.js";import{D as G,h as W,T as X}from"./dashboard-layout-RBv1DXX2.js";import{D as Y}from"./data-table-B69p7Klv.js";import{S as Z,a as ee,b as se,c as ae,d as re}from"./select-7c0Tajxe.js";import{D as C,a as P,b as D,c as E}from"./dialog-CYNkLpdV.js";import{t as n}from"./index-hq1wgpuD.js";import{U as te}from"./users-DXv82DeH.js";import"./circle-alert-CPwmOhkC.js";import"./badge-DMaRL5Qw.js";import"./index-D12ZMnos.js";import"./index-dzpsPapz.js";function xe(){const[F,u]=c.useState(!1),[k,m]=c.useState(!1),[i,p]=c.useState(null),[h,x]=c.useState(""),[r,l]=c.useState({username:"",email:"",phone:"",fullName:"",address:"",password:"",role:""}),N=$(),{data:g=[],isLoading:R}=b({queryKey:["/api/hotels/current/users"],queryFn:async()=>{const s=await fetch("/api/hotels/current/users",{credentials:"include"});if(!s.ok)throw new Error("Failed to fetch staff");return s.json()},refetchInterval:3e3}),{data:O=[]}=b({queryKey:["/api/roles"],queryFn:async()=>{const s=await fetch("/api/roles",{credentials:"include"});if(!s.ok)throw new Error("Failed to fetch roles");return s.json()},refetchInterval:3e3}),{data:S=[]}=b({queryKey:["/api/attendance/daily"],refetchInterval:3e3}),T=["waiter","kitchen_staff","housekeeping_staff","security_guard","cashier","front_desk"],j=O.filter(s=>T.includes(s.name)),w=y({mutationFn:async s=>{const a=await fetch("/api/users",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(s)});if(!a.ok){const t=await a.json();throw new Error(t.message||"Failed to create staff member")}return a.json()},onSuccess:()=>{N.invalidateQueries({queryKey:["/api/hotels/current/users"]}),u(!1),l({username:"",email:"",phone:"",fullName:"",address:"",password:"",role:""}),n.success("Staff member created successfully")},onError:s=>{n.error(s.message||"Failed to create staff member")}}),A=y({mutationFn:async s=>{if(!(await fetch(`/api/users/${s}`,{method:"DELETE",credentials:"include"})).ok)throw new Error("Failed to delete staff member")},onSuccess:()=>{N.invalidateQueries({queryKey:["/api/hotels/current/users"]}),n.success("Staff member removed successfully")},onError:()=>{n.error("Failed to remove staff member")}}),v=y({mutationFn:async({targetUserId:s,newPassword:a})=>{const t=await fetch("/api/manager/reset-staff-password",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({targetUserId:s,newPassword:a})});if(!t.ok){const Q=await t.json();throw new Error(Q.message||"Failed to reset password")}return t.json()},onSuccess:s=>{m(!1),x(""),p(null),n.success(`Password reset successfully for ${s.username}`)},onError:s=>{n.error(s.message||"Failed to reset password")}}),I=()=>{if(!r.username||!r.password||!r.role||!r.phone||!r.fullName||!r.address){n.error("Please fill in all required fields (username, password, role, phone, full name, and address)");return}const s=j.find(a=>a.name===r.role);if(!s){n.error("Invalid role selected");return}w.mutate({...r,roleId:s.id,verification:{}})},{confirm:q}=B(),M=async s=>{await q({title:"Remove Staff Member",description:`Are you sure you want to remove ${s.username}? This action cannot be undone.`,confirmText:"Remove",cancelText:"Cancel",variant:"destructive",onConfirm:()=>{A.mutate(s.id)}})},U=s=>{p(s),m(!0)},L=()=>{if(!h||h.length<8){n.error("Password must be at least 8 characters");return}if(!i){n.error("No staff member selected");return}v.mutate({targetUserId:i.id,newPassword:h})},_=[{key:"username",label:"Username",sortable:!0},{key:"fullName",label:"Name",sortable:!0,render:(s,a)=>s||a.username||"-"},{key:"address",label:"Address",sortable:!0,render:s=>s||"-"},{key:"email",label:"Email",sortable:!0},{key:"phone",label:"Phone",sortable:!0},{key:"role",label:"Role",sortable:!0,render:s=>{var a;return((a=s==null?void 0:s.name)==null?void 0:a.replace(/_/g," ").replace(/\b\w/g,t=>t.toUpperCase()))||"Unknown"}},{key:"id",label:"Status",render:s=>{const a=S.some(t=>t.userId===s&&t.status==="active");return e.jsx("span",{className:`px-2 py-1 rounded-full text-xs ${a?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"}`,children:a?"On Duty":"Off Duty"})}},{key:"createdAt",label:"Hired",sortable:!0,render:s=>new Date(s).toLocaleDateString()}],K=[{label:"Reset Password",action:U,variant:"outline"},{label:"Remove",action:M,variant:"destructive",icon:e.jsx(X,{className:"h-4 w-4"})}];return e.jsx(G,{title:"Staff Management",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs(H,{children:[e.jsx(J,{children:e.jsxs(V,{className:"flex items-center gap-2",children:[e.jsx(te,{className:"h-6 w-6"}),"Staff Overview"]})}),e.jsx(z,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"text-center p-4 bg-blue-50 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:g.length}),e.jsx("div",{className:"text-sm text-blue-600",children:"Total Staff"})]}),e.jsxs("div",{className:"text-center p-4 bg-green-50 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:g.filter(s=>S.some(a=>a.userId===s.id&&a.status==="active")).length}),e.jsx("div",{className:"text-sm text-green-600",children:"On Duty Now"})]}),e.jsxs("div",{className:"text-center p-4 bg-orange-50 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-orange-600",children:j.length}),e.jsx("div",{className:"text-sm text-orange-600",children:"Available Roles"})]})]})})]}),e.jsx(Y,{title:"Staff Members",data:g,columns:_,actions:K,onAdd:()=>u(!0),addButtonLabel:"Add Staff Member",searchPlaceholder:"Search staff...",isLoading:R}),e.jsx(C,{open:F,onOpenChange:u,children:e.jsxs(P,{children:[e.jsx(D,{children:e.jsxs(E,{className:"flex items-center gap-2",children:[e.jsx(W,{className:"h-5 w-5"}),"Add New Staff Member"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(o,{htmlFor:"username",children:"Username *"}),e.jsx(d,{id:"username",value:r.username,onChange:s=>l(a=>({...a,username:s.target.value})),placeholder:"Enter username"})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:"email",children:"Email"}),e.jsx(d,{id:"email",type:"email",value:r.email,onChange:s=>l(a=>({...a,email:s.target.value})),placeholder:"Enter email"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(o,{htmlFor:"phone",children:"Phone *"}),e.jsx(d,{id:"phone",value:r.phone,onChange:s=>l(a=>({...a,phone:s.target.value})),placeholder:"Enter phone number",required:!0})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:"fullName",children:"Full Name *"}),e.jsx(d,{id:"fullName",value:r.fullName,onChange:s=>l(a=>({...a,fullName:s.target.value})),placeholder:"Enter full name",required:!0})]})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:"address",children:"Address *"}),e.jsx(d,{id:"address",value:r.address,onChange:s=>l(a=>({...a,address:s.target.value})),placeholder:"Enter address",required:!0})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:"password",children:"Password *"}),e.jsx(d,{id:"password",type:"password",value:r.password,onChange:s=>l(a=>({...a,password:s.target.value})),placeholder:"Enter password"})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:"role",children:"Role *"}),e.jsxs(Z,{value:r.role,onValueChange:s=>l(a=>({...a,role:s})),children:[e.jsx(ee,{children:e.jsx(se,{placeholder:"Select a role"})}),e.jsx(ae,{children:j.map(s=>e.jsx(re,{value:s.name,children:s.name.replace(/_/g," ").replace(/\b\w/g,a=>a.toUpperCase())},s.id))})]})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(f,{variant:"outline",onClick:()=>u(!1),children:"Cancel"}),e.jsx(f,{onClick:I,disabled:w.isPending,children:w.isPending?"Creating...":"Create Staff Member"})]})]})]})}),e.jsx(C,{open:k,onOpenChange:m,children:e.jsxs(P,{children:[e.jsx(D,{children:e.jsx(E,{children:"Reset Staff Password"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Reset password for ",e.jsx("span",{className:"font-semibold",children:i==null?void 0:i.username})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:"new-password",children:"New Password *"}),e.jsx(d,{id:"new-password",type:"password",value:h,onChange:s=>x(s.target.value),placeholder:"Enter new password (min 8 characters)","data-testid":"input-reset-password"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Password must be at least 8 characters long"})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(f,{variant:"outline",onClick:()=>{m(!1),x(""),p(null)},"data-testid":"button-cancel-reset",children:"Cancel"}),e.jsx(f,{onClick:L,disabled:v.isPending,"data-testid":"button-confirm-reset",children:v.isPending?"Resetting...":"Reset Password"})]})]})]})})]})})}export{xe as default};
