import{q as z,u as H,b as F,r as h,l as W,d as X,j as e,C as i,m as g,n as v,a as l,p as f,s as $,B as y,k as G}from"./index-CuDmVYun.js";import{D as J,T as Y,o as P,q as Q}from"./dashboard-layout-RBv1DXX2.js";import{B as Z}from"./badge-DMaRL5Qw.js";import{T as ee}from"./textarea-CpuNoaOI.js";import{D as se,a as te,b as re,c as ae}from"./dialog-CYNkLpdV.js";import{T as ne,a as ie,b as q,c as D}from"./tabs-CX8s-N0D.js";import"./users-DXv82DeH.js";import"./circle-alert-CPwmOhkC.js";import"./index-D12ZMnos.js";function he(){z();const{toast:N}=H(),I=F(),[a,R]=h.useState(null),[w,d]=h.useState(!1),[u,b]=h.useState(""),[n,k]=h.useState(!0),{data:E=[]}=W({queryKey:["/api/hotels/current/wastages"],refetchInterval:5e3}),{data:S=[]}=W({queryKey:["/api/hotels/current/inventory-items"]}),{data:C=[]}=W({queryKey:["/api/hotels/current/users"]}),T=E.filter(s=>{var r;const t=C.find(c=>c.id===s.recordedBy);return t&&["barista","bartender","kitchen_staff","waiter","cashier"].includes(((r=t.role)==null?void 0:r.name)||"")}),o=T.filter(s=>s.status==="pending_approval"),p=T.filter(s=>s.status==="approved"),x=T.filter(s=>s.status==="rejected"),A=X({mutationFn:async({id:s,approved:t,rejectionReason:r})=>await G("POST",`/api/wastages/${s}/approve`,{approved:t,rejectionReason:r}),onSuccess:()=>{I.invalidateQueries({queryKey:["/api/hotels/current/wastages"]}),I.invalidateQueries({queryKey:["/api/hotels/current/inventory-items"]}),N({title:n?"Wastage approved successfully":"Wastage rejected"}),d(!1),R(null),b("")},onError:s=>{N({title:"Error",description:s.message,variant:"destructive"})}}),U=s=>{const t=S.find(r=>r.id===s);return(t==null?void 0:t.name)||"Unknown Item"},V=s=>{const t=S.find(r=>r.id===s);return(t==null?void 0:t.baseUnit)||(t==null?void 0:t.unit)||"unit"},j=s=>{const t=C.find(r=>r.id===s);return(t==null?void 0:t.username)||"Unknown User"},K=s=>{var r,c;const t=C.find(m=>m.id===s);return((c=(r=t==null?void 0:t.role)==null?void 0:r.name)==null?void 0:c.replace(/_/g," ").replace(/\b\w/g,m=>m.toUpperCase()))||"Unknown"},_=s=>{R(s),k(!0),d(!0)},L=s=>{R(s),k(!1),d(!0)},O=()=>{if(!n&&(!u||u.trim().length<10)){N({title:"Rejection reason required",description:"Please provide a detailed reason (minimum 10 characters)",variant:"destructive"});return}A.mutate({id:a.id,approved:n,rejectionReason:n?null:u.trim()})},B=s=>{const t=U(s.itemId),r=V(s.itemId),c=j(s.recordedBy),m=K(s.recordedBy),M=s.estimatedValue||0;return e.jsxs(i,{className:"mb-4",children:[e.jsx(g,{children:e.jsxs(v,{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-base",children:t}),e.jsx(Z,{variant:s.status==="approved"?"default":s.status==="rejected"?"destructive":"secondary",children:s.status.replace("_"," ").toUpperCase()})]})}),e.jsxs(l,{children:[e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Recorded by:"})," ",c," (",m,")"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Quantity:"})," ",s.qty," ",s.unit||r]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Estimated Value:"})," ",f(M)]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Reason:"})," ",s.reason]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Date:"})," ",new Date(s.createdAt).toLocaleString()]}),s.approvedBy&&e.jsxs("p",{children:[e.jsx("strong",{children:"Approved by:"})," ",j(s.approvedBy)]}),s.rejectedBy&&e.jsxs("p",{children:[e.jsx("strong",{children:"Rejected by:"})," ",j(s.rejectedBy)]}),s.rejectionReason&&e.jsxs("p",{className:"text-red-600",children:[e.jsx("strong",{children:"Rejection Reason:"})," ",s.rejectionReason]})]}),s.status==="pending_approval"&&e.jsxs("div",{className:"flex gap-2 mt-4",children:[e.jsxs(y,{size:"sm",onClick:()=>_(s),className:"flex-1",children:[e.jsx(P,{className:"w-4 h-4 mr-1"})," Approve"]}),e.jsxs(y,{size:"sm",variant:"destructive",onClick:()=>L(s),className:"flex-1",children:[e.jsx(Q,{className:"w-4 h-4 mr-1"})," Reject"]})]})]})]},s.id)};return e.jsx(J,{title:"Staff Wastage Management",children:e.jsxs("div",{className:"space-y-6 p-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs(i,{children:[e.jsx(g,{children:e.jsxs(v,{className:"flex items-center",children:[e.jsx(Y,{className:"w-5 h-5 mr-2 text-yellow-500"}),"Pending Approval"]})}),e.jsxs(l,{children:[e.jsx("div",{className:"text-3xl font-bold text-yellow-600",children:o.length}),e.jsxs("div",{className:"text-sm text-muted-foreground mt-1",children:["Total Value: ",f(o.reduce((s,t)=>s+(t.estimatedValue||0),0))]})]})]}),e.jsxs(i,{children:[e.jsx(g,{children:e.jsxs(v,{className:"flex items-center",children:[e.jsx(P,{className:"w-5 h-5 mr-2 text-green-500"}),"Approved"]})}),e.jsxs(l,{children:[e.jsx("div",{className:"text-3xl font-bold text-green-600",children:p.length}),e.jsxs("div",{className:"text-sm text-muted-foreground mt-1",children:["Total Value: ",f(p.reduce((s,t)=>s+(t.estimatedValue||0),0))]})]})]}),e.jsxs(i,{children:[e.jsx(g,{children:e.jsxs(v,{className:"flex items-center",children:[e.jsx(Q,{className:"w-5 h-5 mr-2 text-red-500"}),"Rejected"]})}),e.jsxs(l,{children:[e.jsx("div",{className:"text-3xl font-bold text-red-600",children:x.length}),e.jsxs("div",{className:"text-sm text-muted-foreground mt-1",children:["Total Value: ",f(x.reduce((s,t)=>s+(t.estimatedValue||0),0))]})]})]})]}),e.jsxs(ne,{defaultValue:"pending",className:"space-y-4",children:[e.jsxs(ie,{className:"grid w-full grid-cols-3 max-w-md",children:[e.jsxs(q,{value:"pending",children:["Pending (",o.length,")"]}),e.jsxs(q,{value:"approved",children:["Approved (",p.length,")"]}),e.jsxs(q,{value:"rejected",children:["Rejected (",x.length,")"]})]}),e.jsx(D,{value:"pending",className:"space-y-4",children:o.length===0?e.jsx(i,{children:e.jsx(l,{className:"py-8 text-center text-muted-foreground",children:"No pending wastage approvals"})}):o.map(B)}),e.jsx(D,{value:"approved",className:"space-y-4",children:p.length===0?e.jsx(i,{children:e.jsx(l,{className:"py-8 text-center text-muted-foreground",children:"No approved wastages"})}):p.map(B)}),e.jsx(D,{value:"rejected",className:"space-y-4",children:x.length===0?e.jsx(i,{children:e.jsx(l,{className:"py-8 text-center text-muted-foreground",children:"No rejected wastages"})}):x.map(B)})]}),e.jsx(se,{open:w,onOpenChange:d,children:e.jsxs(te,{children:[e.jsx(re,{children:e.jsx(ae,{children:n?"Approve Wastage":"Reject Wastage"})}),a&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"text-sm",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Item:"})," ",U(a.itemId)]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Quantity:"})," ",a.qty," ",a.unit||V(a.itemId)]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Reported by:"})," ",j(a.recordedBy)]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Reason:"})," ",a.reason]})]}),!n&&e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{children:"Rejection Reason *"}),e.jsx(ee,{value:u,onChange:s=>b(s.target.value),placeholder:"Provide a detailed reason for rejecting this wastage report (minimum 10 characters)",rows:4})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(y,{variant:"outline",onClick:()=>{d(!1),b("")},className:"flex-1",children:"Cancel"}),e.jsx(y,{onClick:O,disabled:A.isPending,className:"flex-1",variant:n?"default":"destructive",children:A.isPending?"Processing...":n?"Approve":"Reject"})]})]})]})})]})})}export{he as default};
