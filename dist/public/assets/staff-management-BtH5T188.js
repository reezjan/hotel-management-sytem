import{q as L,u as O,v as P,b as M,r as T,c as K,l as x,d as b,j as e,F as R,e as n,f as o,g as i,h as l,I as d,B as g,z as r,t as H}from"./index-CuDmVYun.js";import{D as B}from"./dashboard-layout-RBv1DXX2.js";import{D as Q}from"./data-table-B69p7Klv.js";import{D as U,a as _,b as $,c as z}from"./dialog-CYNkLpdV.js";import"./users-DXv82DeH.js";import"./circle-alert-CPwmOhkC.js";import"./badge-DMaRL5Qw.js";const G=r.object({username:r.string().min(3,"Username must be at least 3 characters"),email:r.string().email("Invalid email address").optional().or(r.literal("")),phone:r.string().min(10,"Phone number must be at least 10 characters"),fullName:r.string().min(2,"Full name is required"),address:r.string().min(5,"Address is required"),password:r.string().min(6,"Password must be at least 6 characters")});function te(){const{user:h}=L(),{toast:c}=O(),{confirm:v}=P(),j=M(),[S,u]=T.useState(!1),a=K({resolver:H(G),defaultValues:{username:"",email:"",phone:"",fullName:"",address:"",password:""}}),{data:w=[],isLoading:k}=x({queryKey:["/api/hotels/current/users"],refetchInterval:3e3,queryFn:async()=>{const t=await fetch("/api/hotels/current/users",{credentials:"include"});if(!t.ok)throw new Error("Failed to fetch staff");return t.json()}}),{data:D=[],isLoading:y}=x({queryKey:["/api/roles"],refetchInterval:3e3,queryFn:async()=>{const t=await fetch("/api/roles",{credentials:"include"});if(!t.ok)throw new Error("Failed to fetch roles");return t.json()}}),{data:F=[]}=x({queryKey:["/api/attendance/daily"],refetchInterval:3e3}),C=w.filter(t=>{var s;return((s=t.role)==null?void 0:s.name)==="housekeeping_staff"}),m=D.find(t=>t.name==="housekeeping_staff"),p=b({mutationFn:async t=>{const s=await fetch("/api/users",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(t)});if(!s.ok){const f=await s.json();throw new Error(f.message||"Failed to create staff member")}return s.json()},onSuccess:()=>{j.invalidateQueries({queryKey:["/api/hotels/current/users"]}),u(!1),a.reset(),c({title:"Staff member created successfully"})},onError:t=>{c({title:t.message,variant:"destructive"})}}),A=b({mutationFn:async t=>{const s=await fetch(`/api/users/${t}`,{method:"DELETE",credentials:"include"});if(!s.ok)throw new Error("Failed to delete staff member");return s.json()},onSuccess:()=>{j.invalidateQueries({queryKey:["/api/hotels/current/users"]}),c({title:"Staff member removed successfully"})},onError:t=>{c({title:t.message,variant:"destructive"})}}),E=t=>{if(!m){c({title:"Housekeeping staff role not found",variant:"destructive"});return}p.mutate({...t,roleId:m.id,hotelId:h==null?void 0:h.hotelId})},N=async t=>{await v({title:"Remove Staff Member",description:"Are you sure you want to remove this staff member?",confirmText:"Remove",cancelText:"Cancel",variant:"destructive",onConfirm:()=>{A.mutate(t)}})},I=[{key:"fullName",label:"Name",sortable:!0},{key:"username",label:"Username",sortable:!0},{key:"address",label:"Address",sortable:!0},{key:"phone",label:"Phone",sortable:!0},{key:"email",label:"Email",sortable:!0},{key:"id",label:"Status",render:t=>{const s=F.some(f=>f.userId===t&&f.status==="active");return e.jsx("span",{className:`px-2 py-1 rounded-full text-xs ${s?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"}`,children:s?"On Duty":"Off Duty"})}},{key:"lastLogin",label:"Last Active",sortable:!0,render:t=>t?new Date(t).toLocaleString("en-GB",{timeZone:"Asia/Kathmandu"}):"Never"}],q=[{label:"Remove",action:t=>N(t.id),variant:"destructive"}];return e.jsxs(B,{title:"Housekeeping Staff Management",children:[e.jsx(Q,{title:"Housekeeping Staff",data:C,columns:I,actions:q,onAdd:()=>u(!0),addButtonLabel:"Add Staff Member",searchPlaceholder:"Search staff...",isLoading:k}),e.jsx(U,{open:S,onOpenChange:u,children:e.jsxs(_,{children:[e.jsx($,{children:e.jsx(z,{children:"Add New Staff Member"})}),e.jsx(R,{...a,children:e.jsxs("form",{onSubmit:a.handleSubmit(E),className:"space-y-4",children:[e.jsx(n,{control:a.control,name:"username",render:({field:t})=>e.jsxs(o,{children:[e.jsx(i,{children:"Username"}),e.jsx(l,{children:e.jsx(d,{...t,"data-testid":"input-username"})})]})}),e.jsx(n,{control:a.control,name:"phone",render:({field:t})=>e.jsxs(o,{children:[e.jsx(i,{children:"Phone *"}),e.jsx(l,{children:e.jsx(d,{...t,"data-testid":"input-phone"})})]})}),e.jsx(n,{control:a.control,name:"fullName",render:({field:t})=>e.jsxs(o,{children:[e.jsx(i,{children:"Full Name *"}),e.jsx(l,{children:e.jsx(d,{...t,"data-testid":"input-fullname"})})]})}),e.jsx(n,{control:a.control,name:"address",render:({field:t})=>e.jsxs(o,{children:[e.jsx(i,{children:"Address *"}),e.jsx(l,{children:e.jsx(d,{...t,"data-testid":"input-address"})})]})}),e.jsx(n,{control:a.control,name:"email",render:({field:t})=>e.jsxs(o,{children:[e.jsx(i,{children:"Email (Optional)"}),e.jsx(l,{children:e.jsx(d,{...t,type:"email","data-testid":"input-email"})})]})}),e.jsx(n,{control:a.control,name:"password",render:({field:t})=>e.jsxs(o,{children:[e.jsx(i,{children:"Password"}),e.jsx(l,{children:e.jsx(d,{...t,type:"password","data-testid":"input-password"})})]})}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(g,{type:"button",variant:"outline",onClick:()=>u(!1),"data-testid":"button-cancel",children:"Cancel"}),e.jsx(g,{type:"submit",disabled:p.isPending||y||!m,"data-testid":"button-submit",children:p.isPending?"Creating...":y?"Loading...":m?"Create Staff":"Role Not Found"})]})]})})]})})]})}export{te as default};
