import{u as le,q as ie,b as oe,r as N,l as D,c as U,d as w,v as ce,j as e,C as de,m as me,n as ue,a as he,F as L,e as t,f as n,g as l,h as i,I as u,i as o,B as C,L as _,z as x,t as xe,k as fe}from"./index-Dk6nXF67.js";import{D as je,U as pe,h as ge,i as be}from"./dashboard-layout-BUO8e75G.js";import{D as ye}from"./data-table-BEvwFoVx.js";import{S as E}from"./stats-card-DnI6mJO0.js";import{B as ve}from"./badge-P46XOlcm.js";import{S as K,a as B,b as $,c as Q,d as V}from"./select-Gj2YppMn.js";import{D as H,a as J,b as z,c as W}from"./dialog-mWSLCdZX.js";import{u as X}from"./use-realtime-query-2TJdEol3.js";import{U as T}from"./users-Dxbor6Q1.js";import"./circle-alert-BbQxKC8I.js";import"./index-CC2mel_A.js";import"./index-D-DdYU4C.js";import"./use-websocket-ChOW8gRL.js";const Se=x.object({username:x.string().min(3,"Username must be at least 3 characters").max(50,"Username must be less than 50 characters"),email:x.string().email("Please enter a valid email address"),firstName:x.string().min(1,"First name is required").max(50,"First name must be less than 50 characters"),lastName:x.string().min(1,"Last name is required").max(50,"Last name must be less than 50 characters"),phone:x.string().min(1,"Phone number is required").max(20,"Phone number must be less than 20 characters"),address:x.string().optional(),role:x.string().min(1,"Role is required"),password:x.string().min(6,"Password must be at least 6 characters"),confirmPassword:x.string().min(6,"Password confirmation is required")}).refine(h=>h.password===h.confirmPassword,{message:"Passwords don't match",path:["confirmPassword"]}),Ne=[{value:"manager",label:"Manager"},{value:"housekeeping_supervisor",label:"Housekeeping Supervisor"},{value:"restaurant_bar_manager",label:"Restaurant & Bar Manager"},{value:"security_head",label:"Security Head"},{value:"finance",label:"Finance"}];function Re(){const{toast:h}=le(),{user:P}=ie(),p=oe(),[G,g]=N.useState(!1),[F,b]=N.useState(!1),[c,M]=N.useState(null),{data:j=[]}=D({queryKey:["/api/hotels/current/users"],refetchInterval:3e3}),{data:q=[]}=D({queryKey:["/api/roles"],refetchInterval:3e3}),{data:k=[]}=D({queryKey:["/api/attendance/daily"],refetchInterval:3e3});X({queryKey:["/api/hotels/current/users"],refetchInterval:3e3,events:["user:created","user:updated"]}),X({queryKey:["/api/attendance/daily"],refetchInterval:3e3,events:["attendance:updated"]});const d=U({resolver:xe(Se),defaultValues:{username:"",email:"",firstName:"",lastName:"",phone:"",address:"",role:"",password:"",confirmPassword:""}}),m=U({defaultValues:{username:"",email:"",firstName:"",lastName:"",phone:"",address:"",role:""}});N.useEffect(()=>{var s;c&&F&&m.reset({username:c.username||"",email:c.email||"",firstName:c.firstName||"",lastName:c.lastName||"",phone:c.phone||"",address:c.address||"",role:((s=c.role)==null?void 0:s.name)||""})},[c,F,m]);const y=w({mutationFn:async s=>{const{confirmPassword:a,...r}=s;return await(await fe("POST","/api/users",r)).json()},onSuccess:()=>{p.invalidateQueries({queryKey:["/api/hotels/current/users"]}),h({title:"Staff Member Created Successfully",description:"The new staff account has been created and can now access the system."}),d.reset(),g(!1)},onError:s=>{h({title:"Failed to Create Staff Member",description:s.message||"Please check your input and try again.",variant:"destructive"})}}),Y=w({mutationFn:async s=>{const a=await fetch(`/api/users/${s}`,{method:"DELETE",credentials:"include"});if(!a.ok){const r=await a.json().catch(()=>({message:"Failed to delete staff member"}));throw new Error(r.message)}return a.status===204?null:a.json()},onSuccess:()=>{p.invalidateQueries({queryKey:["/api/hotels/current/users"]}),h({title:"Success",description:"Staff member removed successfully"})},onError:s=>{h({title:"Error",description:s.message||"Failed to remove staff member",variant:"destructive"})}}),Z=w({mutationFn:async({userId:s,isActive:a})=>{const r=await fetch(`/api/users/${s}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({isActive:a})});if(!r.ok)throw new Error("Failed to toggle status");return r.json()},onSuccess:()=>{p.invalidateQueries({queryKey:["/api/hotels/current/users"]}),h({title:"Success",description:"Staff status updated successfully"})},onError:()=>{h({title:"Error",description:"Failed to update staff status",variant:"destructive"})}}),v=w({mutationFn:async s=>{const a=q.find(I=>I.name===s.role);if(!a)throw new Error("Invalid role selected");const{role:r,...f}=s,S={...f,roleId:a.id,hotelId:P==null?void 0:P.hotelId},A=await fetch(`/api/users/${c==null?void 0:c.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(S)});if(!A.ok){const I=await A.json();throw new Error(I.message||"Failed to update staff member")}return A.json()},onSuccess:()=>{p.invalidateQueries({queryKey:["/api/hotels/current/users"]}),h({title:"Success",description:"Staff member updated successfully"}),m.reset(),b(!1),M(null)},onError:s=>{h({title:"Error",description:s.message||"Failed to update staff member",variant:"destructive"})}}),O=j.length,R=j.filter(s=>k.some(a=>a.userId===s.id&&a.status==="active")).length,ee=O-R,se=j.filter(s=>s.isActive).length,ae=j.reduce((s,a)=>{var f;const r=((f=a.role)==null?void 0:f.name)||"unknown";return s[r]||(s[r]=[]),s[r].push(a),s},{}),re=[{key:"username",label:"Username",sortable:!0},{key:"fullName",label:"Name",sortable:!0,render:(s,a)=>s||(a.firstName||a.lastName)&&`${a.firstName||""} ${a.lastName||""}`.trim()||"-"},{key:"role",label:"Role",sortable:!0,render:s=>{var a;return e.jsx(ve,{variant:"outline",children:((a=s==null?void 0:s.name)==null?void 0:a.replace(/_/g," ").replace(/\b\w/g,r=>r.toUpperCase()))||"No Role"})}},{key:"address",label:"Address",sortable:!0,render:s=>s||"-"},{key:"email",label:"Email",sortable:!0},{key:"phone",label:"Phone",sortable:!0},{key:"id",label:"Status",render:s=>{const a=k.some(r=>r.userId===s&&r.status==="active");return e.jsx("span",{className:`px-2 py-1 rounded-full text-xs ${a?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"}`,children:a?"On Duty":"Off Duty"})}},{key:"isActive",label:"Active",render:s=>e.jsx("span",{className:`px-2 py-1 rounded-full text-xs ${s?"bg-blue-100 text-blue-800":"bg-red-100 text-red-800"}`,children:s?"Active":"Inactive"})},{key:"createdAt",label:"Joined",sortable:!0,render:s=>new Date(s).toLocaleDateString()}],{confirm:te}=ce(),ne=[{label:"Edit",action:s=>{M(s),b(!0)}},{label:"Toggle Status",action:s=>{const a=!s.isActive;Z.mutate({userId:s.id,isActive:a})}},{label:"Remove",action:async s=>{await te({title:"Remove Staff Member",description:`Are you sure you want to remove ${s.username}? This action cannot be undone.`,confirmText:"Remove",cancelText:"Cancel",variant:"destructive",onConfirm:()=>{Y.mutate(s.id)}})},variant:"destructive"}];return e.jsx(je,{title:"Staff Management",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsx(E,{title:"Total Staff",value:O,icon:e.jsx(T,{}),iconColor:"text-blue-500"}),e.jsx(E,{title:"Online Staff",value:R,icon:e.jsx(pe,{}),iconColor:"text-green-500"}),e.jsx(E,{title:"Offline Staff",value:ee,icon:e.jsx(ge,{}),iconColor:"text-gray-500"}),e.jsx(E,{title:"Active Staff",value:se,icon:e.jsx(be,{}),iconColor:"text-purple-500"})]}),e.jsxs(de,{children:[e.jsx(me,{children:e.jsx(ue,{children:"Staff Distribution by Role"})}),e.jsx(he,{children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:Object.entries(ae).map(([s,a])=>{const r=a;return e.jsxs("div",{className:"p-4 border rounded-lg",children:[e.jsx("h3",{className:"font-medium text-lg capitalize",children:s.replace(/_/g," ")}),e.jsxs("div",{className:"mt-2 space-y-1",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:r.length}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[r.filter(f=>k.some(S=>S.userId===f.id&&S.status==="active")).length," on duty"]})]})]},s)})})})]}),e.jsx(ye,{title:"All Staff Members",data:j,columns:re,actions:ne,onAdd:()=>g(!0),addButtonLabel:"Add Staff Member",searchPlaceholder:"Search staff..."}),e.jsx(H,{open:G,onOpenChange:g,children:e.jsxs(J,{className:"sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(z,{children:e.jsxs(W,{className:"flex items-center space-x-2",children:[e.jsx(T,{className:"h-5 w-5 text-blue-500"}),e.jsx("span",{children:"Create New Staff Member"})]})}),e.jsx(L,{...d,children:e.jsxs("form",{onSubmit:d.handleSubmit(s=>y.mutate(s)),className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(t,{control:d.control,name:"firstName",render:({field:s})=>e.jsxs(n,{children:[e.jsx(l,{children:"First Name *"}),e.jsx(i,{children:e.jsx(u,{placeholder:"Enter first name",...s})}),e.jsx(o,{})]})}),e.jsx(t,{control:d.control,name:"lastName",render:({field:s})=>e.jsxs(n,{children:[e.jsx(l,{children:"Last Name *"}),e.jsx(i,{children:e.jsx(u,{placeholder:"Enter last name",...s})}),e.jsx(o,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(t,{control:d.control,name:"username",render:({field:s})=>e.jsxs(n,{children:[e.jsx(l,{children:"Username *"}),e.jsx(i,{children:e.jsx(u,{placeholder:"Enter username",...s})}),e.jsx(o,{})]})}),e.jsx(t,{control:d.control,name:"email",render:({field:s})=>e.jsxs(n,{children:[e.jsx(l,{children:"Email *"}),e.jsx(i,{children:e.jsx(u,{type:"email",placeholder:"staff@example.com",...s})}),e.jsx(o,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(t,{control:d.control,name:"phone",render:({field:s})=>e.jsxs(n,{children:[e.jsx(l,{children:"Phone Number *"}),e.jsx(i,{children:e.jsx(u,{placeholder:"Phone number",...s})}),e.jsx(o,{})]})}),e.jsx(t,{control:d.control,name:"role",render:({field:s})=>e.jsxs(n,{children:[e.jsx(l,{children:"Role *"}),e.jsxs(K,{onValueChange:s.onChange,defaultValue:s.value,children:[e.jsx(i,{children:e.jsx(B,{children:e.jsx($,{placeholder:"Select a role"})})}),e.jsx(Q,{children:Ne.map(a=>e.jsx(V,{value:a.value,children:a.label},a.value))})]}),e.jsx(o,{})]})})]}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("h3",{className:"text-sm font-medium text-foreground mb-3",children:"Account Security"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(t,{control:d.control,name:"password",render:({field:s})=>e.jsxs(n,{children:[e.jsx(l,{children:"Password *"}),e.jsx(i,{children:e.jsx(u,{type:"password",placeholder:"Enter password",...s})}),e.jsx(o,{})]})}),e.jsx(t,{control:d.control,name:"confirmPassword",render:({field:s})=>e.jsxs(n,{children:[e.jsx(l,{children:"Confirm Password *"}),e.jsx(i,{children:e.jsx(u,{type:"password",placeholder:"Confirm password",...s})}),e.jsx(o,{})]})})]})]}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-4",children:[e.jsx(C,{type:"button",variant:"outline",onClick:()=>{d.reset(),g(!1)},disabled:y.isPending,children:"Cancel"}),e.jsxs(C,{type:"submit",disabled:y.isPending,children:[y.isPending&&e.jsx(_,{className:"mr-2 h-4 w-4 animate-spin"}),"Create Staff Member"]})]})]})})]})}),e.jsx(H,{open:F,onOpenChange:b,children:e.jsxs(J,{className:"sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(z,{children:e.jsxs(W,{className:"flex items-center space-x-2",children:[e.jsx(T,{className:"h-5 w-5 text-blue-500"}),e.jsx("span",{children:"Edit Staff Member"})]})}),e.jsx(L,{...m,children:e.jsxs("form",{onSubmit:m.handleSubmit(s=>v.mutate(s)),className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(t,{control:m.control,name:"firstName",render:({field:s})=>e.jsxs(n,{children:[e.jsx(l,{children:"First Name *"}),e.jsx(i,{children:e.jsx(u,{placeholder:"Enter first name",...s})}),e.jsx(o,{})]})}),e.jsx(t,{control:m.control,name:"lastName",render:({field:s})=>e.jsxs(n,{children:[e.jsx(l,{children:"Last Name *"}),e.jsx(i,{children:e.jsx(u,{placeholder:"Enter last name",...s})}),e.jsx(o,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(t,{control:m.control,name:"username",render:({field:s})=>e.jsxs(n,{children:[e.jsx(l,{children:"Username *"}),e.jsx(i,{children:e.jsx(u,{placeholder:"Enter username",...s})}),e.jsx(o,{})]})}),e.jsx(t,{control:m.control,name:"email",render:({field:s})=>e.jsxs(n,{children:[e.jsx(l,{children:"Email *"}),e.jsx(i,{children:e.jsx(u,{type:"email",placeholder:"staff@example.com",...s})}),e.jsx(o,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(t,{control:m.control,name:"phone",render:({field:s})=>e.jsxs(n,{children:[e.jsx(l,{children:"Phone Number *"}),e.jsx(i,{children:e.jsx(u,{placeholder:"Phone number",...s})}),e.jsx(o,{})]})}),e.jsx(t,{control:m.control,name:"role",render:({field:s})=>e.jsxs(n,{children:[e.jsx(l,{children:"Role *"}),e.jsxs(K,{onValueChange:s.onChange,value:s.value,children:[e.jsx(i,{children:e.jsx(B,{children:e.jsx($,{placeholder:"Select a role"})})}),e.jsx(Q,{children:q.filter(a=>a.name!=="super_admin"&&a.name!=="owner").map(a=>e.jsx(V,{value:a.name,children:a.name.split("_").map(r=>r.charAt(0).toUpperCase()+r.slice(1)).join(" ")},a.id))})]}),e.jsx(o,{})]})})]}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-4",children:[e.jsx(C,{type:"button",variant:"outline",onClick:()=>{m.reset(),b(!1),M(null)},disabled:v.isPending,children:"Cancel"}),e.jsxs(C,{type:"submit",disabled:v.isPending,children:[v.isPending&&e.jsx(_,{className:"mr-2 h-4 w-4 animate-spin"}),"Update Staff Member"]})]})]})})]})})]})})}export{Re as default};
