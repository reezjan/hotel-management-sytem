import{q as L,u as W,r as P,l as F,c as T,d as S,j as e,B as u,C as y,a as f,p as N,m as U,n as G,ax as J,F as V,e as a,f as c,g as l,h as i,I as m,k as I,A as O}from"./index-Dk6nXF67.js";import{D as X,a as Y,a1 as Z,n as ee}from"./dashboard-layout-BUO8e75G.js";import{D,a as R,b as B,c as A}from"./dialog-mWSLCdZX.js";import{S as q,a as w,b as C,c as k,d as r}from"./select-Gj2YppMn.js";import{T as se}from"./textarea-BAi4nzW_.js";import{u as ne}from"./use-realtime-query-2TJdEol3.js";import{b as te,d as re}from"./users-Dxbor6Q1.js";import"./circle-alert-BbQxKC8I.js";import"./index-CC2mel_A.js";import"./index-D-DdYU4C.js";import"./use-websocket-ChOW8gRL.js";function je(){const{user:n}=L(),{toast:p}=W(),[_,b]=P.useState(!1),[K,j]=P.useState(!1),{data:Q=[]}=F({queryKey:["/api/hotels/current/transactions"],refetchInterval:3e3,enabled:!!(n!=null&&n.hotelId)});ne({queryKey:["/api/hotels/current/transactions"],refetchInterval:3e3,events:["transaction:created","transaction:updated"]}),F({queryKey:["/api/hotels/current/vendors"],refetchInterval:3e3,enabled:!!(n!=null&&n.hotelId)});const o=T({defaultValues:{vendorName:"",amount:"",paymentMethod:"cash",chequeNumber:"",bankName:"",reference:""}}),d=T({defaultValues:{category:"utilities",amount:"",paymentMethod:"cash",chequeNumber:"",bankName:"",description:""}}),v=S({mutationFn:async s=>{const t=parseFloat(s.amount);if(isNaN(t)||t<=0)throw new Error("Please enter a valid amount");if(s.paymentMethod==="cheque"){if(!s.chequeNumber||s.chequeNumber.trim()==="")throw new Error("Cheque number is required");if(!s.bankName||s.bankName.trim()==="")throw new Error("Bank name is required for cheque payment")}const x={vendorName:s.vendorName,notes:s.reference||""};s.paymentMethod==="cheque"&&(x.chequeNumber=s.chequeNumber.trim(),x.bankName=s.bankName.trim()),await I("POST","/api/transactions",{hotelId:n==null?void 0:n.hotelId,txnType:"vendor_payment",amount:t.toFixed(2),paymentMethod:s.paymentMethod,purpose:`Vendor Payment - ${s.vendorName}`,reference:s.reference,details:x,createdBy:n==null?void 0:n.id})},onSuccess:()=>{O.invalidateQueries({queryKey:["/api/hotels/current/transactions"]}),p({title:"Vendor payment recorded successfully"}),o.reset(),b(!1)},onError:s=>{p({title:"Error",description:s.message||"Failed to process vendor payment",variant:"destructive"})}}),g=S({mutationFn:async s=>{const t=parseFloat(s.amount);if(isNaN(t)||t<=0)throw new Error("Please enter a valid amount");if(s.paymentMethod==="cheque"){if(!s.chequeNumber||s.chequeNumber.trim()==="")throw new Error("Cheque number is required");if(!s.bankName||s.bankName.trim()==="")throw new Error("Bank name is required for cheque payment")}const x={};s.paymentMethod==="cheque"&&(x.chequeNumber=s.chequeNumber.trim(),x.bankName=s.bankName.trim()),await I("POST","/api/transactions",{hotelId:n==null?void 0:n.hotelId,txnType:"cash_out",amount:t.toFixed(2),paymentMethod:s.paymentMethod,purpose:`${s.category} - ${s.description}`,reference:s.category,details:x,createdBy:n==null?void 0:n.id})},onSuccess:()=>{O.invalidateQueries({queryKey:["/api/hotels/current/transactions"]}),p({title:"Expense recorded successfully"}),d.reset(),j(!1)},onError:s=>{p({title:"Error",description:s.message||"Failed to record expense",variant:"destructive"})}}),h=Q.filter(s=>{var t;return s.txnType==="cash_out"||s.txnType==="vendor_payment"||((t=s.txnType)==null?void 0:t.includes("_out"))}),$=h.reduce((s,t)=>s+Number(t.amount||0),0),E=h.filter(s=>s.txnType==="vendor_payment"),M=h.filter(s=>s.txnType!=="vendor_payment"),z=E.reduce((s,t)=>s+Number(t.amount||0),0),H=M.reduce((s,t)=>s+Number(t.amount||0),0);return e.jsx(X,{title:"Expense Tracking",children:e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex justify-end",children:e.jsxs(u,{onClick:()=>j(!0),"data-testid":"button-add-expense",className:"gap-2",children:[e.jsx(Y,{className:"h-4 w-4"}),"Add Expense"]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsx(y,{className:"bg-gradient-to-r from-red-500 to-pink-600 text-white",children:e.jsx(f,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm opacity-90",children:"Total Expenses"}),e.jsx("p",{className:"text-3xl font-bold mt-2",children:N($)}),e.jsxs("p",{className:"text-sm opacity-90 mt-1",children:[h.length," transactions"]})]}),e.jsx(te,{className:"h-12 w-12 opacity-50"})]})})}),e.jsx(y,{children:e.jsx(f,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Vendor Payments"}),e.jsx("p",{className:"text-2xl font-bold text-red-600",children:N(z)}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[E.length," payments"]})]}),e.jsx(Z,{className:"h-8 w-8 text-red-500"})]})})}),e.jsx(y,{children:e.jsx(f,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Other Expenses"}),e.jsx("p",{className:"text-2xl font-bold text-orange-600",children:N(H)}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[M.length," expenses"]})]}),e.jsx(ee,{className:"h-8 w-8 text-orange-500"})]})})})]}),e.jsxs(y,{children:[e.jsx(U,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(G,{children:"Recent Expenses"}),e.jsxs(u,{variant:"outline",size:"sm",children:[e.jsx(re,{className:"h-4 w-4 mr-2"}),"Export"]})]})}),e.jsx(f,{children:e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-muted",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium",children:"Date"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium",children:"Type"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium",children:"Amount"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium",children:"Payment Method"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium",children:"Purpose"})]})}),e.jsx("tbody",{children:h.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"px-4 py-8 text-center text-muted-foreground",children:"No expenses recorded yet"})}):h.slice(0,20).map(s=>e.jsxs("tr",{className:"border-t hover:bg-muted/50",children:[e.jsx("td",{className:"px-4 py-3 text-sm",children:J(s.createdAt)}),e.jsx("td",{className:"px-4 py-3 text-sm",children:e.jsx("span",{className:"inline-block px-2 py-1 rounded text-xs bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400",children:s.txnType})}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-red-600",children:N(Number(s.amount))}),e.jsx("td",{className:"px-4 py-3 text-sm capitalize",children:s.paymentMethod}),e.jsx("td",{className:"px-4 py-3 text-sm",children:s.purpose||"-"})]},s.id))})]})})})})]}),e.jsx(D,{open:_,onOpenChange:b,children:e.jsxs(R,{children:[e.jsx(B,{children:e.jsx(A,{children:"Record Vendor Payment"})}),e.jsx(V,{...o,children:e.jsxs("form",{onSubmit:o.handleSubmit(s=>v.mutate(s)),className:"space-y-4",children:[e.jsx(a,{control:o.control,name:"vendorName",render:({field:s})=>e.jsxs(c,{children:[e.jsx(l,{children:"Vendor *"}),e.jsx(i,{children:e.jsx(m,{...s,placeholder:"Enter vendor name","data-testid":"input-vendor-name"})})]})}),e.jsx(a,{control:o.control,name:"amount",render:({field:s})=>e.jsxs(c,{children:[e.jsx(l,{children:"Amount *"}),e.jsx(i,{children:e.jsx(m,{...s,type:"number",step:"0.01",placeholder:"0.00","data-testid":"input-vendor-amount"})})]})}),e.jsx(a,{control:o.control,name:"paymentMethod",render:({field:s})=>e.jsxs(c,{children:[e.jsx(l,{children:"Payment Method *"}),e.jsxs(q,{onValueChange:s.onChange,defaultValue:s.value,children:[e.jsx(i,{children:e.jsx(w,{"data-testid":"select-vendor-payment-method",children:e.jsx(C,{})})}),e.jsxs(k,{children:[e.jsx(r,{value:"cash",children:"Cash"}),e.jsx(r,{value:"cheque",children:"Cheque"}),e.jsx(r,{value:"pos",children:"POS"}),e.jsx(r,{value:"fonepay",children:"Fonepay"})]})]})]})}),o.watch("paymentMethod")==="cheque"&&e.jsxs(e.Fragment,{children:[e.jsx(a,{control:o.control,name:"chequeNumber",render:({field:s})=>e.jsxs(c,{children:[e.jsx(l,{children:"Cheque Number *"}),e.jsx(i,{children:e.jsx(m,{...s,placeholder:"Enter cheque number","data-testid":"input-cheque-number"})})]})}),e.jsx(a,{control:o.control,name:"bankName",render:({field:s})=>e.jsxs(c,{children:[e.jsx(l,{children:"Bank Name *"}),e.jsx(i,{children:e.jsx(m,{...s,placeholder:"Which bank cheque issued from","data-testid":"input-cheque-bank"})})]})})]}),e.jsx(a,{control:o.control,name:"reference",render:({field:s})=>e.jsxs(c,{children:[e.jsx(l,{children:"Reference"}),e.jsx(i,{children:e.jsx(m,{...s,placeholder:"Invoice number or reference","data-testid":"input-vendor-reference"})})]})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(u,{type:"submit",className:"flex-1",disabled:v.isPending,children:v.isPending?"Processing...":"Record Payment"}),e.jsx(u,{type:"button",variant:"outline",className:"flex-1",onClick:()=>b(!1),children:"Cancel"})]})]})})]})}),e.jsx(D,{open:K,onOpenChange:j,children:e.jsxs(R,{children:[e.jsx(B,{children:e.jsx(A,{children:"Add New Expense"})}),e.jsx(V,{...d,children:e.jsxs("form",{onSubmit:d.handleSubmit(s=>g.mutate(s)),className:"space-y-4",children:[e.jsx(a,{control:d.control,name:"category",render:({field:s})=>e.jsxs(c,{children:[e.jsx(l,{children:"Category *"}),e.jsxs(q,{onValueChange:s.onChange,defaultValue:s.value,children:[e.jsx(i,{children:e.jsx(w,{"data-testid":"select-category",children:e.jsx(C,{})})}),e.jsxs(k,{children:[e.jsx(r,{value:"utilities",children:"Utilities"}),e.jsx(r,{value:"maintenance",children:"Maintenance"}),e.jsx(r,{value:"supplies",children:"Supplies"}),e.jsx(r,{value:"salaries",children:"Salaries"}),e.jsx(r,{value:"rent",children:"Rent"}),e.jsx(r,{value:"insurance",children:"Insurance"}),e.jsx(r,{value:"marketing",children:"Marketing"}),e.jsx(r,{value:"other",children:"Other"})]})]})]})}),e.jsx(a,{control:d.control,name:"amount",render:({field:s})=>e.jsxs(c,{children:[e.jsx(l,{children:"Amount *"}),e.jsx(i,{children:e.jsx(m,{...s,type:"number",step:"0.01",placeholder:"0.00","data-testid":"input-expense-amount"})})]})}),e.jsx(a,{control:d.control,name:"paymentMethod",render:({field:s})=>e.jsxs(c,{children:[e.jsx(l,{children:"Payment Method *"}),e.jsxs(q,{onValueChange:s.onChange,defaultValue:s.value,children:[e.jsx(i,{children:e.jsx(w,{"data-testid":"select-expense-payment-method",children:e.jsx(C,{})})}),e.jsxs(k,{children:[e.jsx(r,{value:"cash",children:"Cash"}),e.jsx(r,{value:"cheque",children:"Cheque"}),e.jsx(r,{value:"pos",children:"POS"}),e.jsx(r,{value:"fonepay",children:"Fonepay"})]})]})]})}),d.watch("paymentMethod")==="cheque"&&e.jsxs(e.Fragment,{children:[e.jsx(a,{control:d.control,name:"chequeNumber",render:({field:s})=>e.jsxs(c,{children:[e.jsx(l,{children:"Cheque Number *"}),e.jsx(i,{children:e.jsx(m,{...s,placeholder:"Enter cheque number","data-testid":"input-expense-cheque-number"})})]})}),e.jsx(a,{control:d.control,name:"bankName",render:({field:s})=>e.jsxs(c,{children:[e.jsx(l,{children:"Bank Name *"}),e.jsx(i,{children:e.jsx(m,{...s,placeholder:"Which bank cheque issued from","data-testid":"input-expense-cheque-bank"})})]})})]}),e.jsx(a,{control:d.control,name:"description",render:({field:s})=>e.jsxs(c,{children:[e.jsx(l,{children:"Description *"}),e.jsx(i,{children:e.jsx(se,{...s,placeholder:"Expense description",rows:3,"data-testid":"input-expense-description"})})]})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(u,{type:"submit",className:"flex-1",disabled:g.isPending,children:g.isPending?"Recording...":"Record Expense"}),e.jsx(u,{type:"button",variant:"outline",className:"flex-1",onClick:()=>j(!1),children:"Cancel"})]})]})})]})})]})})}export{je as default};
