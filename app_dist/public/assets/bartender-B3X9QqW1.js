import{q as ie,u as le,b as ce,o as de,r as o,l as S,d as T,j as e,B as l,s as u,I as oe,C as E,m as W,n as B,a as K,k as ue}from"./index-Dk6nXF67.js";import{D as me,J as F,C as L,c as he,Z as pe}from"./dashboard-layout-BUO8e75G.js";import{S as w}from"./stats-card-DnI6mJO0.js";import{B as xe}from"./badge-P46XOlcm.js";import{T as Q}from"./textarea-BAi4nzW_.js";import{D as M,f as ge,a as z,b as H,c as U,d as V}from"./dialog-mWSLCdZX.js";import{S as je,a as ve,b as fe,c as ye,d as Ne}from"./select-Gj2YppMn.js";import{W as we}from"./react-webcam-BPWWJfLh.js";import{c as J,e as X,g as be}from"./users-Dxbor6Q1.js";import"./circle-alert-BbQxKC8I.js";import"./index-CC2mel_A.js";import"./index-D-DdYU4C.js";function We(){ie();const{toast:i}=le(),Z=ce();de();const[$,m]=o.useState(!1),[G,I]=o.useState(!1),[k,R]=o.useState(null),[h,P]=o.useState(""),[r,p]=o.useState({itemId:"",qty:"",unit:"",reason:""}),[x,b]=o.useState(null),q=o.useRef(null),{data:c=[]}=S({queryKey:["/api/hotels/current/kot-orders"],refetchInterval:3e3,refetchIntervalInBackground:!0}),{data:O=[]}=S({queryKey:["/api/hotels/current/restaurant-tables"],refetchInterval:5e3,refetchIntervalInBackground:!0}),{data:C=[]}=S({queryKey:["/api/hotels/current/inventory-items"]}),g=T({mutationFn:async({id:s,data:a})=>await ue("PUT",`/api/kot-items/${s}`,a),onSuccess:()=>{Z.invalidateQueries({queryKey:["/api/hotels/current/kot-orders"]}),i({title:"KOT item updated successfully"}),m(!1),P(""),R(null)},onError:s=>{i({title:"Error",description:s.message,variant:"destructive"})}}),D=T({mutationFn:async s=>{const a=await fetch("/api/hotels/current/wastages",{method:"POST",credentials:"include",body:s});if(!a.ok){const t=await a.json();throw new Error(t.message||"Failed to record wastage")}return a.json()},onSuccess:()=>{i({title:"Wastage recorded successfully"}),I(!1),p({itemId:"",qty:"",unit:"",reason:""}),b(null)},onError:s=>{i({title:"Error",description:s.message,variant:"destructive"})}}),Y=s=>{g.mutate({id:s.id,data:{status:"approved"}})},_=s=>{R(s),m(!0)},ee=s=>{g.mutate({id:s.id,data:{status:"ready"}})},se=()=>{if(!k||!h.trim()){i({title:"Please provide a reason for declining",variant:"destructive"});return}if(h.trim().length<10){i({title:"Decline reason must be at least 10 characters",variant:"destructive"});return}g.mutate({id:k.id,data:{status:"declined",declineReason:h.trim()}})},te=()=>{var a;const s=(a=q.current)==null?void 0:a.getScreenshot();if(s){const t=document.createElement("canvas"),n=new Image;n.onload=()=>{t.width=n.width,t.height=n.height;const d=t.getContext("2d");if(d){d.drawImage(n,0,0);const A=new Date().toLocaleString();d.font="bold 20px Arial",d.fillStyle="rgba(0, 0, 0, 0.7)",d.fillRect(10,n.height-40,d.measureText(A).width+20,35),d.fillStyle="white",d.fillText(A,20,n.height-15),b(t.toDataURL("image/jpeg"))}},n.src=s}},ae=()=>{b(null)},re=async()=>{if(!r.itemId||!r.qty||!r.reason.trim()){i({title:"Please fill all wastage fields",variant:"destructive"});return}if(!x){i({title:"Please capture a photo of the wastage",variant:"destructive"});return}const s=parseFloat(r.qty);if(isNaN(s)||s<=0){i({title:"Please enter a valid quantity",variant:"destructive"});return}const a=await(await fetch(x)).blob(),t=new FormData;t.append("photo",a,"wastage.jpg"),t.append("itemId",r.itemId),t.append("qty",s.toString()),t.append("unit",r.unit),t.append("reason",r.reason.trim()),D.mutate(t)},j=Array.isArray(c)?c.filter(s=>{var a;return(a=s.items)==null?void 0:a.some(t=>t.status==="pending")}):[],v=Array.isArray(c)?c.filter(s=>{var a;return(a=s.items)==null?void 0:a.some(t=>t.status==="approved")}):[],f=Array.isArray(c)?c.filter(s=>{var a;return(a=s.items)==null?void 0:a.every(t=>t.status==="ready")}):[],y=Array.isArray(c)?c.filter(s=>{var a;return(a=s.items)==null?void 0:a.some(t=>t.status==="declined")}):[],ne=s=>{if(!Array.isArray(O))return s;const a=O.find(t=>t.id===s);return(a==null?void 0:a.name)||s},N=s=>{var a;return e.jsxs(E,{children:[e.jsx(W,{children:e.jsxs(B,{className:"flex justify-between items-center",children:[e.jsx("span",{children:ne(s.tableId)}),e.jsx("span",{className:"text-sm text-gray-500",children:new Date(s.createdAt).toLocaleTimeString()})]})}),e.jsx(K,{children:(a=s.items)==null?void 0:a.map(t=>{var n;return e.jsxs("div",{className:"mb-4 p-3 border rounded",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:(n=t.menuItem)==null?void 0:n.name}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Quantity: ",t.qty]}),t.notes&&e.jsxs("p",{className:"text-sm text-gray-500",children:["Notes: ",t.notes]}),t.declineReason&&e.jsxs("p",{className:"text-sm text-red-600",children:["Declined: ",t.declineReason]})]}),e.jsx(xe,{variant:t.status==="approved"||t.status==="ready"?"default":t.status==="declined"?"destructive":"secondary",children:t.status})]}),t.status==="pending"&&e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsxs(l,{size:"sm",onClick:()=>Y(t),className:"flex-1",children:[e.jsx(L,{className:"w-4 h-4 mr-1"})," Approve"]}),e.jsxs(l,{size:"sm",variant:"destructive",onClick:()=>_(t),className:"flex-1",children:[e.jsx(X,{className:"w-4 h-4 mr-1"})," Decline"]})]}),t.status==="approved"&&e.jsxs(l,{size:"sm",onClick:()=>ee(t),className:"w-full mt-2",children:[e.jsx(J,{className:"w-4 h-4 mr-1"})," Set Ready"]})]},t.id)})})]},s.id)};return e.jsxs(me,{title:"Bartender Dashboard",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsx(w,{title:"Pending Orders",value:j.length,icon:e.jsx(J,{}),iconColor:"text-orange-500"}),e.jsx(w,{title:"In Preparation",value:v.length,icon:e.jsx(F,{}),iconColor:"text-purple-500"}),e.jsx(w,{title:"Ready to Serve",value:f.length,icon:e.jsx(L,{}),iconColor:"text-green-500"}),e.jsx(w,{title:"Declined",value:y.length,icon:e.jsx(X,{}),iconColor:"text-red-500"})]}),e.jsx("div",{className:"flex gap-2 justify-end",children:e.jsxs(M,{open:G,onOpenChange:I,children:[e.jsx(ge,{asChild:!0,children:e.jsxs(l,{variant:"outline",children:[e.jsx(he,{className:"w-4 h-4 mr-2"})," Record Wastage"]})}),e.jsxs(z,{className:"max-w-2xl",children:[e.jsxs(H,{children:[e.jsx(U,{children:"Record Wastage"}),e.jsx(V,{children:"Capture photo and record inventory wastage"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(u,{children:"Inventory Item *"}),e.jsxs(je,{value:r.itemId,onValueChange:s=>{const a=C.find(t=>t.id===s);p({...r,itemId:s,unit:(a==null?void 0:a.unit)||"piece"})},children:[e.jsx(ve,{"data-testid":"select-wastage-item",children:e.jsx(fe,{placeholder:"Select item"})}),e.jsx(ye,{children:Array.isArray(C)&&C.map(s=>e.jsxs(Ne,{value:s.id,children:[s.name," (",s.unit,")"]},s.id))})]})]}),e.jsxs("div",{children:[e.jsx(u,{children:"Quantity *"}),e.jsx(oe,{type:"number",step:"0.01",value:r.qty,onChange:s=>p({...r,qty:s.target.value}),placeholder:"Enter quantity","data-testid":"input-wastage-quantity"})]}),e.jsxs("div",{children:[e.jsx(u,{children:"Reason *"}),e.jsx(Q,{value:r.reason,onChange:s=>p({...r,reason:s.target.value}),placeholder:"Explain reason for wastage","data-testid":"input-wastage-reason"})]}),e.jsxs("div",{children:[e.jsx(u,{children:"Photo Evidence * (Required)"}),x?e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"relative rounded-lg overflow-hidden border",children:e.jsx("img",{src:x,alt:"Captured wastage",className:"w-full"})}),e.jsxs(l,{type:"button",onClick:ae,className:"w-full",variant:"outline","data-testid":"button-retake-photo",children:[e.jsx(pe,{className:"w-4 h-4 mr-2"})," Retake Photo"]})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"relative rounded-lg overflow-hidden bg-black",children:e.jsx(we,{ref:q,audio:!1,screenshotFormat:"image/jpeg",className:"w-full",videoConstraints:{facingMode:"environment"}})}),e.jsxs(l,{type:"button",onClick:te,className:"w-full",variant:"secondary","data-testid":"button-capture-photo",children:[e.jsx(be,{className:"w-4 h-4 mr-2"})," Capture Photo"]})]})]}),e.jsx(l,{onClick:re,className:"w-full",disabled:D.isPending,"data-testid":"button-submit-wastage",children:D.isPending?"Recording...":"Record Wastage"})]})]})]})}),e.jsxs(E,{children:[e.jsx(W,{children:e.jsxs(B,{className:"flex items-center space-x-2",children:[e.jsx(F,{className:"h-5 w-5 text-purple-500"}),e.jsx("span",{children:"Bar Orders"})]})}),e.jsx(K,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold mb-2",children:["Pending Orders (",j.length,")"]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:j.length===0?e.jsx("p",{className:"text-gray-500 col-span-full text-center py-4",children:"No pending orders"}):j.map(N)})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold mb-2",children:["In Preparation (",v.length,")"]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:v.length===0?e.jsx("p",{className:"text-gray-500 col-span-full text-center py-4",children:"No orders in preparation"}):v.map(N)})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold mb-2",children:["Ready (",f.length,")"]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:f.length===0?e.jsx("p",{className:"text-gray-500 col-span-full text-center py-4",children:"No ready orders"}):f.map(N)})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold mb-2",children:["Declined (",y.length,")"]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:y.length===0?e.jsx("p",{className:"text-gray-500 col-span-full text-center py-4",children:"No declined orders"}):y.map(N)})]})]})})]})]}),e.jsx(M,{open:$,onOpenChange:m,children:e.jsxs(z,{children:[e.jsxs(H,{children:[e.jsx(U,{children:"Decline KOT Item"}),e.jsx(V,{children:"Please provide a reason for declining this item"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(u,{children:"Reason for Decline"}),e.jsx(Q,{value:h,onChange:s=>P(s.target.value),placeholder:"e.g., Out of stock, Equipment issue"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(l,{variant:"outline",onClick:()=>m(!1),className:"flex-1",children:"Cancel"}),e.jsx(l,{onClick:se,className:"flex-1",variant:"destructive",disabled:g.isPending,children:"Decline"})]})]})]})})]})}export{We as default};
