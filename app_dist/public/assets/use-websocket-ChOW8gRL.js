import{q as S,r as s}from"./index-Dk6nXF67.js";function k(){var p;const{user:e}=S(),c=s.useRef(null),t=s.useRef(new Map),i=s.useRef(),u=s.useRef(0),w=10,d=s.useCallback(()=>{var n;if(!(e!=null&&e.id)||!(e!=null&&e.hotelId)||!((n=e==null?void 0:e.role)!=null&&n.name))return;const a=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws?hotelId=${e.hotelId}&userId=${e.id}&role=${e.role.name}`;try{c.current=new WebSocket(a),c.current.onopen=()=>{u.current=0;const l=setInterval(()=>{var o;((o=c.current)==null?void 0:o.readyState)===WebSocket.OPEN?c.current.send(JSON.stringify({type:"ping"})):clearInterval(l)},3e4)},c.current.onmessage=l=>{try{const o=JSON.parse(l.data);if(o.event==="pong")return;const h=t.current.get(o.event);h&&h.forEach(f=>f(o.data));const m=t.current.get("*");m&&m.forEach(f=>f(o))}catch{}},c.current.onerror=()=>{},c.current.onclose=()=>{if(u.current<w){const l=Math.min(1e3*Math.pow(2,u.current),3e4);i.current=setTimeout(()=>{u.current++,d()},l)}}}catch{}},[e==null?void 0:e.id,e==null?void 0:e.hotelId,(p=e==null?void 0:e.role)==null?void 0:p.name]);s.useEffect(()=>(d(),()=>{i.current&&clearTimeout(i.current),c.current&&c.current.close()}),[d]);const g=s.useCallback((r,a)=>(t.current.has(r)||t.current.set(r,new Set),t.current.get(r).add(a),()=>{const n=t.current.get(r);n&&(n.delete(a),n.size===0&&t.current.delete(r))}),[]),I=s.useCallback((r,a)=>{if(!a)t.current.delete(r);else{const n=t.current.get(r);n&&(n.delete(a),n.size===0&&t.current.delete(r))}},[]);return{on:g,off:I}}export{k as u};
