import{r as n,b as U,l as V,d as K,j as e,B as d,C as h,m as u,n as x,a as p,y as A,s as l,I as q}from"./index-Dk6nXF67.js";import{S as ee,a as se,b as te,c as ae,d as v}from"./select-Gj2YppMn.js";import{T as Q}from"./textarea-BAi4nzW_.js";import{B as _}from"./badge-P46XOlcm.js";import{t as i}from"./index-Dmezy7bQ.js";import{D as H,a as re,t as ne}from"./dashboard-layout-BUO8e75G.js";import{D as ie,a as oe,b as de,c as le,d as ce,e as me}from"./dialog-mWSLCdZX.js";import{D as he,C as ue,F as xe,B as pe}from"./users-Dxbor6Q1.js";import"./index-CC2mel_A.js";import"./index-D-DdYU4C.js";import"./circle-alert-BbQxKC8I.js";function Fe(){const[J,I]=n.useState(!1),[$,y]=n.useState(!1),[o,N]=n.useState(null),[c,b]=n.useState(""),[j,R]=n.useState(""),[m,k]=n.useState(""),[w,E]=n.useState(""),[P,L]=n.useState(""),[C,O]=n.useState(""),S=U(),{data:t,isLoading:z}=V({queryKey:["/api/user"],refetchInterval:3e3,queryFn:async()=>{const s=await fetch("/api/user",{credentials:"include"});if(!s.ok)throw new Error("Failed to fetch user");return s.json()}}),{data:F=[],isLoading:W}=V({queryKey:["/api/hotels/current/vendors"],refetchInterval:3e3,enabled:!!(t!=null&&t.hotelId),queryFn:async()=>{const s=await fetch("/api/hotels/current/vendors",{credentials:"include"});if(!s.ok)throw new Error("Failed to fetch vendors");return s.json()}}),{data:f=[],isLoading:G}=V({queryKey:["/api/hotels/current/transactions"],refetchInterval:3e3,enabled:!!(t!=null&&t.hotelId),queryFn:async()=>{const s=await fetch("/api/hotels/current/transactions",{credentials:"include"});if(!s.ok)throw new Error("Failed to fetch transactions");return(await s.json()).filter(r=>r.vendorId&&r.txnType==="vendor_payment")}}),T=K({mutationFn:async s=>{if(!(t!=null&&t.hotelId)||!(t!=null&&t.id))throw new Error("User information not available");const a=await fetch("/api/transactions",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({...s,hotelId:t.hotelId,txnType:"vendor_payment",createdBy:t.id})});if(!a.ok)throw new Error("Failed to create payment");return a.json()},onSuccess:()=>{S.invalidateQueries({queryKey:["/api/hotels/current/transactions"]}),i.success("Payment recorded successfully"),B()},onError:s=>{i.error(s.message||"Failed to record payment")}}),g=K({mutationFn:async({transactionId:s,reason:a})=>{const r=await fetch(`/api/transactions/${s}/void`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({reason:a})});if(!r.ok){const Z=await r.json();throw new Error(Z.message||"Failed to void payment")}return r.json()},onSuccess:()=>{S.invalidateQueries({queryKey:["/api/hotels/current/transactions"]}),i.success("Payment voided successfully"),y(!1),b(""),N(null)},onError:s=>{i.error(s.message||"Failed to void payment")}}),B=()=>{R(""),k(""),E(""),L(""),O(""),I(!1)},X=async s=>{if(s.preventDefault(),!(t!=null&&t.hotelId)||!(t!=null&&t.id)){i.error("Please wait for user information to load");return}if(!j.trim()||!m||!w||!P||!C.trim()){i.error("Please fill in all required fields");return}if(isNaN(Number(m))||Number(m)<=0){i.error("Please enter a valid amount");return}try{let a=F.find(r=>r.name.toLowerCase()===j.trim().toLowerCase());if(!a){const r=await fetch("/api/hotels/current/vendors",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({name:j.trim(),contact:{}})});if(!r.ok)throw new Error("Failed to create vendor");a=await r.json(),S.invalidateQueries({queryKey:["/api/hotels/current/vendors"]})}if(!a)throw new Error("Failed to get vendor information");T.mutate({vendorId:a.id,amount:Number(m).toFixed(2),currency:"NPR",paymentMethod:w,purpose:P,reference:C.trim()})}catch(a){i.error(a.message||"Failed to process payment")}},M=s=>{const a=F.find(r=>r.id===s);return(a==null?void 0:a.name)||"Unknown Vendor"},D=s=>`NPR ${Number(s).toLocaleString()}`,Y=s=>new Date(s).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"});return z||W||G?e.jsx(H,{title:"Vendor Payments",children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-8 bg-gray-200 rounded w-1/4"}),e.jsx("div",{className:"h-32 bg-gray-200 rounded"}),e.jsx("div",{className:"h-64 bg-gray-200 rounded"})]})}):e.jsxs(H,{title:"Vendor Payments",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Vendor Payments"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Manage payments to vendors and suppliers"})]}),e.jsxs(d,{onClick:()=>I(!0),className:"flex items-center gap-2",children:[e.jsx(re,{className:"h-4 w-4"}),"Record Payment"]})]}),e.jsxs("div",{className:"grid md:grid-cols-3 gap-6",children:[e.jsxs(h,{children:[e.jsxs(u,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(x,{className:"text-sm font-medium",children:"Total Payments"}),e.jsx(he,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(p,{children:[e.jsx("div",{className:"text-2xl font-bold",children:D(f.reduce((s,a)=>s+Number(a.amount),0).toFixed(2))}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"This month"})]})]}),e.jsxs(h,{children:[e.jsxs(u,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(x,{className:"text-sm font-medium",children:"Active Vendors"}),e.jsx(ne,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(p,{children:[e.jsx("div",{className:"text-2xl font-bold",children:F.length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Registered vendors"})]})]}),e.jsxs(h,{children:[e.jsxs(u,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(x,{className:"text-sm font-medium",children:"Recent Payments"}),e.jsx(ue,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(p,{children:[e.jsx("div",{className:"text-2xl font-bold",children:f.length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Total records"})]})]})]}),J&&e.jsxs(h,{children:[e.jsxs(u,{children:[e.jsx(x,{children:"Record New Payment"}),e.jsx(A,{children:"Enter payment details for vendor"})]}),e.jsx(p,{children:e.jsxs("form",{onSubmit:X,className:"space-y-4",children:[e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"vendor",children:"Vendor Name *"}),e.jsx(q,{id:"vendor",placeholder:"Enter vendor name",value:j,onChange:s=>R(s.target.value),required:!0}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Type vendor name (will be created if doesn't exist)"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"amount",children:"Amount (NPR) *"}),e.jsx(q,{id:"amount",type:"number",step:"0.01",placeholder:"0.00",value:m,onChange:s=>k(s.target.value),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"paymentMethod",children:"Payment Method *"}),e.jsxs(ee,{value:w,onValueChange:E,children:[e.jsx(se,{children:e.jsx(te,{placeholder:"Select method"})}),e.jsxs(ae,{children:[e.jsx(v,{value:"cash",children:"Cash"}),e.jsx(v,{value:"cheque",children:"Cheque"}),e.jsx(v,{value:"bank_transfer",children:"Bank Transfer"}),e.jsx(v,{value:"digital_wallet",children:"Digital Wallet"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(l,{htmlFor:"reference",children:["Reference Number ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(q,{id:"reference",placeholder:"Invoice/PO number, cheque number, etc.",value:C,onChange:s=>O(s.target.value),"data-testid":"input-reference",required:!0})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"purpose",children:"Purpose *"}),e.jsx(Q,{id:"purpose",placeholder:"Description of payment purpose",value:P,onChange:s=>L(s.target.value),required:!0})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(d,{type:"submit",disabled:T.isPending,children:T.isPending?"Recording...":"Record Payment"}),e.jsx(d,{type:"button",variant:"outline",onClick:B,children:"Cancel"})]})]})})]}),e.jsxs(h,{children:[e.jsxs(u,{children:[e.jsx(x,{children:"Payment History"}),e.jsx(A,{children:"Recent vendor payments"})]}),e.jsx(p,{children:f.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(xe,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No vendor payments recorded yet"}),e.jsx("p",{className:"text-sm",children:'Click "Record Payment" to add your first payment'})]}):e.jsx("div",{className:"space-y-4",children:f.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("h3",{className:"font-medium",children:M(s.vendorId)}),e.jsx(_,{variant:"outline",className:"capitalize",children:s.paymentMethod.replace("_"," ")})]}),e.jsx("p",{className:"text-sm text-gray-600 mb-1",children:s.purpose}),e.jsx("p",{className:"text-xs text-gray-500",children:Y(s.createdAt)}),s.reference&&e.jsxs("p",{className:"text-xs text-gray-500",children:["Ref: ",s.reference]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-semibold text-lg",children:D(s.amount)}),s.isVoided?e.jsx(_,{variant:"destructive",className:"mt-2",children:"VOIDED"}):e.jsx(d,{variant:"ghost",size:"sm",onClick:()=>{N(s),y(!0)},className:"text-orange-600 hover:text-orange-700 hover:bg-orange-50",disabled:g.isPending,"data-testid":`button-void-${s.id}`,children:e.jsx(pe,{className:"h-4 w-4"})})]})]},s.id))})})]})]}),e.jsx(ie,{open:$,onOpenChange:y,children:e.jsxs(oe,{"data-testid":"dialog-void-transaction",children:[e.jsxs(de,{children:[e.jsx(le,{children:"Void Payment Transaction"}),e.jsx(ce,{children:"Voiding a payment transaction is permanent and creates an audit trail. Please provide a detailed reason (minimum 15 characters)."})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"void-reason",children:"Reason for Voiding"}),e.jsx(Q,{id:"void-reason",placeholder:"e.g., Duplicate payment entry, incorrect amount, payment reversal requested...",value:c,onChange:s=>b(s.target.value),rows:4,"data-testid":"input-void-reason"}),e.jsxs("p",{className:"text-sm text-gray-500",children:[c.length,"/15 characters minimum"]})]}),o&&e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg space-y-1",children:[e.jsx("p",{className:"text-sm font-medium",children:"Transaction Details:"}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Amount: ",D(o.amount)]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Vendor: ",M(o.vendorId)]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Purpose: ",o.purpose]})]})]}),e.jsxs(me,{children:[e.jsx(d,{variant:"outline",onClick:()=>{y(!1),b(""),N(null)},"data-testid":"button-cancel-void",children:"Cancel"}),e.jsx(d,{variant:"destructive",onClick:()=>{o&&c.trim().length>=15&&g.mutate({transactionId:o.id,reason:c.trim()})},disabled:c.trim().length<15||g.isPending,"data-testid":"button-confirm-void",children:g.isPending?"Voiding...":"Void Transaction"})]})]})})]})}export{Fe as default};
