import{j as e,w as Ks,o as zs,r as h,l as Z,B as T,C as f,m as w,n as y,a as g,p as Q,y as ae,I as is,u as Ws,A as Hs}from"./index-Dk6nXF67.js";import{T as Qs,a as Gs,b as Fe,c as Ue}from"./tabs-B2htHbJV.js";import{B as b}from"./badge-P46XOlcm.js";import{C as Js,s as $s}from"./calendar-CUmVpCKZ.js";import{P as Fs,a as Us,b as Ms}from"./popover-CrHfQmXJ.js";import{D as Re,a as Ee,b as Ve,c as Ke,d as ls}from"./dialog-mWSLCdZX.js";import{T as ze,a as We,b as G,c as A,d as He,e as v}from"./table-BAc8EiUx.js";import{S as re,a as ie,b as le,c as ne,d as D}from"./select-Gj2YppMn.js";import{u as De}from"./use-realtime-query-2TJdEol3.js";import{f as Xs,C as Zs,d as ke,F as qe,c as Te,A as ns,D as _e,U as ds,S as Qe,g as Be,M as hs,T as rs,b as Is,a as be,h as Ce,e as Bs,R as Oe,B as Ge,i as Se,I as xs,E as us,j as Ys,k as et,l as qs}from"./users-Dxbor6Q1.js";import{t as st,f as _s,s as as}from"./format-BOBWS5Wu.js";import"./index-CC2mel_A.js";import"./addWeeks-Pc006p7j.js";import"./startOfMonth-CkZi6Jlw.js";import"./index-D-DdYU4C.js";import"./use-websocket-ChOW8gRL.js";function ms(C){const o=st(C);return o.setHours(23,59,59,999),o}function k({className:C,...o}){return e.jsx("div",{className:Ks("animate-pulse rounded-md bg-muted",C),...o})}function tt({dateRange:C}){var S,a,u;const[o,J]=h.useState("all"),[Y,X]=h.useState("all"),[_,P]=h.useState("all"),[R,q]=h.useState("createdAt"),[O,de]=h.useState("desc"),{data:N=[],isLoading:xe}=Z({queryKey:["/api/users"]}),{data:ce=[],isLoading:K}=Z({queryKey:["/api/hotels/current/leave-requests"]}),te=(t,i,d)=>{if(!i||!d)return t;const p=new URLSearchParams({startDate:i.toISOString(),endDate:d.toISOString()});return`${t}?${p.toString()}`},{data:F=[],isLoading:E}=Z({queryKey:["/api/audit-logs",(S=C.from)==null?void 0:S.toISOString(),(a=C.to)==null?void 0:a.toISOString()],queryFn:async()=>{const t=te("/api/audit-logs",C.from,C.to),i=await fetch(t,{credentials:"include"});return i.ok?i.json():[]},refetchInterval:5e3});De({queryKey:["/api/users"],events:["user:updated"]}),De({queryKey:["/api/audit-logs"],events:["audit:created"]});const z=xe||K||E,U=N.filter(t=>t.isActive&&!t.deletedAt),L=U.filter(t=>t.isOnline),ve=new Date,oe=ce.filter(t=>{if(t.status!=="approved")return!1;const i=new Date(t.startDate),d=new Date(t.endDate);return ve>=i&&ve<=d}),ge=h.useMemo(()=>{const t={};return F.forEach(i=>{i.userId&&(t[i.userId]=(t[i.userId]||0)+1)}),t},[F]),Ne=h.useMemo(()=>{if(Object.keys(ge).length===0)return null;const t=Object.entries(ge).sort((M,we)=>we[1]-M[1]),[i,d]=t[0];return{user:N.find(M=>M.id===i),count:d}},[ge,N]),he=h.useMemo(()=>{let t=[...F];return o!=="all"&&(t=t.filter(i=>i.userId===o)),Y!=="all"&&(t=t.filter(i=>i.action===Y)),_!=="all"&&(t=t.filter(i=>{var d,p;return((p=(d=i.user)==null?void 0:d.role)==null?void 0:p.name)===_})),t.sort((i,d)=>{let p=i[R],M=d[R];return R==="createdAt"&&(p=new Date(p).getTime(),M=new Date(M).getTime()),O==="asc"?p>M?1:-1:p<M?1:-1}),t},[F,o,Y,_,R,O]),$=h.useMemo(()=>F.filter(t=>t.action==="login"||t.action==="logout").map(t=>{var M,we;const i=t.userAgent||"";let d="Unknown",p="Unknown";return i.includes("Chrome")?d="Chrome":i.includes("Firefox")?d="Firefox":i.includes("Safari")?d="Safari":i.includes("Edge")&&(d="Edge"),i.includes("Windows")?p="Windows":i.includes("Mac")?p="MacOS":i.includes("Linux")?p="Linux":i.includes("Android")?p="Android":i.includes("iOS")&&(p="iOS"),{...t,browser:d,os:p,device:`${d} on ${p}`,isNewDevice:((M=t.details)==null?void 0:M.isNewDevice)||!1,isNewLocation:((we=t.details)==null?void 0:we.isNewLocation)||!1}}),[F]),ue=h.useMemo(()=>{const t=[],i={};return $.forEach(d=>{if(d.action==="login")i[d.userId]=d;else if(d.action==="logout"&&i[d.userId]){const p=i[d.userId],M=new Date(p.createdAt),W=(new Date(d.createdAt).getTime()-M.getTime())/(1e3*60);t.push({user:p.user,loginTime:p.createdAt,logoutTime:d.createdAt,duration:W.toFixed(0),device:p.device,browser:p.browser,os:p.os,location:p.ipAddress,isNewDevice:p.isNewDevice,isNewLocation:p.isNewLocation}),delete i[d.userId]}}),Object.values(i).forEach(d=>{t.push({user:d.user,loginTime:d.createdAt,logoutTime:null,duration:null,device:d.device,browser:d.browser,os:d.os,location:d.ipAddress,isNewDevice:d.isNewDevice,isNewLocation:d.isNewLocation})}),t.sort((d,p)=>new Date(p.loginTime).getTime()-new Date(d.loginTime).getTime())},[$]),pe=t=>t==="create"?"text-green-600 dark:text-green-400":t==="update"?"text-blue-600 dark:text-blue-400":t==="delete"||t==="void"?"text-red-600 dark:text-red-400":t==="approve"?"text-yellow-600 dark:text-yellow-400":"text-gray-600 dark:text-gray-400",me=t=>t==="create"?"bg-green-50 dark:bg-green-900/10":t==="update"?"bg-blue-50 dark:bg-blue-900/10":t==="delete"||t==="void"?"bg-red-50 dark:bg-red-900/10":t==="approve"?"bg-yellow-50 dark:bg-yellow-900/10":"bg-gray-50 dark:bg-gray-900/10",r=t=>{R===t?de(O==="asc"?"desc":"asc"):(q(t),de("desc"))},l=h.useMemo(()=>Array.from(new Set(F.map(t=>t.action))).filter(Boolean),[F]),j=h.useMemo(()=>Array.from(new Set(F.map(t=>{var i,d;return(d=(i=t.user)==null?void 0:i.role)==null?void 0:d.name}).filter(Boolean))),[F]),x=h.useMemo(()=>{if(o==="all")return null;const t=N.find(W=>W.id===o);if(!t)return null;const i=F.filter(W=>W.userId===o),d=i.filter(W=>W.resourceType==="transaction"),p=i.filter(W=>W.action==="approve"),M=$.filter(W=>W.userId===o),we=Array.from(new Set(M.map(W=>W.device)));return{staff:t,totalActions:i.length,transactions:d.length,approvals:p.length,logins:M.length,devices:we,recentActivity:i.slice(0,10)}},[o,N,F,$]);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsxs(f,{"data-testid":"card-total-active-staff",className:"border-l-4 border-l-blue-500",children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"Total Active Staff"}),e.jsx(ds,{className:"h-4 w-4 text-blue-500"})]}),e.jsx(g,{children:z?e.jsx(k,{className:"h-8 w-16"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-active-staff-count",children:U.length}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Active employees"})]})})]}),e.jsxs(f,{"data-testid":"card-online-staff",className:"border-l-4 border-l-green-500",children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"Currently Online"}),e.jsx(ns,{className:"h-4 w-4 text-green-500"})]}),e.jsx(g,{children:z?e.jsx(k,{className:"h-8 w-16"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-online-staff-count",children:L.length}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Staff online now"})]})})]}),e.jsxs(f,{"data-testid":"card-staff-on-leave",className:"border-l-4 border-l-orange-500",children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"Staff on Leave Today"}),e.jsx(Te,{className:"h-4 w-4 text-orange-500"})]}),e.jsx(g,{children:z?e.jsx(k,{className:"h-8 w-16"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-on-leave-count",children:oe.length}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"On approved leave"})]})})]}),e.jsxs(f,{"data-testid":"card-most-active-staff",className:"border-l-4 border-l-purple-500",children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"Most Active Staff"}),e.jsx(rs,{className:"h-4 w-4 text-purple-500"})]}),e.jsx(g,{children:z?e.jsx(k,{className:"h-8 w-full"}):Ne?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-lg font-bold truncate","data-testid":"text-most-active-name",children:((u=Ne.user)==null?void 0:u.username)||"N/A"}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1","data-testid":"text-most-active-count",children:[Ne.count," actions"]})]}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"No activity"})})]})]}),e.jsxs(f,{"data-testid":"card-staff-activity-table",children:[e.jsxs(w,{children:[e.jsxs(y,{className:"flex items-center gap-2",children:[e.jsx(ns,{className:"h-5 w-5"}),"Staff Activity Log"]}),e.jsx(ae,{children:"Detailed log of all staff actions and operations"})]}),e.jsxs(g,{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(re,{value:o,onValueChange:J,children:[e.jsx(ie,{className:"w-[200px]","data-testid":"select-staff-filter",children:e.jsx(le,{placeholder:"All Staff"})}),e.jsxs(ne,{children:[e.jsx(D,{value:"all",children:"All Staff"}),U.map(t=>e.jsx(D,{value:t.id,children:t.username},t.id))]})]}),e.jsxs(re,{value:Y,onValueChange:X,children:[e.jsx(ie,{className:"w-[200px]","data-testid":"select-action-filter",children:e.jsx(le,{placeholder:"All Actions"})}),e.jsxs(ne,{children:[e.jsx(D,{value:"all",children:"All Actions"}),l.map(t=>e.jsx(D,{value:t,children:t},t))]})]}),e.jsxs(re,{value:_,onValueChange:P,children:[e.jsx(ie,{className:"w-[200px]","data-testid":"select-role-filter",children:e.jsx(le,{placeholder:"All Roles"})}),e.jsxs(ne,{children:[e.jsx(D,{value:"all",children:"All Roles"}),j.map(t=>e.jsx(D,{value:t,children:t},t))]})]})]}),e.jsx("div",{className:"rounded-md border",children:e.jsxs(ze,{children:[e.jsx(We,{children:e.jsxs(G,{children:[e.jsx(A,{className:"cursor-pointer",onClick:()=>r("user"),"data-testid":"th-staff-name",children:e.jsxs("div",{className:"flex items-center gap-1",children:["Staff Name",e.jsx(Se,{className:"h-3 w-3"})]})}),e.jsx(A,{"data-testid":"th-role",children:"Role"}),e.jsx(A,{className:"cursor-pointer",onClick:()=>r("action"),"data-testid":"th-action",children:e.jsxs("div",{className:"flex items-center gap-1",children:["Action",e.jsx(Se,{className:"h-3 w-3"})]})}),e.jsx(A,{"data-testid":"th-resource",children:"Resource"}),e.jsx(A,{"data-testid":"th-details",children:"Details"}),e.jsx(A,{"data-testid":"th-device-info",children:"Device"}),e.jsx(A,{"data-testid":"th-location",children:"Location"}),e.jsx(A,{className:"cursor-pointer",onClick:()=>r("createdAt"),"data-testid":"th-time",children:e.jsxs("div",{className:"flex items-center gap-1",children:["Time",e.jsx(Se,{className:"h-3 w-3"})]})})]})}),e.jsx(He,{children:z?[...Array(5)].map((t,i)=>e.jsx(G,{children:[...Array(8)].map((d,p)=>e.jsx(v,{children:e.jsx(k,{className:"h-4 w-full"})},p))},i)):he.length===0?e.jsx(G,{children:e.jsx(v,{colSpan:8,className:"text-center py-8 text-muted-foreground","data-testid":"text-no-activity",children:"No staff activity found."})}):he.slice(0,50).map(t=>{var i,d,p;return e.jsxs(G,{className:me(t.action),"data-testid":`activity-row-${t.id}`,children:[e.jsx(v,{className:"font-medium text-xs","data-testid":`td-staff-${t.id}`,children:((i=t.user)==null?void 0:i.username)||"Unknown"}),e.jsx(v,{className:"text-xs","data-testid":`td-role-${t.id}`,children:((p=(d=t.user)==null?void 0:d.role)==null?void 0:p.name)||"-"}),e.jsx(v,{"data-testid":`td-action-${t.id}`,children:e.jsx(b,{className:pe(t.action),children:t.action})}),e.jsx(v,{className:"text-xs","data-testid":`td-resource-${t.id}`,children:t.resourceType||"-"}),e.jsx(v,{className:"text-xs max-w-[200px] truncate","data-testid":`td-details-${t.id}`,children:t.resourceId||"-"}),e.jsx(v,{className:"text-xs","data-testid":`td-device-${t.id}`,children:t.userAgent?e.jsx("span",{className:"truncate max-w-[150px] block",title:t.userAgent,children:t.userAgent.split(" ")[0]}):"-"}),e.jsx(v,{className:"text-xs","data-testid":`td-location-${t.id}`,children:t.ipAddress||"-"}),e.jsx(v,{className:"text-xs whitespace-nowrap","data-testid":`td-time-${t.id}`,children:new Date(t.createdAt).toLocaleString()})]},t.id)})})]})})]})]}),e.jsxs(f,{"data-testid":"card-login-history",children:[e.jsxs(w,{children:[e.jsxs(y,{className:"flex items-center gap-2",children:[e.jsx(Qe,{className:"h-5 w-5"}),"Login History"]}),e.jsx(ae,{children:"All login and logout events with device information"})]}),e.jsx(g,{children:e.jsx("div",{className:"rounded-md border",children:e.jsxs(ze,{children:[e.jsx(We,{children:e.jsxs(G,{children:[e.jsx(A,{"data-testid":"th-login-staff",children:"Staff Name"}),e.jsx(A,{"data-testid":"th-login-time",children:"Login Time"}),e.jsx(A,{"data-testid":"th-logout-time",children:"Logout Time"}),e.jsx(A,{"data-testid":"th-duration",children:"Duration"}),e.jsx(A,{"data-testid":"th-browser",children:"Browser"}),e.jsx(A,{"data-testid":"th-os",children:"OS"}),e.jsx(A,{"data-testid":"th-ip",children:"Location (IP)"}),e.jsx(A,{"data-testid":"th-flags",children:"Flags"})]})}),e.jsx(He,{children:z?[...Array(5)].map((t,i)=>e.jsx(G,{children:[...Array(8)].map((d,p)=>e.jsx(v,{children:e.jsx(k,{className:"h-4 w-full"})},p))},i)):ue.length===0?e.jsx(G,{children:e.jsx(v,{colSpan:8,className:"text-center py-8 text-muted-foreground","data-testid":"text-no-logins",children:"No login history found."})}):ue.slice(0,30).map((t,i)=>{var d;return e.jsxs(G,{className:t.isNewDevice||t.isNewLocation?"bg-red-50 dark:bg-red-900/10":"","data-testid":`login-row-${i}`,children:[e.jsx(v,{className:"font-medium text-xs","data-testid":`td-login-staff-${i}`,children:((d=t.user)==null?void 0:d.username)||"Unknown"}),e.jsx(v,{className:"text-xs whitespace-nowrap","data-testid":`td-login-time-${i}`,children:new Date(t.loginTime).toLocaleString()}),e.jsx(v,{className:"text-xs whitespace-nowrap","data-testid":`td-logout-time-${i}`,children:t.logoutTime?new Date(t.logoutTime).toLocaleString():e.jsx(b,{variant:"outline",className:"text-green-600",children:"Active"})}),e.jsx(v,{className:"text-xs","data-testid":`td-duration-${i}`,children:t.duration?`${t.duration} min`:"-"}),e.jsx(v,{className:"text-xs","data-testid":`td-browser-${i}`,children:t.browser}),e.jsx(v,{className:"text-xs","data-testid":`td-os-${i}`,children:t.os}),e.jsx(v,{className:"text-xs","data-testid":`td-ip-${i}`,children:t.location||"-"}),e.jsxs(v,{"data-testid":`td-flags-${i}`,children:[t.isNewDevice&&e.jsx(b,{variant:"destructive",className:"text-xs mr-1",children:"New Device"}),t.isNewLocation&&e.jsx(b,{variant:"destructive",className:"text-xs",children:"New Location"})]})]},i)})})]})})})]}),e.jsxs(f,{"data-testid":"card-staff-drilldown",children:[e.jsxs(w,{children:[e.jsxs(y,{className:"flex items-center gap-2",children:[e.jsx(us,{className:"h-5 w-5"}),"Staff Detail View"]}),e.jsx(ae,{children:"Select a staff member to view their detailed activity timeline"})]}),e.jsxs(g,{className:"space-y-4",children:[e.jsxs(re,{value:o,onValueChange:J,children:[e.jsx(ie,{"data-testid":"select-staff-drilldown",children:e.jsx(le,{placeholder:"Select a staff member"})}),e.jsxs(ne,{children:[e.jsx(D,{value:"all",children:"Select a staff member"}),U.map(t=>{var i;return e.jsxs(D,{value:t.id,children:[t.username," (",((i=t.role)==null?void 0:i.name)||"N/A",")"]},t.id)})]})]}),x&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsx(f,{className:"border-l-4 border-l-blue-500",children:e.jsxs(g,{className:"pt-6",children:[e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-staff-total-actions",children:x.totalActions}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Total Actions"})]})}),e.jsx(f,{className:"border-l-4 border-l-green-500",children:e.jsxs(g,{className:"pt-6",children:[e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-staff-transactions",children:x.transactions}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Transactions"})]})}),e.jsx(f,{className:"border-l-4 border-l-yellow-500",children:e.jsxs(g,{className:"pt-6",children:[e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-staff-approvals",children:x.approvals}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Approvals Given"})]})}),e.jsx(f,{className:"border-l-4 border-l-purple-500",children:e.jsxs(g,{className:"pt-6",children:[e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-staff-logins",children:x.logins}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Login Sessions"})]})})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-semibold mb-2",children:"Devices Used"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:x.devices.length>0?x.devices.map((t,i)=>e.jsx(b,{variant:"outline","data-testid":`badge-device-${i}`,children:t},i)):e.jsx("p",{className:"text-sm text-muted-foreground",children:"No device information available"})})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-semibold mb-2",children:"Recent Activity Timeline"}),e.jsx("div",{className:"space-y-2",children:x.recentActivity.length>0?x.recentActivity.map((t,i)=>e.jsxs("div",{className:`flex items-center justify-between p-3 rounded-lg ${me(t.action)}`,"data-testid":`timeline-item-${i}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(b,{className:pe(t.action),children:t.action}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:t.resourceType}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t.resourceId||"N/A"})]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:new Date(t.createdAt).toLocaleString()})]},i)):e.jsx("p",{className:"text-sm text-muted-foreground",children:"No recent activity"})})]})]}),o==="all"&&e.jsx("div",{className:"text-center py-8 text-muted-foreground","data-testid":"text-select-staff",children:"Please select a staff member to view their detailed activity"})]})]})]})}function at({dateRange:C}){var W,cs,Je,Xe,Ze,Ye,Le,Pe;const[o,J]=h.useState("all"),[Y,X]=h.useState("all"),[_,P]=h.useState("all"),[R,q]=h.useState("createdAt"),[O,de]=h.useState("desc"),[N,xe]=h.useState(null),[ce,K]=h.useState(!1),[te,F]=h.useState(""),E=(n,m,V)=>{if(!m||!V)return n;const ee=new URLSearchParams({startDate:m.toISOString(),endDate:V.toISOString()});return`${n}?${ee.toString()}`},{data:z=[],isLoading:U}=Z({queryKey:["/api/audit-logs",(W=C.from)==null?void 0:W.toISOString(),(cs=C.to)==null?void 0:cs.toISOString()],queryFn:async()=>{const n=E("/api/audit-logs",C.from,C.to),m=await fetch(n,{credentials:"include"});return m.ok?m.json():[]},refetchInterval:5e3}),{data:L=[],isLoading:ve}=Z({queryKey:["/api/hotels/current/transactions"]}),{data:oe=[],isLoading:ge}=Z({queryKey:["/api/hotels/current/wastages"]});De({queryKey:["/api/audit-logs"],events:["audit:created"]}),De({queryKey:["/api/hotels/current/transactions"],events:["transaction:created","transaction:updated"]});const Ne=U||ve||ge,he=n=>n.type==="multiple_new_devices"||n.type==="foreign_login"||n.type==="very_large_transaction"&&parseFloat(n.amount||0)>1e5?"critical":n.type==="new_device_and_location"||n.type==="large_no_bill"&&parseFloat(n.amount||0)>5e4?"high":n.type==="new_device"||n.type==="new_location"||n.type==="wastage_no_approval"?"medium":"low",$=h.useMemo(()=>{const n=[];return z.forEach(m=>{var V,ee,ye,es;m.action==="login"&&((V=m.details)!=null&&V.isNewDevice)&&((ee=m.details)!=null&&ee.isNewLocation)?n.push({id:`alert-${m.id}`,type:"new_device_and_location",description:"Login from new device AND new location",staff:m.user,timestamp:m.createdAt,ipAddress:m.ipAddress,userAgent:m.userAgent,status:"unresolved",relatedData:m}):m.action==="login"&&((ye=m.details)!=null&&ye.isNewDevice)?n.push({id:`alert-${m.id}`,type:"new_device",description:"Login from new device",staff:m.user,timestamp:m.createdAt,ipAddress:m.ipAddress,userAgent:m.userAgent,status:"unresolved",relatedData:m}):m.action==="login"&&((es=m.details)!=null&&es.isNewLocation)&&n.push({id:`alert-${m.id}`,type:"new_location",description:"Login from new location",staff:m.user,timestamp:m.createdAt,ipAddress:m.ipAddress,userAgent:m.userAgent,status:"unresolved",relatedData:m})}),L.forEach(m=>{var ee;const V=parseFloat(m.amount||0);V>=5e4&&((ee=m.txnType)!=null&&ee.includes("_out"))&&!m.billPhotoUrl&&!m.billPdfUrl?n.push({id:`alert-txn-${m.id}`,type:"large_no_bill",description:`Large cash out (${V.toLocaleString()}) without bill proof`,staff:m.creator,timestamp:m.createdAt,amount:V,status:"unresolved",relatedData:m}):V>=1e5&&n.push({id:`alert-txn-large-${m.id}`,type:"very_large_transaction",description:`Very large transaction (${V.toLocaleString()})`,staff:m.creator,timestamp:m.createdAt,amount:V,status:m.approvedBy?"resolved":"unresolved",relatedData:m})}),oe.forEach(m=>{m.status==="pending_approval"&&n.push({id:`alert-wastage-${m.id}`,type:"wastage_no_approval",description:"Wastage recorded without approval",staff:{id:m.recordedBy,username:"Staff Member"},timestamp:m.createdAt,status:"unresolved",relatedData:m})}),n.map(m=>({...m,priority:he(m)}))},[z,L,oe]),ue=new Date(Date.now()-24*60*60*1e3),pe=new Date(Date.now()-7*24*60*60*1e3),me=new Date(Date.now()-30*24*60*60*1e3),r=$.filter(n=>new Date(n.timestamp)>=ue).length;$.filter(n=>new Date(n.timestamp)>=pe).length,$.filter(n=>new Date(n.timestamp)>=me).length;const l=$.filter(n=>n.type==="new_device"||n.type==="new_device_and_location").length,j=$.filter(n=>n.type==="new_location"||n.type==="new_device_and_location").length,x=$.filter(n=>n.type==="large_no_bill"||n.type==="very_large_transaction").length,S=$.filter(n=>n.status==="unresolved").length,a=h.useMemo(()=>{let n=[...$];return o!=="all"&&(n=n.filter(m=>m.priority===o)),Y!=="all"&&(n=n.filter(m=>m.type===Y)),_!=="all"&&(n=n.filter(m=>m.status===_)),n.sort((m,V)=>{let ee=m[R],ye=V[R];return R==="timestamp"&&(ee=new Date(ee).getTime(),ye=new Date(ye).getTime()),O==="asc"?ee>ye?1:-1:ee<ye?1:-1}),n},[$,o,Y,_,R,O]),u=n=>{R===n?de(O==="asc"?"desc":"asc"):(q(n),de("desc"))},t=n=>({critical:"bg-red-500 text-white",high:"bg-orange-500 text-white",medium:"bg-yellow-500 text-white",low:"bg-blue-500 text-white"})[n]||"bg-gray-500 text-white",i=n=>({critical:"border-l-red-500",high:"border-l-orange-500",medium:"border-l-yellow-500",low:"border-l-blue-500"})[n]||"border-l-gray-500",d=h.useMemo(()=>Array.from(new Set($.map(n=>n.type))).filter(Boolean),[$]),p=n=>{xe(n),F(""),K(!0)},M=async n=>{console.log("Marking alert as resolved:",n),K(!1)},we=async n=>{console.log("Marking alert as false positive:",n),K(!1)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-5",children:[e.jsxs(f,{"data-testid":"card-alerts-24h",className:"border-l-4 border-l-blue-500",children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"Last 24 Hours"}),e.jsx(Te,{className:"h-4 w-4 text-blue-500"})]}),e.jsxs(g,{children:[e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-alerts-24h",children:r}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"New alerts"})]})]}),e.jsxs(f,{"data-testid":"card-new-devices",className:"border-l-4 border-l-orange-500",children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"New Device Logins"}),e.jsx(Qe,{className:"h-4 w-4 text-orange-500"})]}),e.jsxs(g,{children:[e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-new-devices",children:l}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Suspicious devices"})]})]}),e.jsxs(f,{"data-testid":"card-new-locations",className:"border-l-4 border-l-purple-500",children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"New Location Logins"}),e.jsx(hs,{className:"h-4 w-4 text-purple-500"})]}),e.jsxs(g,{children:[e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-new-locations",children:j}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Unusual locations"})]})]}),e.jsxs(f,{"data-testid":"card-large-transactions",className:"border-l-4 border-l-yellow-500",children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"Large Transactions"}),e.jsx(_e,{className:"h-4 w-4 text-yellow-500"})]}),e.jsxs(g,{children:[e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-large-txns",children:x}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Flagged amounts"})]})]}),e.jsxs(f,{"data-testid":"card-unresolved",className:"border-l-4 border-l-red-500",children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"Unresolved"}),e.jsx(be,{className:"h-4 w-4 text-red-500"})]}),e.jsxs(g,{children:[e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-unresolved",children:S}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Need attention"})]})]})]}),e.jsxs(f,{"data-testid":"card-priority-info",children:[e.jsx(w,{children:e.jsxs(y,{className:"flex items-center gap-2",children:[e.jsx(be,{className:"h-5 w-5"}),"Alert Priority Levels"]})}),e.jsxs(g,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3 p-3 rounded-lg bg-red-50 dark:bg-red-900/10 border-l-4 border-l-red-500",children:[e.jsx(b,{className:"bg-red-500 text-white",children:"Critical"}),e.jsx("p",{className:"text-sm",children:"Multiple new devices, foreign country login, very large transactions (> NPR 100,000)"})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 rounded-lg bg-orange-50 dark:bg-orange-900/10 border-l-4 border-l-orange-500",children:[e.jsx(b,{className:"bg-orange-500 text-white",children:"High"}),e.jsx("p",{className:"text-sm",children:"New device + new location combo, large cash out without bill (> NPR 50,000)"})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 rounded-lg bg-yellow-50 dark:bg-yellow-900/10 border-l-4 border-l-yellow-500",children:[e.jsx(b,{className:"bg-yellow-500 text-white",children:"Medium"}),e.jsx("p",{className:"text-sm",children:"New device OR new location, wastage without approval"})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 rounded-lg bg-blue-50 dark:bg-blue-900/10 border-l-4 border-l-blue-500",children:[e.jsx(b,{className:"bg-blue-500 text-white",children:"Low"}),e.jsx("p",{className:"text-sm",children:"Information only, routine monitoring"})]})]})]}),e.jsxs(f,{"data-testid":"card-alerts-table",children:[e.jsxs(w,{children:[e.jsxs(y,{className:"flex items-center gap-2",children:[e.jsx(Qe,{className:"h-5 w-5"}),"Security Alerts"]}),e.jsx(ae,{children:"All security alerts and suspicious activities"})]}),e.jsxs(g,{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(re,{value:o,onValueChange:J,children:[e.jsx(ie,{className:"w-[180px]","data-testid":"select-priority-filter",children:e.jsx(le,{placeholder:"All Priorities"})}),e.jsxs(ne,{children:[e.jsx(D,{value:"all",children:"All Priorities"}),e.jsx(D,{value:"critical",children:"Critical"}),e.jsx(D,{value:"high",children:"High"}),e.jsx(D,{value:"medium",children:"Medium"}),e.jsx(D,{value:"low",children:"Low"})]})]}),e.jsxs(re,{value:Y,onValueChange:X,children:[e.jsx(ie,{className:"w-[200px]","data-testid":"select-type-filter",children:e.jsx(le,{placeholder:"All Types"})}),e.jsxs(ne,{children:[e.jsx(D,{value:"all",children:"All Types"}),d.map(n=>e.jsx(D,{value:n,children:n.replace(/_/g," ")},n))]})]}),e.jsxs(re,{value:_,onValueChange:P,children:[e.jsx(ie,{className:"w-[180px]","data-testid":"select-status-filter",children:e.jsx(le,{placeholder:"All Status"})}),e.jsxs(ne,{children:[e.jsx(D,{value:"all",children:"All Status"}),e.jsx(D,{value:"unresolved",children:"Unresolved"}),e.jsx(D,{value:"resolved",children:"Resolved"}),e.jsx(D,{value:"false_positive",children:"False Positive"})]})]})]}),e.jsx("div",{className:"rounded-md border",children:e.jsxs(ze,{children:[e.jsx(We,{children:e.jsxs(G,{children:[e.jsx(A,{className:"cursor-pointer",onClick:()=>u("priority"),"data-testid":"th-priority",children:e.jsxs("div",{className:"flex items-center gap-1",children:["Priority",e.jsx(Se,{className:"h-3 w-3"})]})}),e.jsx(A,{className:"cursor-pointer",onClick:()=>u("type"),"data-testid":"th-type",children:e.jsxs("div",{className:"flex items-center gap-1",children:["Alert Type",e.jsx(Se,{className:"h-3 w-3"})]})}),e.jsx(A,{"data-testid":"th-description",children:"Description"}),e.jsx(A,{"data-testid":"th-staff",children:"Staff Involved"}),e.jsx(A,{className:"cursor-pointer",onClick:()=>u("timestamp"),"data-testid":"th-timestamp",children:e.jsxs("div",{className:"flex items-center gap-1",children:["Time",e.jsx(Se,{className:"h-3 w-3"})]})}),e.jsx(A,{"data-testid":"th-alert-status",children:"Status"}),e.jsx(A,{"data-testid":"th-alert-actions",children:"Actions"})]})}),e.jsx(He,{children:Ne?[...Array(5)].map((n,m)=>e.jsx(G,{children:[...Array(7)].map((V,ee)=>e.jsx(v,{children:e.jsx(k,{className:"h-4 w-full"})},ee))},m)):a.length===0?e.jsx(G,{children:e.jsxs(v,{colSpan:7,className:"text-center py-8","data-testid":"text-no-alerts",children:[e.jsx(Ce,{className:"h-12 w-12 text-green-500 mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"No security alerts found."})]})}):a.map(n=>{var m;return e.jsxs(G,{className:`cursor-pointer border-l-4 ${i(n.priority)}`,onClick:()=>p(n),"data-testid":`alert-row-${n.id}`,children:[e.jsx(v,{"data-testid":`td-priority-${n.id}`,children:e.jsx(b,{className:t(n.priority),children:n.priority})}),e.jsx(v,{className:"text-xs","data-testid":`td-type-${n.id}`,children:n.type.replace(/_/g," ")}),e.jsx(v,{className:"text-xs max-w-[300px]","data-testid":`td-desc-${n.id}`,children:n.description}),e.jsx(v,{className:"text-xs","data-testid":`td-staff-${n.id}`,children:((m=n.staff)==null?void 0:m.username)||"Unknown"}),e.jsx(v,{className:"text-xs whitespace-nowrap","data-testid":`td-time-${n.id}`,children:new Date(n.timestamp).toLocaleString()}),e.jsx(v,{"data-testid":`td-status-${n.id}`,children:e.jsx(b,{variant:n.status==="resolved"?"default":"destructive",className:"text-xs",children:n.status})}),e.jsx(v,{children:e.jsx(T,{variant:"ghost",size:"sm",onClick:V=>{V.stopPropagation(),p(n)},"data-testid":`button-view-alert-${n.id}`,children:e.jsx(us,{className:"h-4 w-4"})})})]},n.id)})})]})})]})]}),e.jsx(Re,{open:ce,onOpenChange:K,children:e.jsxs(Ee,{className:"max-w-3xl max-h-[90vh] overflow-y-auto","data-testid":"modal-alert-details",children:[e.jsxs(Ve,{children:[e.jsxs(Ke,{className:"flex items-center gap-2",children:[e.jsx(be,{className:"h-5 w-5"}),"Security Alert Details"]}),e.jsx(ls,{children:"Review and take action on this security alert"})]}),N&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:`p-4 rounded-lg border-l-4 ${i(N.priority)}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs(b,{className:t(N.priority),children:[N.priority," Priority"]}),e.jsx(b,{variant:"outline",children:N.type.replace(/_/g," ")})]}),e.jsx("p",{className:"font-medium",children:N.description}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:new Date(N.timestamp).toLocaleString()})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-3",children:"Staff Member"}),e.jsxs("div",{className:"p-4 border rounded-lg space-y-2",children:[e.jsxs("p",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"Name:"})," ",((Je=N.staff)==null?void 0:Je.username)||"Unknown"]}),e.jsxs("p",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"Role:"})," ",((Ze=(Xe=N.staff)==null?void 0:Xe.role)==null?void 0:Ze.name)||"N/A"]}),e.jsxs("p",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"Email:"})," ",((Ye=N.staff)==null?void 0:Ye.email)||"N/A"]})]})]}),(N.ipAddress||N.userAgent)&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-3",children:"Device & Location Information"}),e.jsxs("div",{className:"p-4 border rounded-lg space-y-2",children:[N.ipAddress&&e.jsxs("p",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"IP Address:"})," ",N.ipAddress]}),N.userAgent&&e.jsxs("p",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"User Agent:"})," ",N.userAgent]})]})]}),N.amount&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-3",children:"Transaction Details"}),e.jsxs("div",{className:"p-4 border rounded-lg space-y-2",children:[e.jsxs("p",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"Amount:"})," NPR ",N.amount.toLocaleString()]}),e.jsxs("p",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"Purpose:"})," ",((Le=N.relatedData)==null?void 0:Le.purpose)||"N/A"]}),e.jsxs("p",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"Payment Method:"})," ",((Pe=N.relatedData)==null?void 0:Pe.paymentMethod)||"N/A"]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-3",children:"Investigation Notes"}),e.jsx(is,{placeholder:"Add your notes about this alert...",value:te,onChange:n=>F(n.target.value),"data-testid":"input-alert-notes"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 pt-4 border-t",children:[e.jsxs(T,{onClick:()=>M(N.id),className:"bg-green-600 hover:bg-green-700","data-testid":"button-resolve-alert",children:[e.jsx(Ce,{className:"h-4 w-4 mr-2"}),"Mark as Resolved"]}),e.jsxs(T,{variant:"outline",onClick:()=>we(N.id),"data-testid":"button-false-positive",children:[e.jsx(Bs,{className:"h-4 w-4 mr-2"}),"Mark as False Positive"]}),e.jsxs(T,{variant:"outline",onClick:()=>console.log("Contact staff:",N.staff),"data-testid":"button-contact-staff",children:[e.jsx(ds,{className:"h-4 w-4 mr-2"}),"Contact Staff"]}),e.jsxs(T,{variant:"destructive",onClick:()=>console.log("Block device"),"data-testid":"button-block-device",children:[e.jsx(Ge,{className:"h-4 w-4 mr-2"}),"Block Device"]})]})]})]})})]})}function rt({dateRange:C,transactions:o,maintenanceRequests:J,isLoading:Y}){h.useState("all"),h.useState("all");const[X,_]=h.useState("all"),[P,R]=h.useState("all"),[q,O]=h.useState({min:"",max:""}),[de,N]=h.useState(""),[xe,ce]=h.useState(!1),{data:K=[]}=Z({queryKey:["/api/hotels/current/wastages"]}),{data:te=[]}=Z({queryKey:["/api/users"]}),{data:F=[]}=Z({queryKey:["/api/hotels/current/inventory/items"]});De({queryKey:["/api/hotels/current/wastages"],events:["wastage:created","wastage:updated"]});const E=a=>{const u=F.find(t=>t.id===a);return(u==null?void 0:u.name)||"Unknown Item"},z=a=>{const u=te.find(t=>t.id===a);return(u==null?void 0:u.username)||"Unknown"},U=C.from&&C.to?K.filter(a=>{const u=new Date(a.createdAt);return u>=C.from&&u<=C.to}):K,L=U.filter(a=>a.photoUrl).length,ve=o.filter(a=>a.billPhotoUrl).length,oe=o.filter(a=>a.billPdfUrl).length,ge=J.filter(a=>a.photo&&a.photo.trim()!==""||a.photoUrls&&a.photoUrls.length>0).length,Ne=U.filter(a=>!a.photoUrl).length,he=o.filter(a=>a.txnType==="cash_out"&&!a.billPhotoUrl&&!a.billPdfUrl).length,$=Ne+he,ue=h.useMemo(()=>{let a=U.filter(u=>u.photoUrl);return X!=="all"&&(a=a.filter(u=>u.recordedBy===X)),P!=="all"&&(a=a.filter(u=>u.status===P)),a},[U,X,P]),pe=h.useMemo(()=>{let a=o.filter(u=>u.billPhotoUrl||u.billPdfUrl);return X!=="all"&&(a=a.filter(u=>u.createdBy===X)),q.min&&!isNaN(parseFloat(q.min))&&(a=a.filter(u=>parseFloat(u.amount||0)>=parseFloat(q.min))),q.max&&!isNaN(parseFloat(q.max))&&(a=a.filter(u=>parseFloat(u.amount||0)<=parseFloat(q.max))),a},[o,X,q]),me=U.filter(a=>!a.photoUrl),r=o.filter(a=>a.txnType==="cash_out"&&!a.billPhotoUrl&&!a.billPdfUrl),l=a=>{N(a),ce(!0)},j=async(a,u)=>{try{const i=await(await fetch(a)).blob(),d=document.createElement("a");d.href=URL.createObjectURL(i),d.download=u,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(d.href)}catch(t){console.error("Download failed:",t)}},x=()=>{console.log("Download all photos as ZIP - implementation needed")},S=te.filter(a=>a.isActive&&!a.deletedAt);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-5",children:[e.jsxs(f,{"data-testid":"card-wastage-photos",className:"border-l-4 border-l-orange-500",children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"Wastage Photos"}),e.jsx(Be,{className:"h-4 w-4 text-orange-500"})]}),e.jsxs(g,{children:[e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-wastage-photos-count",children:L}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"With photo evidence"})]})]}),e.jsxs(f,{"data-testid":"card-bill-photos",className:"border-l-4 border-l-blue-500",children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"Bill Photos"}),e.jsx(xs,{className:"h-4 w-4 text-blue-500"})]}),e.jsxs(g,{children:[e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-bill-photos-count",children:ve}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Image bills"})]})]}),e.jsxs(f,{"data-testid":"card-bill-pdfs",className:"border-l-4 border-l-purple-500",children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"Bill PDFs"}),e.jsx(qe,{className:"h-4 w-4 text-purple-500"})]}),e.jsxs(g,{children:[e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-bill-pdfs-count",children:oe}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"PDF documents"})]})]}),e.jsxs(f,{"data-testid":"card-maintenance-photos",className:"border-l-4 border-l-green-500",children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"Maintenance Photos"}),e.jsx(qs,{className:"h-4 w-4 text-green-500"})]}),e.jsxs(g,{children:[e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-maintenance-photos-count",children:ge}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Maintenance evidence"})]})]}),e.jsxs(f,{"data-testid":"card-missing-evidence",className:"border-l-4 border-l-red-500",children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"Missing Evidence"}),e.jsx(be,{className:"h-4 w-4 text-red-500"})]}),e.jsxs(g,{children:[e.jsx("div",{className:"text-2xl font-bold text-red-600","data-testid":"text-missing-evidence-count",children:$}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Requires investigation"})]})]})]}),e.jsxs(f,{"data-testid":"card-wastage-gallery",children:[e.jsx(w,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(y,{className:"flex items-center gap-2",children:[e.jsx(Be,{className:"h-5 w-5"}),"Wastage Photo Gallery"]}),e.jsx(ae,{children:"All wastage reports with photo evidence"})]}),e.jsxs(T,{variant:"outline",size:"sm",onClick:x,"data-testid":"button-download-all-wastage",children:[e.jsx(ke,{className:"h-4 w-4 mr-2"}),"Download All"]})]})}),e.jsxs(g,{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(re,{value:X,onValueChange:_,children:[e.jsx(ie,{className:"w-[200px]","data-testid":"select-wastage-staff-filter",children:e.jsx(le,{placeholder:"All Staff"})}),e.jsxs(ne,{children:[e.jsx(D,{value:"all",children:"All Staff"}),S.map(a=>e.jsx(D,{value:a.id,children:a.username},a.id))]})]}),e.jsxs(re,{value:P,onValueChange:R,children:[e.jsx(ie,{className:"w-[200px]","data-testid":"select-approval-filter",children:e.jsx(le,{placeholder:"All Status"})}),e.jsxs(ne,{children:[e.jsx(D,{value:"all",children:"All Status"}),e.jsx(D,{value:"pending_approval",children:"Pending Approval"}),e.jsx(D,{value:"approved",children:"Approved"}),e.jsx(D,{value:"rejected",children:"Rejected"})]})]})]}),Y?e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4",children:[...Array(8)].map((a,u)=>e.jsx(k,{className:"h-64 w-full rounded-lg"},u))}):ue.length===0?e.jsxs("div",{className:"text-center py-12","data-testid":"text-no-wastage-photos",children:[e.jsx(Be,{className:"h-16 w-16 text-muted-foreground mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"No wastage photos found for the selected filters."})]}):e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4",children:ue.map(a=>{var u;return e.jsxs("div",{className:"relative group border rounded-lg overflow-hidden","data-testid":`wastage-photo-${a.id}`,children:[e.jsx("img",{src:a.photoUrl,alt:`Wastage ${a.id}`,loading:"lazy",className:"w-full h-48 object-cover cursor-pointer transition-transform group-hover:scale-105",onClick:()=>l(a.photoUrl)}),e.jsx("div",{className:"absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(T,{size:"sm",variant:"secondary",onClick:t=>{t.stopPropagation(),j(a.photoUrl,`wastage-${a.id}.jpg`)},"data-testid":`button-download-wastage-${a.id}`,children:e.jsx(ke,{className:"h-3 w-3"})})}),e.jsxs("div",{className:"p-3 bg-background",children:[e.jsx("p",{className:"font-medium text-sm truncate","data-testid":`wastage-item-${a.id}`,children:E(a.itemId)}),e.jsxs("p",{className:"text-xs text-muted-foreground","data-testid":`wastage-qty-${a.id}`,children:["Qty: ",a.qty," ",a.unit]}),e.jsxs("p",{className:"text-xs text-muted-foreground truncate","data-testid":`wastage-staff-${a.id}`,children:["By: ",z(a.recordedBy)]}),e.jsx("p",{className:"text-xs text-muted-foreground","data-testid":`wastage-date-${a.id}`,children:new Date(a.createdAt).toLocaleDateString()}),e.jsx("p",{className:"text-xs mt-1 text-muted-foreground truncate",title:a.reason,children:a.reason}),e.jsx(b,{className:"mt-2 text-xs",variant:a.status==="approved"?"default":a.status==="rejected"?"destructive":"secondary","data-testid":`wastage-status-${a.id}`,children:(u=a.status)==null?void 0:u.replace(/_/g," ")})]})]},a.id)})})]})]}),e.jsxs(f,{"data-testid":"card-bill-gallery",children:[e.jsx(w,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(y,{className:"flex items-center gap-2",children:[e.jsx(Oe,{className:"h-5 w-5"}),"Bill Documents Gallery"]}),e.jsx(ae,{children:"All cash-out transactions with bill proofs"})]}),e.jsxs(T,{variant:"outline",size:"sm",onClick:x,"data-testid":"button-download-all-bills",children:[e.jsx(ke,{className:"h-4 w-4 mr-2"}),"Download All"]})]})}),e.jsxs(g,{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(re,{value:X,onValueChange:_,children:[e.jsx(ie,{className:"w-[200px]","data-testid":"select-bill-staff-filter",children:e.jsx(le,{placeholder:"All Staff"})}),e.jsxs(ne,{children:[e.jsx(D,{value:"all",children:"All Staff"}),S.map(a=>e.jsx(D,{value:a.id,children:a.username},a.id))]})]}),e.jsx(is,{type:"number",placeholder:"Min Amount",value:q.min,onChange:a=>O({...q,min:a.target.value}),className:"w-[150px]","data-testid":"input-min-amount"}),e.jsx(is,{type:"number",placeholder:"Max Amount",value:q.max,onChange:a=>O({...q,max:a.target.value}),className:"w-[150px]","data-testid":"input-max-amount"})]}),Y?e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4",children:[...Array(8)].map((a,u)=>e.jsx(k,{className:"h-64 w-full rounded-lg"},u))}):pe.length===0?e.jsxs("div",{className:"text-center py-12","data-testid":"text-no-bills",children:[e.jsx(Oe,{className:"h-16 w-16 text-muted-foreground mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"No bill documents found for the selected filters."})]}):e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4",children:pe.map(a=>{var u;return e.jsxs("div",{className:"relative group border rounded-lg overflow-hidden","data-testid":`bill-doc-${a.id}`,children:[a.billPdfUrl?e.jsx("div",{className:"h-48 flex items-center justify-center bg-gray-100 dark:bg-gray-800 cursor-pointer",onClick:()=>window.open(a.billPdfUrl,"_blank"),children:e.jsx(qe,{className:"h-16 w-16 text-muted-foreground"})}):e.jsx("img",{src:a.billPhotoUrl,alt:`Bill ${a.id}`,loading:"lazy",className:"w-full h-48 object-cover cursor-pointer transition-transform group-hover:scale-105",onClick:()=>l(a.billPhotoUrl)}),e.jsx("div",{className:"absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(T,{size:"sm",variant:"secondary",onClick:t=>{t.stopPropagation();const i=a.billPdfUrl||a.billPhotoUrl,d=a.billPdfUrl?"pdf":"jpg";j(i,`bill-${a.id}.${d}`)},"data-testid":`button-download-bill-${a.id}`,children:e.jsx(ke,{className:"h-3 w-3"})})}),e.jsxs("div",{className:"p-3 bg-background",children:[a.billInvoiceNumber&&e.jsxs("p",{className:"font-medium text-sm truncate","data-testid":`bill-invoice-${a.id}`,children:["Invoice: ",a.billInvoiceNumber]}),e.jsx("p",{className:"text-sm font-bold text-blue-600","data-testid":`bill-amount-${a.id}`,children:Q(parseFloat(a.amount||0))}),e.jsxs("p",{className:"text-xs text-muted-foreground truncate","data-testid":`bill-staff-${a.id}`,children:["By: ",((u=a.creator)==null?void 0:u.username)||"Unknown"]}),e.jsx("p",{className:"text-xs text-muted-foreground","data-testid":`bill-date-${a.id}`,children:new Date(a.createdAt).toLocaleDateString()}),e.jsx(b,{className:"mt-2 text-xs","data-testid":`bill-type-${a.id}`,children:a.billPdfUrl?"PDF":"Image"})]})]},a.id)})})]})]}),$>0&&e.jsxs(f,{"data-testid":"card-missing-evidence-alert",className:"border-l-4 border-l-red-500",children:[e.jsxs(w,{children:[e.jsxs(y,{className:"flex items-center gap-2 text-red-600",children:[e.jsx(be,{className:"h-5 w-5"}),"Missing Evidence Alert"]}),e.jsx(ae,{children:"Items requiring photo or bill documentation"})]}),e.jsxs(g,{className:"space-y-4",children:[me.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"font-semibold mb-3 flex items-center gap-2",children:[e.jsx(Be,{className:"h-4 w-4"}),"Wastages Without Photos (",me.length,")"]}),e.jsx("div",{className:"space-y-2",children:me.slice(0,10).map(a=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg bg-red-50 dark:bg-red-900/10","data-testid":`missing-wastage-${a.id}`,children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-sm",children:E(a.itemId)}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Qty: ",a.qty," ",a.unit," • By: ",z(a.recordedBy)]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:new Date(a.createdAt).toLocaleString()})]}),e.jsx(b,{variant:"destructive",children:"No Photo"})]},a.id))})]}),r.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"font-semibold mb-3 flex items-center gap-2",children:[e.jsx(Oe,{className:"h-4 w-4"}),"Cash-outs Without Bills (",r.length,")"]}),e.jsx("div",{className:"space-y-2",children:r.slice(0,10).map(a=>{var u;return e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg bg-red-50 dark:bg-red-900/10","data-testid":`missing-bill-${a.id}`,children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-sm",children:a.purpose||"No description"}),e.jsx("p",{className:"text-sm font-bold text-red-600",children:Q(parseFloat(a.amount||0))}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["By: ",((u=a.creator)==null?void 0:u.username)||"Unknown"," • ",new Date(a.createdAt).toLocaleString()]})]}),e.jsx(b,{variant:"destructive",children:"No Bill"})]},a.id)})})]})]})]}),e.jsx(Re,{open:xe,onOpenChange:ce,children:e.jsxs(Ee,{className:"max-w-5xl max-h-[90vh]","data-testid":"modal-lightbox",children:[e.jsx(Ve,{children:e.jsx(Ke,{children:"Photo Evidence"})}),e.jsx("div",{className:"flex items-center justify-center max-h-[75vh] overflow-auto",children:de&&e.jsx("img",{src:de,alt:"Evidence",className:"max-w-full max-h-full object-contain","data-testid":"lightbox-image"})}),e.jsx("div",{className:"flex justify-end gap-2",children:e.jsxs(T,{variant:"outline",onClick:()=>j(de,"evidence.jpg"),"data-testid":"button-download-lightbox",children:[e.jsx(ke,{className:"h-4 w-4 mr-2"}),"Download"]})})]})})]})}function it({dateRange:C}){var pe,me;const{toast:o}=Ws(),[J,Y]=h.useState("all"),[X,_]=h.useState({}),[P,R]=h.useState(null),[q,O]=h.useState(!1),de=(r,l,j)=>{if(!l||!j)return r;const x=new URLSearchParams({startDate:l.toISOString(),endDate:j.toISOString()});return`${r}?${x.toString()}`},{data:N=[],isLoading:xe}=Z({queryKey:["/api/login-history",(pe=C.from)==null?void 0:pe.toISOString(),(me=C.to)==null?void 0:me.toISOString()],queryFn:async()=>{const r=de("/api/login-history",C.from,C.to),l=await fetch(r,{credentials:"include"});return l.ok?l.json():[]},refetchInterval:3e4}),{data:ce=[]}=Z({queryKey:["/api/users"]});De({queryKey:["/api/login-history"],events:["login:created"]});const K=h.useMemo(()=>{const r=new Map;return N.forEach(l=>{var S;const j=l.deviceFingerprint||"unknown";r.has(j)||r.set(j,{fingerprint:j,browser:l.browser||"Unknown",os:l.os||"Unknown",firstSeen:l.loginAt,lastSeen:l.loginAt,loginCount:0,users:new Set,logins:[]});const x=r.get(j);x.loginCount++,x.users.add(((S=l.user)==null?void 0:S.username)||"Unknown"),x.logins.push(l),new Date(l.loginAt)<new Date(x.firstSeen)&&(x.firstSeen=l.loginAt),new Date(l.loginAt)>new Date(x.lastSeen)&&(x.lastSeen=l.loginAt)}),Array.from(r.values()).map(l=>({...l,users:Array.from(l.users),trustStatus:X[l.fingerprint]||"trusted"})).sort((l,j)=>new Date(j.lastSeen).getTime()-new Date(l.lastSeen).getTime())},[N,X]),te=h.useMemo(()=>{const r=new Map;return N.forEach(l=>{var i;const j=l.location||"Unknown",[x,S]=j.split(", "),a=l.ip||"Unknown",u=j;r.has(u)||r.set(u,{city:x||"Unknown",country:S||"Unknown",location:j,ip:a,firstSeen:l.loginAt,lastSeen:l.loginAt,loginCount:0,users:new Set,logins:[]});const t=r.get(u);t.loginCount++,t.users.add(((i=l.user)==null?void 0:i.username)||"Unknown"),t.logins.push(l),new Date(l.loginAt)<new Date(t.firstSeen)&&(t.firstSeen=l.loginAt),new Date(l.loginAt)>new Date(t.lastSeen)&&(t.lastSeen=l.loginAt)}),Array.from(r.values()).map(l=>({...l,users:Array.from(l.users)})).sort((l,j)=>new Date(j.lastSeen).getTime()-new Date(l.lastSeen).getTime())},[N]),F=h.useMemo(()=>{const r=[],l=new Map;N.forEach(x=>{const S=x.userId;l.has(S)||l.set(S,[]),l.get(S).push(x)}),l.forEach((x,S)=>{var t;const a=x.sort((i,d)=>new Date(i.loginAt).getTime()-new Date(d.loginAt).getTime());for(let i=0;i<a.length-1;i++){const d=a[i],p=a[i+1],M=(new Date(p.loginAt).getTime()-new Date(d.loginAt).getTime())/(1e3*60);d.location!==p.location&&M<60&&r.push({type:"impossible_travel",severity:"high",user:d.user,description:`${((t=d.user)==null?void 0:t.username)||"User"} logged in from ${p.location} just ${Math.round(M)} minutes after logging in from ${d.location}`,timestamp:p.loginAt,details:{login1:d,login2:p}})}x.forEach(i=>{var p;const[,d]=(i.location||"").split(", ");d&&d!=="Nepal"&&d!=="Unknown"&&r.push({type:"foreign_login",severity:"medium",user:i.user,description:`${((p=i.user)==null?void 0:p.username)||"User"} logged in from ${i.location}`,timestamp:i.loginAt,details:{login:i}})});const u=new Map;x.forEach(i=>{if(i.isNewDevice){const d=i.deviceFingerprint;u.has(d)||u.set(d,[]),u.get(d).push(i)}}),u.forEach(i=>{var d;if(i.length>2){const p=i[0];r.push({type:"new_device_multiple",severity:"medium",user:p.user,description:`New device used ${i.length} times by ${((d=p.user)==null?void 0:d.username)||"User"}`,timestamp:p.loginAt,details:{logins:i}})}})});const j=new Map;return N.forEach(x=>{var a;const S=x.deviceFingerprint;j.has(S)||j.set(S,new Set),j.get(S).add((a=x.user)==null?void 0:a.username)}),j.forEach((x,S)=>{if(x.size>1){const a=K.find(u=>u.fingerprint===S);r.push({type:"shared_device",severity:"low",user:{username:"Multiple Users"},description:`Device shared by ${x.size} users: ${Array.from(x).join(", ")}`,timestamp:(a==null?void 0:a.lastSeen)||new Date().toISOString(),details:{device:a,users:Array.from(x)}})}}),r.sort((x,S)=>new Date(S.timestamp).getTime()-new Date(x.timestamp).getTime())},[N,K]),E=h.useMemo(()=>N.map(r=>({...r,novelty:r.isNewDevice?"new-device":r.isNewLocation?"new-location":"normal"})).sort((r,l)=>new Date(l.loginAt).getTime()-new Date(r.loginAt).getTime()),[N]),z=h.useMemo(()=>J==="all"?E:E.filter(r=>r.userId===J),[E,J]),U=async(r,l)=>{try{const j=K.find(S=>S.fingerprint===r);if(!j||!j.logins||j.logins.length===0){o({title:"Error",description:"Could not find device information",variant:"destructive"});return}const x=Array.from(new Set(j.logins.map(S=>S.userId).filter(Boolean)));if(x.length===0){o({title:"Error",description:"No users associated with this device",variant:"destructive"});return}for(const S of x){const a=await fetch("/api/devices/update-trust-status",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({userId:S,deviceFingerprint:r,trustStatus:l})});if(!a.ok){const u=await a.json();throw new Error(u.message||"Failed to update device trust status")}}_(S=>({...S,[r]:l})),Hs.invalidateQueries({queryKey:["/api/login-history"]}),o({title:"Success",description:`Device marked as ${l}`})}catch(j){console.error("Error updating device trust status:",j),o({title:"Error",description:j instanceof Error?j.message:"Failed to update device trust status",variant:"destructive"})}},L=r=>{R(r),O(!0)},ve=r=>{if(!r||r==="Unknown")return"Unknown";const l=r.split(".");return l.length===4?`${l[0]}.${l[1]}.***.**`:r.substring(0,10)+"..."},oe=r=>!r||r==="unknown"?"Unknown":r.substring(0,12)+"...",ge=r=>r==="high"?"text-red-600 dark:text-red-400":r==="medium"?"text-orange-600 dark:text-orange-400":"text-yellow-600 dark:text-yellow-400",Ne=r=>r==="high"?"bg-red-50 dark:bg-red-900/10 border-l-4 border-l-red-500":r==="medium"?"bg-orange-50 dark:bg-orange-900/10 border-l-4 border-l-orange-500":"bg-yellow-50 dark:bg-yellow-900/10 border-l-4 border-l-yellow-500",he=r=>r==="new-device"?"bg-red-100 dark:bg-red-900/20 text-red-800 dark:text-red-300":r==="new-location"?"bg-orange-100 dark:bg-orange-900/20 text-orange-800 dark:text-orange-300":"bg-green-100 dark:bg-green-900/20 text-green-800 dark:text-green-300",$=r=>r==="trusted"?"bg-green-500 text-white":r==="suspicious"?"bg-orange-500 text-white":r==="blocked"?"bg-red-500 text-white":"bg-gray-500 text-white",ue=()=>{const r={devices:K,locations:te,anomalies:F,timeline:E},l=new Blob([JSON.stringify(r,null,2)],{type:"application/json"}),j=URL.createObjectURL(l),x=document.createElement("a");x.href=j,x.download=`device-location-history-${new Date().toISOString()}.json`,document.body.appendChild(x),x.click(),document.body.removeChild(x),URL.revokeObjectURL(j)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Device & Location History"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Track staff access patterns, devices, and locations"})]}),e.jsxs(T,{onClick:ue,variant:"outline","data-testid":"button-export-device-history",children:[e.jsx(ke,{className:"h-4 w-4 mr-2"}),"Export Data"]})]}),e.jsxs(f,{"data-testid":"card-known-devices",children:[e.jsxs(w,{children:[e.jsxs(y,{className:"flex items-center gap-2",children:[e.jsx(Qe,{className:"h-5 w-5"}),"Known Devices"]}),e.jsx(ae,{children:"All unique devices that have accessed the system"})]}),e.jsx(g,{children:xe?e.jsx("div",{className:"space-y-3",children:[...Array(3)].map((r,l)=>e.jsx(k,{className:"h-20 w-full"},l))}):K.length===0?e.jsx("p",{className:"text-center py-8 text-muted-foreground","data-testid":"text-no-devices",children:"No device history found."}):e.jsx("div",{className:"space-y-3",children:K.map(r=>e.jsx("div",{className:"p-4 border rounded-lg hover:bg-muted/50 transition-colors cursor-pointer",onClick:()=>L(r),"data-testid":`device-${r.fingerprint.substring(0,8)}`,children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("code",{className:"text-sm font-mono bg-muted px-2 py-1 rounded",children:oe(r.fingerprint)}),e.jsx(b,{className:$(r.trustStatus),children:r.trustStatus})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Browser & OS"}),e.jsxs("p",{className:"font-medium",children:[r.browser," on ",r.os]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"First Seen"}),e.jsx("p",{className:"font-medium",children:new Date(r.firstSeen).toLocaleDateString()})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Last Seen"}),e.jsx("p",{className:"font-medium",children:new Date(r.lastSeen).toLocaleDateString()})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Logins"}),e.jsx("p",{className:"font-medium",children:r.loginCount})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground text-sm",children:"Associated Users"}),e.jsx("div",{className:"flex flex-wrap gap-1 mt-1",children:r.users.map(l=>e.jsx(b,{variant:"outline",className:"text-xs",children:l},l))})]})]}),e.jsxs("div",{className:"flex gap-2 ml-4",children:[e.jsx(T,{variant:"ghost",size:"sm",onClick:l=>{l.stopPropagation(),U(r.fingerprint,"trusted")},"data-testid":`button-trust-${r.fingerprint.substring(0,8)}`,children:e.jsx(Ce,{className:"h-4 w-4"})}),e.jsx(T,{variant:"ghost",size:"sm",onClick:l=>{l.stopPropagation(),U(r.fingerprint,"blocked")},"data-testid":`button-block-${r.fingerprint.substring(0,8)}`,children:e.jsx(Ge,{className:"h-4 w-4 text-red-500"})})]})]})},r.fingerprint))})})]}),e.jsxs(f,{"data-testid":"card-known-locations",children:[e.jsxs(w,{children:[e.jsxs(y,{className:"flex items-center gap-2",children:[e.jsx(hs,{className:"h-5 w-5"}),"Known Locations"]}),e.jsx(ae,{children:"All unique locations from where staff logged in"})]}),e.jsx(g,{children:xe?e.jsx("div",{className:"space-y-3",children:[...Array(3)].map((r,l)=>e.jsx(k,{className:"h-16 w-full"},l))}):te.length===0?e.jsx("p",{className:"text-center py-8 text-muted-foreground","data-testid":"text-no-locations",children:"No location history found."}):e.jsx("div",{className:"rounded-md border",children:e.jsxs(ze,{children:[e.jsx(We,{children:e.jsxs(G,{children:[e.jsx(A,{"data-testid":"th-location",children:"Location"}),e.jsx(A,{"data-testid":"th-ip",children:"IP Address"}),e.jsx(A,{"data-testid":"th-first-seen",children:"First Seen"}),e.jsx(A,{"data-testid":"th-last-seen",children:"Last Seen"}),e.jsx(A,{"data-testid":"th-login-count",children:"Login Count"}),e.jsx(A,{"data-testid":"th-users",children:"Users"})]})}),e.jsx(He,{children:te.map((r,l)=>e.jsxs(G,{"data-testid":`location-row-${l}`,children:[e.jsx(v,{className:"font-medium","data-testid":`td-location-${l}`,children:e.jsxs("div",{children:[e.jsx("p",{children:r.city}),e.jsx("p",{className:"text-xs text-muted-foreground",children:r.country})]})}),e.jsx(v,{className:"font-mono text-sm","data-testid":`td-ip-${l}`,children:ve(r.ip)}),e.jsx(v,{className:"text-sm","data-testid":`td-first-${l}`,children:new Date(r.firstSeen).toLocaleString()}),e.jsx(v,{className:"text-sm","data-testid":`td-last-${l}`,children:new Date(r.lastSeen).toLocaleString()}),e.jsx(v,{"data-testid":`td-count-${l}`,children:e.jsx(b,{variant:"outline",children:r.loginCount})}),e.jsx(v,{"data-testid":`td-users-${l}`,children:e.jsxs("div",{className:"flex flex-wrap gap-1",children:[r.users.slice(0,3).map(j=>e.jsx(b,{variant:"secondary",className:"text-xs",children:j},j)),r.users.length>3&&e.jsxs(b,{variant:"secondary",className:"text-xs",children:["+",r.users.length-3]})]})})]},l))})]})})})]}),e.jsxs(f,{"data-testid":"card-anomalies",children:[e.jsxs(w,{children:[e.jsxs(y,{className:"flex items-center gap-2",children:[e.jsx(be,{className:"h-5 w-5 text-orange-500"}),"Anomaly Detection"]}),e.jsx(ae,{children:"Unusual access patterns and security alerts"})]}),e.jsx(g,{children:xe?e.jsx("div",{className:"space-y-3",children:[...Array(3)].map((r,l)=>e.jsx(k,{className:"h-16 w-full"},l))}):F.length===0?e.jsxs("div",{className:"text-center py-8","data-testid":"text-no-anomalies",children:[e.jsx(Ce,{className:"h-12 w-12 text-green-500 mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"No anomalies detected. All access patterns are normal."})]}):e.jsx("div",{className:"space-y-3",children:F.map((r,l)=>e.jsx("div",{className:`p-4 rounded-lg ${Ne(r.severity)}`,"data-testid":`anomaly-${l}`,children:e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(b,{className:ge(r.severity),children:r.severity.toUpperCase()}),e.jsx(b,{variant:"outline",className:"text-xs",children:r.type.replace(/_/g," ")})]}),e.jsx("p",{className:"font-medium",children:r.description}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:new Date(r.timestamp).toLocaleString()})]})})},l))})})]}),e.jsxs(f,{"data-testid":"card-access-timeline",children:[e.jsxs(w,{children:[e.jsxs(y,{className:"flex items-center gap-2",children:[e.jsx(Te,{className:"h-5 w-5"}),"Access Timeline"]}),e.jsx(ae,{children:"Chronological view of all login events"})]}),e.jsxs(g,{className:"space-y-4",children:[e.jsxs(re,{value:J,onValueChange:Y,children:[e.jsx(ie,{className:"w-[250px]","data-testid":"select-timeline-staff",children:e.jsx(le,{placeholder:"Filter by staff"})}),e.jsxs(ne,{children:[e.jsx(D,{value:"all",children:"All Staff"}),ce.filter(r=>r.isActive&&!r.deletedAt).map(r=>e.jsx(D,{value:r.id,children:r.username},r.id))]})]}),xe?e.jsx("div",{className:"space-y-3",children:[...Array(5)].map((r,l)=>e.jsx(k,{className:"h-16 w-full"},l))}):z.length===0?e.jsx("p",{className:"text-center py-8 text-muted-foreground","data-testid":"text-no-timeline",children:"No login events found."}):e.jsx("div",{className:"space-y-2",children:z.slice(0,50).map((r,l)=>{var j,x,S;return e.jsxs("div",{className:"flex items-center gap-4 p-3 border rounded-lg hover:bg-muted/50 transition-colors","data-testid":`timeline-event-${l}`,children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${he(r.novelty)}`}),e.jsxs("div",{className:"flex-1 grid grid-cols-1 md:grid-cols-4 gap-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:((j=r.user)==null?void 0:j.username)||"Unknown"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:((S=(x=r.user)==null?void 0:x.role)==null?void 0:S.name)||"N/A"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Device"}),e.jsxs("p",{children:[r.browser," / ",r.os]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Location"}),e.jsx("p",{children:r.location||"Unknown"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Time"}),e.jsx("p",{children:new Date(r.loginAt).toLocaleString()})]})]}),e.jsx("div",{children:e.jsx(b,{className:he(r.novelty),variant:"outline",children:r.novelty==="new-device"?"New Device":r.novelty==="new-location"?"New Location":"Normal"})})]},l)})})]})]}),e.jsx(Re,{open:q,onOpenChange:O,children:e.jsxs(Ee,{className:"max-w-3xl","data-testid":"modal-device-details",children:[e.jsxs(Ve,{children:[e.jsx(Ke,{children:"Device Details"}),e.jsx(ls,{children:"Complete information about this device"})]}),P&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Device Fingerprint"}),e.jsx("code",{className:"text-sm font-mono",children:P.fingerprint})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Trust Status"}),e.jsx(b,{className:$(P.trustStatus),children:P.trustStatus})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Browser"}),e.jsx("p",{className:"text-sm",children:P.browser})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Operating System"}),e.jsx("p",{className:"text-sm",children:P.os})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"First Seen"}),e.jsx("p",{className:"text-sm",children:new Date(P.firstSeen).toLocaleString()})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Last Seen"}),e.jsx("p",{className:"text-sm",children:new Date(P.lastSeen).toLocaleString()})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Total Logins"}),e.jsx("p",{className:"text-sm",children:P.loginCount})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Associated Users"}),e.jsx("div",{className:"flex flex-wrap gap-1 mt-1",children:P.users.map(r=>e.jsx(b,{variant:"outline",className:"text-xs",children:r},r))})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground mb-2",children:"Recent Login History"}),e.jsx("div",{className:"max-h-[200px] overflow-y-auto space-y-2",children:P.logins.slice(0,10).map((r,l)=>{var j;return e.jsxs("div",{className:"text-sm p-2 border rounded",children:[e.jsxs("p",{children:[e.jsx("strong",{children:(j=r.user)==null?void 0:j.username})," - ",new Date(r.loginAt).toLocaleString()]}),e.jsx("p",{className:"text-muted-foreground text-xs",children:r.location})]},l)})})]}),e.jsxs("div",{className:"flex gap-2 pt-4 border-t",children:[e.jsxs(T,{onClick:()=>{U(P.fingerprint,"trusted"),O(!1)},className:"bg-green-600 hover:bg-green-700","data-testid":"button-modal-trust",children:[e.jsx(Ce,{className:"h-4 w-4 mr-2"}),"Mark as Trusted"]}),e.jsxs(T,{variant:"destructive",onClick:()=>{U(P.fingerprint,"blocked"),O(!1)},"data-testid":"button-modal-block",children:[e.jsx(Ge,{className:"h-4 w-4 mr-2"}),"Block Device"]})]})]})]})})]})}function yt(){var vs,ws,ys,bs,Ss,As,Ds,ks,Ts,Cs;const[,C]=zs(),[o,J]=h.useState({from:void 0,to:void 0}),[Y,X]=h.useState("overview"),[_,P]=h.useState("createdAt"),[R,q]=h.useState("desc"),[O,de]=h.useState("all"),[N,xe]=h.useState("all"),[ce,K]=h.useState("all"),[te,F]=h.useState(""),[E,z]=h.useState(1),U=20,[L,ve]=h.useState(null),[oe,ge]=h.useState(""),[Ne,he]=h.useState(!1),[$,ue]=h.useState(!1),pe=()=>{const s=new Date;J({from:as(s),to:ms(s)})},me=()=>{const s=new Date;J({from:as($s(s,7)),to:ms(s)})},r=()=>{const s=new Date;J({from:as($s(s,30)),to:ms(s)})},l=()=>{J({from:void 0,to:void 0})},j=s=>{console.log(`Exporting as ${s}`)},{data:x=[],isLoading:S}=Z({queryKey:["/api/hotels/current/transactions"]}),{data:a=[],isLoading:u}=Z({queryKey:["/api/hotels/current/maintenance-requests"]});De({queryKey:["/api/hotels/current/transactions"],events:["transaction:created","transaction:updated"]}),De({queryKey:["/api/hotels/current/maintenance-requests"],events:["maintenance:updated"]});const t=o.from&&o.to?x.filter(s=>{const c=new Date(s.createdAt);return c>=o.from&&c<=o.to}):x,i=o.from&&o.to?a.filter(s=>{const c=new Date(s.createdAt);return c>=o.from&&c<=o.to}):a,d=(s,c,I)=>{if(!c||!I)return s;const B=new URLSearchParams({startDate:c.toISOString(),endDate:I.toISOString()});return`${s}?${B.toString()}`},{data:p=[],isLoading:M}=Z({queryKey:["/api/audit-logs",(vs=o.from)==null?void 0:vs.toISOString(),(ws=o.to)==null?void 0:ws.toISOString()],queryFn:async()=>{const s=d("/api/audit-logs",o.from,o.to),c=await fetch(s,{credentials:"include"});return c.ok?c.json():[]},refetchInterval:5e3}),{data:we=[],isLoading:W}=Z({queryKey:["/api/price-change-logs",(ys=o.from)==null?void 0:ys.toISOString(),(bs=o.to)==null?void 0:bs.toISOString()],queryFn:async()=>{const s=d("/api/price-change-logs",o.from,o.to),c=await fetch(s,{credentials:"include"});return c.ok?c.json():[]},refetchInterval:1e4}),{data:cs=[],isLoading:Je}=Z({queryKey:["/api/inventory-movement-logs",(Ss=o.from)==null?void 0:Ss.toISOString(),(As=o.to)==null?void 0:As.toISOString()],queryFn:async()=>{const s=d("/api/inventory-movement-logs",o.from,o.to),c=await fetch(s,{credentials:"include"});return c.ok?c.json():[]},refetchInterval:1e4}),{data:Xe=[],isLoading:Ze}=Z({queryKey:["/api/staff-activity-summary",(Ds=o.from)==null?void 0:Ds.toISOString(),(ks=o.to)==null?void 0:ks.toISOString()],queryFn:async()=>{const s=d("/api/staff-activity-summary",o.from,o.to),c=await fetch(s,{credentials:"include"});return c.ok?c.json():[]},refetchInterval:1e4}),Ye=new Date,Le=x.filter(s=>new Date(s.createdAt).toDateString()===Ye.toDateString()),Pe=Le.filter(s=>{var c;return s.txnType==="revenue"||((c=s.txnType)==null?void 0:c.includes("_in"))}).reduce((s,c)=>s+parseFloat(c.amount||0),0),n=Le.filter(s=>{var c;return s.txnType==="expense"||((c=s.txnType)==null?void 0:c.includes("_out"))}).reduce((s,c)=>s+parseFloat(c.amount||0),0),m=new Set(Xe.map(s=>s.userId)).size,V=a.filter(s=>s.status==="pending").length,ee=new Date(Date.now()-24*60*60*1e3),ye=p.filter(s=>new Date(s.createdAt)>=ee&&!s.success).length,es=Pe>0?(Pe/(n||1)).toFixed(2):"0.00",ps=p.slice(0,10),js=h.useMemo(()=>t.filter(s=>{var c;return s.txnType==="revenue"||((c=s.txnType)==null?void 0:c.includes("_in"))}).reduce((s,c)=>s+parseFloat(c.amount||0),0),[t]),fs=h.useMemo(()=>t.filter(s=>{var c;return s.txnType==="expense"||((c=s.txnType)==null?void 0:c.includes("_out"))}).reduce((s,c)=>s+parseFloat(c.amount||0),0),[t]),Me=js-fs,Ie=h.useMemo(()=>t.length===0?null:t.reduce((s,c)=>parseFloat(c.amount||0)>parseFloat(s.amount||0)?c:s,t[0]),[t]),Os=h.useMemo(()=>t.filter(s=>s.isVoided).length,[t]),je=h.useMemo(()=>{const s={cash:0,pos:0,fonepay:0,other:0};return t.forEach(c=>{var fe;const I=parseFloat(c.amount||0),B=((fe=c.paymentMethod)==null?void 0:fe.toLowerCase())||"other";B==="cash"?s.cash+=I:B==="pos"?s.pos+=I:B==="fonepay"?s.fonepay+=I:s.other+=I}),s},[t]),Ae=je.cash+je.pos+je.fonepay+je.other,se=h.useMemo(()=>({large:t.filter(c=>parseFloat(c.amount||0)>=5e4),noBillProof:t.filter(c=>{var I;return((I=c.txnType)==null?void 0:I.includes("_out"))&&!c.billPhotoUrl&&!c.billPdfUrl}),voided:t.filter(c=>c.isVoided),requiresApproval:t.filter(c=>c.requiresApproval&&!c.approvedBy)}),[t]),ss=h.useMemo(()=>{let s=[...t];if(O!=="all"&&(s=s.filter(c=>c.txnType===O)),N!=="all"&&(s=s.filter(c=>{var I;return((I=c.paymentMethod)==null?void 0:I.toLowerCase())===N.toLowerCase()})),ce!=="all"&&(s=s.filter(c=>c.createdBy===ce)),te){const c=te.toLowerCase();s=s.filter(I=>{var B,fe,Ls,Ps;return((B=I.purpose)==null?void 0:B.toLowerCase().includes(c))||((fe=I.reference)==null?void 0:fe.toLowerCase().includes(c))||((Ps=(Ls=I.creator)==null?void 0:Ls.username)==null?void 0:Ps.toLowerCase().includes(c))})}return s.sort((c,I)=>{let B=c[_],fe=I[_];return _==="amount"?(B=parseFloat(B||0),fe=parseFloat(fe||0)):_==="createdAt"&&(B=new Date(B).getTime(),fe=new Date(fe).getTime()),R==="asc"?B>fe?1:-1:B<fe?1:-1}),s},[t,O,N,ce,te,_,R]),ts=Math.ceil(ss.length/U),gs=ss.slice((E-1)*U,E*U),Rs=h.useMemo(()=>Array.from(new Set(x.map(s=>s.txnType))).filter(Boolean),[x]),Es=h.useMemo(()=>Array.from(new Set(x.map(s=>s.paymentMethod))).filter(Boolean),[x]),Vs=h.useMemo(()=>Array.from(new Set(x.map(s=>s.creator).filter(Boolean))),[x]),os=s=>{_===s?q(R==="asc"?"desc":"asc"):(P(s),q("desc"))},$e=s=>{ve(s),he(!0)},Ns=s=>{ge(s),ue(!0)},H=S||u||M||W||Je||Ze;return e.jsxs("div",{className:"space-y-6 p-4 md:p-6 bg-gradient-to-br from-background to-muted/20 min-h-screen",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(T,{variant:"outline",size:"icon",onClick:()=>C("/owner"),"data-testid":"button-back",className:"shrink-0",children:e.jsx(Xs,{className:"h-4 w-4"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold bg-gradient-to-r from-primary to-primary/60 bg-clip-text text-transparent","data-testid":"heading-audit-transparency",children:"Audit & Transparency Center"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Complete oversight of all hotel operations and financial activities"})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs(Fs,{children:[e.jsx(Us,{asChild:!0,children:e.jsxs(T,{variant:"outline","data-testid":"button-date-range",className:"min-w-[240px] justify-start",children:[e.jsx(Zs,{className:"mr-2 h-4 w-4"}),o.from&&o.to?`${_s(o.from,"PP")} - ${_s(o.to,"PP")}`:"Select date range"]})}),e.jsx(Ms,{className:"w-auto p-0",align:"end",children:e.jsx(Js,{mode:"range",selected:{from:o.from,to:o.to},onSelect:s=>J({from:s==null?void 0:s.from,to:s==null?void 0:s.to}),numberOfMonths:2})})]}),e.jsxs(Fs,{children:[e.jsx(Us,{asChild:!0,children:e.jsx(T,{variant:"outline",size:"icon","data-testid":"button-export",children:e.jsx(ke,{className:"h-4 w-4"})})}),e.jsx(Ms,{className:"w-auto p-2",align:"end",children:e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs(T,{variant:"ghost",size:"sm",onClick:()=>j("csv"),"data-testid":"button-export-csv",className:"justify-start",children:[e.jsx(qe,{className:"mr-2 h-4 w-4"}),"Export as CSV"]}),e.jsxs(T,{variant:"ghost",size:"sm",onClick:()=>j("pdf"),"data-testid":"button-export-pdf",className:"justify-start",children:[e.jsx(qe,{className:"mr-2 h-4 w-4"}),"Export as PDF"]})]})})]})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(T,{variant:o.from&&o.to&&o.from.toDateString()===as(new Date).toDateString()?"default":"outline",size:"sm",onClick:pe,"data-testid":"button-filter-today",children:[e.jsx(Te,{className:"mr-2 h-3 w-3"}),"Today"]}),e.jsx(T,{variant:"outline",size:"sm",onClick:me,"data-testid":"button-filter-7days",children:"Last 7 Days"}),e.jsx(T,{variant:"outline",size:"sm",onClick:r,"data-testid":"button-filter-30days",children:"Last 30 Days"}),(o.from||o.to)&&e.jsx(T,{variant:"ghost",size:"sm",onClick:l,"data-testid":"button-filter-clear",children:"Clear Filter"})]})]}),e.jsxs(Qs,{value:Y,onValueChange:X,className:"space-y-6",children:[e.jsxs(Gs,{className:"grid w-full grid-cols-2 lg:grid-cols-6 h-auto",children:[e.jsxs(Fe,{value:"overview","data-testid":"tab-overview",className:"flex items-center gap-2 py-2",children:[e.jsx(ns,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Overview"})]}),e.jsxs(Fe,{value:"financial","data-testid":"tab-financial",className:"flex items-center gap-2 py-2",children:[e.jsx(_e,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Financial"})]}),e.jsxs(Fe,{value:"staff","data-testid":"tab-staff",className:"flex items-center gap-2 py-2",children:[e.jsx(ds,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Staff"})]}),e.jsxs(Fe,{value:"security","data-testid":"tab-security",className:"flex items-center gap-2 py-2",children:[e.jsx(Qe,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Security"})]}),e.jsxs(Fe,{value:"photos","data-testid":"tab-photos",className:"flex items-center gap-2 py-2",children:[e.jsx(Be,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Photos"})]}),e.jsxs(Fe,{value:"location","data-testid":"tab-location",className:"flex items-center gap-2 py-2",children:[e.jsx(hs,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Location"})]})]}),e.jsxs(Ue,{value:"overview",className:"space-y-6",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsxs(f,{"data-testid":"card-total-transactions",className:"border-l-4 border-l-blue-500",children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"Transactions Today"}),e.jsx(ns,{className:"h-4 w-4 text-blue-500"})]}),e.jsx(g,{children:H?e.jsx(k,{className:"h-8 w-20"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-total-transactions",children:Le.length}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1 flex items-center gap-1",children:[e.jsx(rs,{className:"h-3 w-3 text-green-500"}),"Active today"]})]})})]}),e.jsxs(f,{"data-testid":"card-total-revenue",className:"border-l-4 border-l-green-500",children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"Revenue Today"}),e.jsx(rs,{className:"h-4 w-4 text-green-500"})]}),e.jsx(g,{children:H?e.jsx(k,{className:"h-8 w-24"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-total-revenue",children:Q(Pe)}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Cash in today"})]})})]}),e.jsxs(f,{"data-testid":"card-total-expenses",className:"border-l-4 border-l-red-500",children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"Expenses Today"}),e.jsx(Is,{className:"h-4 w-4 text-red-500"})]}),e.jsx(g,{children:H?e.jsx(k,{className:"h-8 w-24"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-total-expenses",children:Q(n)}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Cash out today"})]})})]}),e.jsxs(f,{"data-testid":"card-active-staff",className:"border-l-4 border-l-purple-500",children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"Active Staff"}),e.jsx(ds,{className:"h-4 w-4 text-purple-500"})]}),e.jsx(g,{children:H?e.jsx(k,{className:"h-8 w-16"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-active-staff",children:m}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Performed actions"})]})})]}),e.jsxs(f,{"data-testid":"card-pending-approvals",className:"border-l-4 border-l-orange-500",children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"Pending Approvals"}),e.jsx(Te,{className:"h-4 w-4 text-orange-500"})]}),e.jsx(g,{children:H?e.jsx(k,{className:"h-8 w-16"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-pending-approvals",children:V}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Awaiting review"})]})})]}),e.jsxs(f,{"data-testid":"card-security-alerts",className:"border-l-4 border-l-red-600",children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"Security Alerts"}),e.jsx(be,{className:"h-4 w-4 text-red-600"})]}),e.jsx(g,{children:H?e.jsx(k,{className:"h-8 w-16"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-security-alerts",children:ye}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Last 24 hours"})]})})]}),e.jsxs(f,{"data-testid":"card-cash-ratio",className:"border-l-4 border-l-indigo-500",children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"Cash In/Out Ratio"}),e.jsx(_e,{className:"h-4 w-4 text-indigo-500"})]}),e.jsx(g,{children:H?e.jsx(k,{className:"h-8 w-20"}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-2xl font-bold","data-testid":"text-cash-ratio",children:[es,":1"]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Today's ratio"})]})})]}),e.jsxs(f,{"data-testid":"card-wastage",className:"border-l-4 border-l-yellow-500",children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"Wastage This Week"}),e.jsx(be,{className:"h-4 w-4 text-yellow-500"})]}),e.jsx(g,{children:H?e.jsx(k,{className:"h-8 w-20"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-wastage",children:"0"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Items reported"})]})})]})]}),e.jsxs(f,{"data-testid":"card-recent-activity",children:[e.jsxs(w,{children:[e.jsxs(y,{className:"flex items-center gap-2",children:[e.jsx(Te,{className:"h-5 w-5"}),"Recent Activity Timeline"]}),e.jsx(ae,{children:"Last 10 system activities and changes"})]}),e.jsx(g,{children:H?e.jsx("div",{className:"space-y-4",children:[...Array(5)].map((s,c)=>e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx(k,{className:"h-10 w-10 rounded-full"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx(k,{className:"h-4 w-3/4"}),e.jsx(k,{className:"h-3 w-1/2"})]})]},c))}):e.jsx("div",{className:"space-y-4",children:ps.length===0?e.jsx("p",{className:"text-center text-muted-foreground py-8","data-testid":"text-no-activity",children:"No recent activities found."}):ps.map((s,c)=>e.jsxs("div",{className:"flex items-start gap-4 pb-4 border-b last:border-0","data-testid":`activity-${s.id}`,children:[e.jsx("div",{className:`rounded-full p-2 ${s.success?"bg-green-100 dark:bg-green-900":"bg-red-100 dark:bg-red-900"}`,children:s.success?e.jsx(Ce,{className:"h-5 w-5 text-green-600 dark:text-green-400"}):e.jsx(Bs,{className:"h-5 w-5 text-red-600 dark:text-red-400"})}),e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsxs("p",{className:"text-sm font-medium","data-testid":`text-activity-action-${s.id}`,children:[s.action," - ",s.resourceType]}),e.jsx("p",{className:"text-xs text-muted-foreground","data-testid":`text-activity-time-${s.id}`,children:new Date(s.createdAt).toLocaleString()})]}),e.jsx(b,{variant:s.success?"default":"destructive","data-testid":`badge-activity-status-${s.id}`,children:s.success?"Success":"Failed"})]},s.id))})})]})]}),e.jsxs(Ue,{value:"financial",className:"space-y-6",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-5",children:[e.jsxs(f,{"data-testid":"card-financial-revenue",className:"border-l-4 border-l-green-500",children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"Total Revenue"}),e.jsx(rs,{className:"h-4 w-4 text-green-500"})]}),e.jsx(g,{children:H?e.jsx(k,{className:"h-8 w-24"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-financial-revenue",children:Q(js)}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"All income transactions"})]})})]}),e.jsxs(f,{"data-testid":"card-financial-expenses",className:"border-l-4 border-l-red-500",children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"Total Expenses"}),e.jsx(Is,{className:"h-4 w-4 text-red-500"})]}),e.jsx(g,{children:H?e.jsx(k,{className:"h-8 w-24"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-financial-expenses",children:Q(fs)}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"All outgoing transactions"})]})})]}),e.jsxs(f,{"data-testid":"card-net-profit",className:`border-l-4 ${Me>=0?"border-l-green-600":"border-l-red-600"}`,children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"Net Profit/Loss"}),e.jsx(_e,{className:`h-4 w-4 ${Me>=0?"text-green-600":"text-red-600"}`})]}),e.jsx(g,{children:H?e.jsx(k,{className:"h-8 w-24"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`text-2xl font-bold ${Me>=0?"text-green-600":"text-red-600"}`,"data-testid":"text-net-profit",children:Q(Math.abs(Me))}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:Me>=0?"Profit":"Loss"})]})})]}),e.jsxs(f,{"data-testid":"card-largest-transaction",className:"border-l-4 border-l-purple-500",children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"Largest Transaction"}),e.jsx(Oe,{className:"h-4 w-4 text-purple-500"})]}),e.jsx(g,{children:H?e.jsx(k,{className:"h-8 w-24"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-largest-transaction",children:Ie?Q(parseFloat(Ie.amount||0)):"N/A"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1 truncate",children:(Ie==null?void 0:Ie.purpose)||"No transactions"})]})})]}),e.jsxs(f,{"data-testid":"card-voided-transactions",className:"border-l-4 border-l-orange-500",children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"Voided Transactions"}),e.jsx(Ge,{className:"h-4 w-4 text-orange-500"})]}),e.jsx(g,{children:H?e.jsx(k,{className:"h-8 w-16"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-voided-count",children:Os}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Cancelled transactions"})]})})]})]}),e.jsxs(f,{"data-testid":"card-payment-breakdown",children:[e.jsxs(w,{children:[e.jsxs(y,{className:"flex items-center gap-2",children:[e.jsx(_e,{className:"h-5 w-5"}),"Payment Method Breakdown"]}),e.jsx(ae,{children:"Distribution of transactions by payment method"})]}),e.jsx(g,{children:H?e.jsx("div",{className:"space-y-3",children:[...Array(4)].map((s,c)=>e.jsx(k,{className:"h-12 w-full"},c))}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"font-medium",children:"Cash"}),e.jsx("span",{"data-testid":"text-cash-amount",children:Q(je.cash)})]}),e.jsx("div",{className:"h-3 bg-muted rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-green-500 transition-all",style:{width:`${Ae>0?je.cash/Ae*100:0}%`}})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"font-medium",children:"POS"}),e.jsx("span",{"data-testid":"text-pos-amount",children:Q(je.pos)})]}),e.jsx("div",{className:"h-3 bg-muted rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-blue-500 transition-all",style:{width:`${Ae>0?je.pos/Ae*100:0}%`}})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"font-medium",children:"Fonepay"}),e.jsx("span",{"data-testid":"text-fonepay-amount",children:Q(je.fonepay)})]}),e.jsx("div",{className:"h-3 bg-muted rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-purple-500 transition-all",style:{width:`${Ae>0?je.fonepay/Ae*100:0}%`}})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"font-medium",children:"Other"}),e.jsx("span",{"data-testid":"text-other-amount",children:Q(je.other)})]}),e.jsx("div",{className:"h-3 bg-muted rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-gray-500 transition-all",style:{width:`${Ae>0?je.other/Ae*100:0}%`}})})]})]})})]}),e.jsxs(f,{"data-testid":"card-transactions-table",children:[e.jsxs(w,{children:[e.jsxs(y,{className:"flex items-center gap-2",children:[e.jsx(qe,{className:"h-5 w-5"}),"Detailed Transaction Records"]}),e.jsx(ae,{children:"Complete audit trail with filtering and sorting capabilities"})]}),e.jsxs(g,{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsx(is,{placeholder:"Search purpose, reference, staff...",value:te,onChange:s=>F(s.target.value),"data-testid":"input-search",className:"md:col-span-1"}),e.jsxs(re,{value:O,onValueChange:de,children:[e.jsx(ie,{"data-testid":"select-txn-type",children:e.jsx(le,{placeholder:"Transaction Type"})}),e.jsxs(ne,{children:[e.jsx(D,{value:"all",children:"All Types"}),Rs.map(s=>e.jsx(D,{value:s,children:s.replace(/_/g," ")},s))]})]}),e.jsxs(re,{value:N,onValueChange:xe,children:[e.jsx(ie,{"data-testid":"select-payment-method",children:e.jsx(le,{placeholder:"Payment Method"})}),e.jsxs(ne,{children:[e.jsx(D,{value:"all",children:"All Methods"}),Es.map(s=>e.jsx(D,{value:s,children:s},s))]})]}),e.jsxs(re,{value:ce,onValueChange:K,children:[e.jsx(ie,{"data-testid":"select-staff",children:e.jsx(le,{placeholder:"Staff Member"})}),e.jsxs(ne,{children:[e.jsx(D,{value:"all",children:"All Staff"}),Vs.map(s=>e.jsx(D,{value:s.id,children:s.username},s.id))]})]})]}),e.jsx("div",{className:"rounded-md border",children:e.jsxs(ze,{children:[e.jsx(We,{children:e.jsxs(G,{children:[e.jsx(A,{className:"cursor-pointer",onClick:()=>os("createdAt"),"data-testid":"th-date",children:e.jsxs("div",{className:"flex items-center gap-1",children:["Date/Time",e.jsx(Se,{className:"h-3 w-3"})]})}),e.jsx(A,{className:"cursor-pointer",onClick:()=>os("txnType"),"data-testid":"th-type",children:e.jsxs("div",{className:"flex items-center gap-1",children:["Type",e.jsx(Se,{className:"h-3 w-3"})]})}),e.jsx(A,{className:"cursor-pointer",onClick:()=>os("amount"),"data-testid":"th-amount",children:e.jsxs("div",{className:"flex items-center gap-1",children:["Amount",e.jsx(Se,{className:"h-3 w-3"})]})}),e.jsx(A,{"data-testid":"th-payment",children:"Payment Method"}),e.jsx(A,{"data-testid":"th-purpose",children:"Purpose"}),e.jsx(A,{"data-testid":"th-created-by",children:"Created By"}),e.jsx(A,{"data-testid":"th-bill",children:"Bill Proof"}),e.jsx(A,{"data-testid":"th-status",children:"Status"}),e.jsx(A,{"data-testid":"th-actions",children:"Actions"})]})}),e.jsx(He,{children:H?[...Array(5)].map((s,c)=>e.jsx(G,{children:[...Array(9)].map((I,B)=>e.jsx(v,{children:e.jsx(k,{className:"h-4 w-full"})},B))},c)):gs.length===0?e.jsx(G,{children:e.jsx(v,{colSpan:9,className:"text-center py-8 text-muted-foreground","data-testid":"text-no-table-data",children:"No transactions found matching the filters."})}):gs.map(s=>{var c,I;return e.jsxs(G,{className:"cursor-pointer",onClick:()=>$e(s),"data-testid":`table-row-${s.id}`,children:[e.jsx(v,{className:"text-xs","data-testid":`td-date-${s.id}`,children:new Date(s.createdAt).toLocaleString()}),e.jsx(v,{"data-testid":`td-type-${s.id}`,children:e.jsx(b,{variant:"outline",className:"text-xs",children:(c=s.txnType)==null?void 0:c.replace(/_/g," ")})}),e.jsx(v,{className:"font-medium","data-testid":`td-amount-${s.id}`,children:Q(parseFloat(s.amount||0))}),e.jsx(v,{className:"text-xs","data-testid":`td-payment-${s.id}`,children:s.paymentMethod||"N/A"}),e.jsx(v,{className:"text-xs max-w-[200px] truncate","data-testid":`td-purpose-${s.id}`,children:s.purpose||"-"}),e.jsx(v,{className:"text-xs","data-testid":`td-creator-${s.id}`,children:((I=s.creator)==null?void 0:I.username)||"Unknown"}),e.jsx(v,{"data-testid":`td-bill-${s.id}`,children:s.billPhotoUrl||s.billPdfUrl?e.jsx(T,{variant:"ghost",size:"sm",onClick:B=>{B.stopPropagation(),Ns(s.billPhotoUrl||s.billPdfUrl)},"data-testid":`button-view-bill-${s.id}`,children:e.jsx(xs,{className:"h-4 w-4 text-blue-500"})}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"-"})}),e.jsx(v,{"data-testid":`td-status-${s.id}`,children:s.isVoided?e.jsx(b,{variant:"destructive",className:"text-xs",children:"Voided"}):s.requiresApproval&&!s.approvedBy?e.jsx(b,{variant:"outline",className:"text-xs",children:"Pending"}):s.approvedBy?e.jsx(b,{variant:"default",className:"text-xs",children:"Approved"}):e.jsx(b,{variant:"secondary",className:"text-xs",children:"Active"})}),e.jsx(v,{children:e.jsx(T,{variant:"ghost",size:"sm",onClick:B=>{B.stopPropagation(),$e(s)},"data-testid":`button-view-details-${s.id}`,children:e.jsx(us,{className:"h-4 w-4"})})})]},s.id)})})]})}),ts>1&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-sm text-muted-foreground","data-testid":"text-pagination-info",children:["Showing ",(E-1)*U+1," to ",Math.min(E*U,ss.length)," of ",ss.length," transactions"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(T,{variant:"outline",size:"sm",onClick:()=>z(s=>Math.max(1,s-1)),disabled:E===1,"data-testid":"button-prev-page",children:[e.jsx(Ys,{className:"h-4 w-4"}),"Previous"]}),e.jsxs("span",{className:"text-sm","data-testid":"text-current-page",children:["Page ",E," of ",ts]}),e.jsxs(T,{variant:"outline",size:"sm",onClick:()=>z(s=>Math.min(ts,s+1)),disabled:E===ts,"data-testid":"button-next-page",children:["Next",e.jsx(et,{className:"h-4 w-4"})]})]})]})]})]}),e.jsxs(f,{"data-testid":"card-flagged-transactions",children:[e.jsxs(w,{children:[e.jsxs(y,{className:"flex items-center gap-2",children:[e.jsx(be,{className:"h-5 w-5 text-orange-500"}),"Flagged Transactions"]}),e.jsx(ae,{children:"Transactions requiring attention or review"})]}),e.jsx(g,{children:H?e.jsx("div",{className:"space-y-4",children:[...Array(3)].map((s,c)=>e.jsx(k,{className:"h-20 w-full"},c))}):e.jsxs("div",{className:"space-y-4",children:[se.large.length>0&&e.jsxs("div",{className:"p-4 border border-yellow-200 dark:border-yellow-800 rounded-lg bg-yellow-50 dark:bg-yellow-900/10","data-testid":"section-large-transactions",children:[e.jsxs("h4",{className:"font-semibold text-sm mb-2 flex items-center gap-2",children:[e.jsx(Oe,{className:"h-4 w-4"}),"Large Transactions (≥ NPR 50,000)",e.jsx(b,{variant:"outline",children:se.large.length})]}),e.jsx("div",{className:"space-y-2",children:se.large.slice(0,3).map(s=>e.jsxs("div",{className:"flex items-center justify-between text-sm hover:bg-yellow-100 dark:hover:bg-yellow-900/20 p-2 rounded cursor-pointer",onClick:()=>$e(s),"data-testid":`flagged-large-${s.id}`,children:[e.jsx("span",{className:"truncate flex-1",children:s.purpose||"Large Transaction"}),e.jsx("span",{className:"font-medium ml-4",children:Q(parseFloat(s.amount||0))})]},s.id))})]}),se.noBillProof.length>0&&e.jsxs("div",{className:"p-4 border border-red-200 dark:border-red-800 rounded-lg bg-red-50 dark:bg-red-900/10","data-testid":"section-no-bill",children:[e.jsxs("h4",{className:"font-semibold text-sm mb-2 flex items-center gap-2",children:[e.jsx(qs,{className:"h-4 w-4"}),"Cash Out Without Bill Proof",e.jsx(b,{variant:"outline",children:se.noBillProof.length})]}),e.jsx("div",{className:"space-y-2",children:se.noBillProof.slice(0,3).map(s=>e.jsxs("div",{className:"flex items-center justify-between text-sm hover:bg-red-100 dark:hover:bg-red-900/20 p-2 rounded cursor-pointer",onClick:()=>$e(s),"data-testid":`flagged-no-bill-${s.id}`,children:[e.jsx("span",{className:"truncate flex-1",children:s.purpose||"No Bill Proof"}),e.jsx("span",{className:"font-medium ml-4",children:Q(parseFloat(s.amount||0))})]},s.id))})]}),se.voided.length>0&&e.jsxs("div",{className:"p-4 border border-orange-200 dark:border-orange-800 rounded-lg bg-orange-50 dark:bg-orange-900/10","data-testid":"section-voided",children:[e.jsxs("h4",{className:"font-semibold text-sm mb-2 flex items-center gap-2",children:[e.jsx(Ge,{className:"h-4 w-4"}),"Voided Transactions",e.jsx(b,{variant:"outline",children:se.voided.length})]}),e.jsx("div",{className:"space-y-2",children:se.voided.slice(0,3).map(s=>e.jsxs("div",{className:"flex items-center justify-between text-sm hover:bg-orange-100 dark:hover:bg-orange-900/20 p-2 rounded cursor-pointer",onClick:()=>$e(s),"data-testid":`flagged-voided-${s.id}`,children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"truncate",children:s.purpose||"Voided Transaction"}),s.voidReason&&e.jsxs("p",{className:"text-xs text-muted-foreground truncate",children:["Reason: ",s.voidReason]})]}),e.jsx("span",{className:"font-medium ml-4",children:Q(parseFloat(s.amount||0))})]},s.id))})]}),se.requiresApproval.length>0&&e.jsxs("div",{className:"p-4 border border-blue-200 dark:border-blue-800 rounded-lg bg-blue-50 dark:bg-blue-900/10","data-testid":"section-requires-approval",children:[e.jsxs("h4",{className:"font-semibold text-sm mb-2 flex items-center gap-2",children:[e.jsx(Te,{className:"h-4 w-4"}),"Requires Approval",e.jsx(b,{variant:"outline",children:se.requiresApproval.length})]}),e.jsx("div",{className:"space-y-2",children:se.requiresApproval.slice(0,3).map(s=>e.jsxs("div",{className:"flex items-center justify-between text-sm hover:bg-blue-100 dark:hover:bg-blue-900/20 p-2 rounded cursor-pointer",onClick:()=>$e(s),"data-testid":`flagged-approval-${s.id}`,children:[e.jsx("span",{className:"truncate flex-1",children:s.purpose||"Pending Approval"}),e.jsx("span",{className:"font-medium ml-4",children:Q(parseFloat(s.amount||0))})]},s.id))})]}),se.large.length===0&&se.noBillProof.length===0&&se.voided.length===0&&se.requiresApproval.length===0&&e.jsxs("div",{className:"text-center py-8","data-testid":"text-no-flagged",children:[e.jsx(Ce,{className:"h-12 w-12 text-green-500 mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"No flagged transactions. All transactions are in good standing."})]})]})})]})]}),e.jsx(Ue,{value:"staff",className:"space-y-6",children:e.jsx(tt,{dateRange:o})}),e.jsx(Ue,{value:"security",className:"space-y-6",children:e.jsx(at,{dateRange:o})}),e.jsx(Ue,{value:"photos",className:"space-y-6",children:e.jsx(rt,{dateRange:o,transactions:t,maintenanceRequests:i,isLoading:H})}),e.jsx(Ue,{value:"location",className:"space-y-6",children:e.jsx(it,{dateRange:o})})]}),e.jsx(Re,{open:Ne,onOpenChange:he,children:e.jsxs(Ee,{className:"max-w-2xl","data-testid":"modal-transaction-details",children:[e.jsxs(Ve,{children:[e.jsx(Ke,{children:"Transaction Details"}),e.jsx(ls,{children:"Complete information about this transaction"})]}),L&&e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Transaction ID"}),e.jsx("p",{className:"text-sm","data-testid":"modal-txn-id",children:L.id})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Date & Time"}),e.jsx("p",{className:"text-sm","data-testid":"modal-txn-date",children:new Date(L.createdAt).toLocaleString()})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Type"}),e.jsx(b,{"data-testid":"modal-txn-type",children:(Ts=L.txnType)==null?void 0:Ts.replace(/_/g," ")})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Amount"}),e.jsx("p",{className:"text-lg font-bold","data-testid":"modal-txn-amount",children:Q(parseFloat(L.amount||0))})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Payment Method"}),e.jsx("p",{className:"text-sm","data-testid":"modal-txn-payment",children:L.paymentMethod||"N/A"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Created By"}),e.jsx("p",{className:"text-sm","data-testid":"modal-txn-creator",children:((Cs=L.creator)==null?void 0:Cs.username)||"Unknown"})]}),L.reference&&e.jsxs("div",{className:"col-span-2",children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Reference"}),e.jsx("p",{className:"text-sm","data-testid":"modal-txn-reference",children:L.reference})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Purpose"}),e.jsx("p",{className:"text-sm","data-testid":"modal-txn-purpose",children:L.purpose||"-"})]}),L.isVoided&&e.jsxs("div",{className:"col-span-2",children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Void Reason"}),e.jsx("p",{className:"text-sm text-red-600","data-testid":"modal-txn-void-reason",children:L.voidReason||"No reason provided"})]}),(L.billPhotoUrl||L.billPdfUrl)&&e.jsxs("div",{className:"col-span-2",children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground mb-2",children:"Bill Proof"}),e.jsxs(T,{variant:"outline",onClick:()=>Ns(L.billPhotoUrl||L.billPdfUrl),"data-testid":"modal-button-view-bill",children:[e.jsx(xs,{className:"mr-2 h-4 w-4"}),"View Bill"]})]})]})})]})}),e.jsx(Re,{open:$,onOpenChange:ue,children:e.jsxs(Ee,{className:"max-w-4xl","data-testid":"modal-bill-view",children:[e.jsxs(Ve,{children:[e.jsx(Ke,{children:"Bill Proof"}),e.jsx(ls,{children:"Transaction bill documentation"})]}),e.jsx("div",{className:"max-h-[600px] overflow-auto",children:oe&&(oe.endsWith(".pdf")?e.jsx("iframe",{src:oe,className:"w-full h-[600px]",title:"Bill PDF","data-testid":"iframe-bill-pdf"}):e.jsx("img",{src:oe,alt:"Bill Proof",className:"w-full h-auto","data-testid":"img-bill-photo"}))})]})})]})}export{yt as default};
